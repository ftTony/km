(window.webpackJsonp=window.webpackJsonp||[]).push([[205],{428:function(s,n,e){"use strict";e.r(n);var a=e(13),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"vue-源码分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#vue-源码分析"}},[s._v("#")]),s._v(" vue 源码分析")]),s._v(" "),e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),e("p",[s._v("本人平时学习及收集内容，欢迎参入一起讨论。")]),s._v(" "),e("h2",{attrs:{id:"内容"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#内容"}},[s._v("#")]),s._v(" 内容")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"#%E4%B8%80%E3%80%81%E6%BA%90%E7%A0%81%E7%9B%AE%E5%BD%95%E8%AE%BE%E8%AE%A1"}},[s._v("源码目录设计")])]),s._v(" "),e("li",[e("a",{attrs:{href:"#%E4%BA%8C%E3%80%81%E5%8F%98%E5%8C%96%E4%BE%A6%E6%B5%8B%E7%AF%87"}},[s._v("变化侦测篇")])]),s._v(" "),e("li",[e("a",{attrs:{href:"#%E4%B8%89%E3%80%81%E8%99%9A%E6%8B%9F-dom-%E7%AF%87"}},[s._v("虚拟 DOM 篇")])]),s._v(" "),e("li",[e("a",{attrs:{href:"#%E5%9B%9B%E3%80%81%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E7%AF%87"}},[s._v("模板编译篇")])]),s._v(" "),e("li",[e("a",{attrs:{href:"#%E4%BA%94%E3%80%81%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AF%87"}},[s._v("生命周期篇")])]),s._v(" "),e("li",[e("a",{attrs:{href:"#%E5%85%AD%E3%80%81%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95"}},[s._v("实例方法")])]),s._v(" "),e("li",[e("a",{attrs:{href:"#%E4%B8%83%E3%80%81%E5%85%A8%E5%B1%80-api-%E7%AF%87"}},[s._v("全局 API 篇")])]),s._v(" "),e("li",[e("a",{attrs:{href:"#%E5%85%AB%E3%80%81%E8%BF%87%E6%BB%A4%E5%99%A8%E7%AF%87"}},[s._v("过滤器篇")])]),s._v(" "),e("li",[e("a",{attrs:{href:"#%E4%B9%9D%E3%80%81%E6%8C%87%E4%BB%A4%E7%AF%87"}},[s._v("指令篇")])])]),s._v(" "),e("h3",{attrs:{id:"一、源码目录设计"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、源码目录设计"}},[s._v("#")]),s._v(" 一、源码目录设计")]),s._v(" "),e("p",[s._v("Vue.js 的源码都在 src 目录下，其目录结构如下。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("├─dist                   # 项目构建后的文件\n├─scripts                # 与项目构建相关的脚本和配置文件\n├─flow                   # flow的类型声明文件\n├─src                    # 项目源代码\n│    ├─complier          # 与模板编译相关的代码\n│    ├─core              # 通用的、与运行平台无关的运行时代码\n│    │  ├─observe        # 实现变化侦测的代码\n│    │  ├─vdom           # 实现virtual dom的代码\n│    │  ├─instance       # Vue.js实例的构造函数和原型方法\n│    │  ├─global-api     # 全局api的代码\n│    │  └─components     # 内置组件的代码\n│    ├─server            # 与服务端渲染相关的代码\n│    ├─platforms         # 特定运行平台的代码，如weex\n│    ├─sfc               # 单文件组件的解析代码\n│    └─shared            # 项目公用的工具代码\n└─test                   # 项目测试代码\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("ul",[e("li",[s._v("compiler")]),s._v(" "),e("li",[s._v("core")]),s._v(" "),e("li",[s._v("platform")]),s._v(" "),e("li",[s._v("server")]),s._v(" "),e("li",[s._v("sfc")]),s._v(" "),e("li",[s._v("shared")])]),s._v(" "),e("h4",{attrs:{id:"_1-1-compiler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-compiler"}},[s._v("#")]),s._v(" 1.1 compiler")]),s._v(" "),e("p",[e("code",[s._v("compiler")]),s._v("目录包含"),e("code",[s._v("Vue.js")]),s._v("所有编译相关的代码。它包括把模板解析成 ast 语法树、ast 语法树优化，代码生成等功能。")]),s._v(" "),e("p",[s._v("编译的工作可以在构建时做（借助"),e("code",[s._v("webpack")]),s._v("、"),e("code",[s._v("vue-loader")]),s._v("等辅助插件）；也可以在运行时做，使用包含构建功能的"),e("code",[s._v("vue.js")]),s._v("。显然，编译是一项耗性能的工作，所以更推荐前者——离线编译。")]),s._v(" "),e("h4",{attrs:{id:"_1-2-core"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-core"}},[s._v("#")]),s._v(" 1.2 core")]),s._v(" "),e("p",[e("code",[s._v("core")]),s._v("目录包含了"),e("code",[s._v("Vue.js")]),s._v("的核心代码，包括内置组件、全局 API 封装，Vue 实例化、观察者、虚拟 DOM、工具函数等等。")]),s._v(" "),e("p",[s._v("这里的代码可谓是 Vue.js 的灵魂，也是我们之后需要重点分析的地方")]),s._v(" "),e("h4",{attrs:{id:"_1-3-platform"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-platform"}},[s._v("#")]),s._v(" 1.3 platform")]),s._v(" "),e("p",[e("code",[s._v("Vue.js")]),s._v("是一个跨平台的"),e("code",[s._v("MVVM")]),s._v("框架，它可以跑在"),e("code",[s._v("web")]),s._v("上，也可以配合"),e("code",[s._v("weex")]),s._v("跑在"),e("code",[s._v("native")]),s._v("客户端上。"),e("code",[s._v("platform")]),s._v("是 "),e("code",[s._v("Vue.js")]),s._v("的入口，2 个目录代表 2 个主要入口，分别打包成运行在"),e("code",[s._v("web")]),s._v("上和"),e("code",[s._v("weex")]),s._v("上的"),e("code",[s._v("Vue.js")]),s._v("。")]),s._v(" "),e("p",[s._v("我们会重点分析"),e("code",[s._v("web")]),s._v("入口打包后的"),e("code",[s._v("Vue.js")]),s._v("，对于"),e("code",[s._v("weex")]),s._v("入口打包的"),e("code",[s._v("Vue.js")]),s._v("，感兴趣的同学可以自行研究。")]),s._v(" "),e("h4",{attrs:{id:"_1-4-server"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-server"}},[s._v("#")]),s._v(" 1.4 server")]),s._v(" "),e("p",[e("code",[s._v("Vue.js 2.0")]),s._v("支持了服务端渲染，所有服务端渲染相关的逻辑都在这个目录下。注意：这部分代码是跑在服务端的"),e("code",[s._v("Node.js")]),s._v("，不要和跑在浏览器端的"),e("code",[s._v("Vue.js")]),s._v("混为一谈。")]),s._v(" "),e("p",[s._v("服务端渲染主要的工作是把组件渲染为服务器端的"),e("code",[s._v("HTML")]),s._v('字符串，将它们直接发送到浏览器，最后将静态标记"混合"为客户端上完全交互的应用程序。')]),s._v(" "),e("h4",{attrs:{id:"_1-5-sfc"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-sfc"}},[s._v("#")]),s._v(" 1.5 sfc")]),s._v(" "),e("p",[s._v("通常我们开发"),e("code",[s._v("Vue.js")]),s._v("都会借助"),e("code",[s._v("webpack")]),s._v("构建， 然后通过"),e("code",[s._v(".vue")]),s._v("单文件来编写组件。")]),s._v(" "),e("p",[s._v("这个目录下的代码逻辑会把"),e("code",[s._v(".vue")]),s._v("文件内容解析成一个"),e("code",[s._v("JavaScript")]),s._v("的对象。")]),s._v(" "),e("h4",{attrs:{id:"_1-6-shared"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-shared"}},[s._v("#")]),s._v(" 1.6 shared")]),s._v(" "),e("p",[e("code",[s._v("Vue.js")]),s._v("会定义一些工具方法，这里定义的工具方法都是会被浏览器端的"),e("code",[s._v("Vue.js")]),s._v("和服务端的"),e("code",[s._v("Vue.js")]),s._v("所共享的。")]),s._v(" "),e("h3",{attrs:{id:"二、变化侦测篇"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、变化侦测篇"}},[s._v("#")]),s._v(" 二、变化侦测篇")]),s._v(" "),e("ul",[e("li",[s._v("Object 的变化侦测")]),s._v(" "),e("li",[s._v("Array 的变化侦测")]),s._v(" "),e("li",[s._v("变化侦测的 API 实现")])]),s._v(" "),e("h4",{attrs:{id:"_2-1-object-的变化侦测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-object-的变化侦测"}},[s._v("#")]),s._v(" 2.1 Object 的变化侦测")]),s._v(" "),e("p",[e("strong",[s._v("使用 Object 数据变得“可观测”")])]),s._v(" "),e("p",[s._v("数据的每次读和写能够被我们看的见，即我们能够知道数据什么时候被读取了或数据什么时候被改写了，我们将其称为数据变的“可观测”。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 源码位置：src/core/observer/index.js\n\n/**\n *  Observer类会通过递归的方式把一个对象的所有属性都转化成可观测对象\n */\nexport class Observer {\n  constructor (value: any) {\n    this.value = value\n    this.dep = new Dep()\n    this.vmCount = 0\n    // 给value新增一个__ob__属性，值为该value的Observer实例\n    //\n    def(value, '__ob__', this)\n    if (Array.isArray(value)) {\n      if (hasProto) {\n        protoAugment(value, arrayMethods)\n      } else {\n        copyAugment(value, arrayMethods, arrayKeys)\n      }\n      this.observeArray(value)\n    } else {\n      this.walk(value)\n    }\n  }\n\n  /**\n   * Walk through all properties and convert them into\n   * getter/setters. This method should only be called when\n   * value type is Object.\n   */\n  walk (obj: Object) {\n    const keys = Object.keys(obj)\n    for (let i = 0; i < keys.length; i++) {\n      defineReactive(obj, keys[i])\n    }\n  }\n}\n\n\n/**\n * 使一个对象转化成可观测对象\n * @param { Object } obj 对象\n * @param { String } key 对象的key\n * @param { Any } val 对象的某个key的值\n */\nexport function defineReactive (\n  obj: Object,\n  key: string,\n  val: any,\n  customSetter?: ?Function,\n  shallow?: boolean\n) {\n  const dep = new Dep()\n\n  const property = Object.getOwnPropertyDescriptor(obj, key)\n  if (property && property.configurable === false) {\n    return\n  }\n\n  // cater for pre-defined getter/setters\n  const getter = property && property.get\n  const setter = property && property.set\n  if ((!getter || setter) && arguments.length === 2) {\n    val = obj[key]\n  }\n\n    // 递归调用，判断属性值是否是对象\n  let childOb = !shallow && observe(val)\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: true,\n    get: function reactiveGetter () {\n      const value = getter ? getter.call(obj) : val\n      if (Dep.target) {\n        dep.depend()\n        if (childOb) {\n          childOb.dep.depend()\n          if (Array.isArray(value)) {\n            dependArray(value)\n          }\n        }\n      }\n      return value\n    },\n    set: function reactiveSetter (newVal) {\n      const value = getter ? getter.call(obj) : val\n      /* eslint-disable no-self-compare */\n      if (newVal === value || (newVal !== newVal && value !== value)) {\n        return\n      }\n      /* eslint-enable no-self-compare */\n      if (process.env.NODE_ENV !== 'production' && customSetter) {\n        customSetter()\n      }\n      // #7981: for accessor properties without setter\n      if (getter && !setter) return\n      if (setter) {\n        setter.call(obj, newVal)\n      } else {\n        val = newVal\n      }\n      childOb = !shallow && observe(newVal)\n      dep.notify()\n    }\n  })\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br"),e("span",{staticClass:"line-number"},[s._v("91")]),e("br"),e("span",{staticClass:"line-number"},[s._v("92")]),e("br"),e("span",{staticClass:"line-number"},[s._v("93")]),e("br"),e("span",{staticClass:"line-number"},[s._v("94")]),e("br"),e("span",{staticClass:"line-number"},[s._v("95")]),e("br"),e("span",{staticClass:"line-number"},[s._v("96")]),e("br"),e("span",{staticClass:"line-number"},[s._v("97")]),e("br"),e("span",{staticClass:"line-number"},[s._v("98")]),e("br"),e("span",{staticClass:"line-number"},[s._v("99")]),e("br"),e("span",{staticClass:"line-number"},[s._v("100")]),e("br"),e("span",{staticClass:"line-number"},[s._v("101")]),e("br"),e("span",{staticClass:"line-number"},[s._v("102")]),e("br"),e("span",{staticClass:"line-number"},[s._v("103")]),e("br"),e("span",{staticClass:"line-number"},[s._v("104")]),e("br"),e("span",{staticClass:"line-number"},[s._v("105")]),e("br"),e("span",{staticClass:"line-number"},[s._v("106")]),e("br"),e("span",{staticClass:"line-number"},[s._v("107")]),e("br")])]),e("p",[e("strong",[s._v("什么是依赖收集")])]),s._v(" "),e("p",[s._v("视图里谁用到了这个数据就更新谁，我们换个优雅说法：我们把“谁用到了这个数据”称为“谁依赖了这个数据”，我们给每个数据都建一个依赖数组，谁依赖了这个数据我们就把谁放入这个依赖数组中，那么当这个数据发生变化的时候，我们就去它对应的依赖数据中，把每个依赖都通知一遍，告诉他们：“你们依赖的数据变啦，你们该更新啦！”。这个过程就是依赖收集。")]),s._v(" "),e("p",[e("strong",[s._v("何时收集依赖？何时通知依赖更新？")])]),s._v(" "),e("p",[s._v("在 getter 中收集依赖，在 setter 中通知依赖更新。")]),s._v(" "),e("p",[e("strong",[s._v("把依赖收集到哪里")])]),s._v(" "),e("p",[s._v("我们给每个数据都建一个依赖数组，谁依赖了这个数据我们就把谁放入这个依赖数组中。单单用一个数组来存放依赖的")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("export default class Dep {\n  static target: ?Watcher;\n  id: number;\n  subs: Array<Watcher>;\n\n  constructor () {\n    this.id = uid++\n    this.subs = []\n  }\n\n  addSub (sub: Watcher) {\n    this.subs.push(sub)\n  }\n\n  removeSub (sub: Watcher) {\n    remove(this.subs, sub)\n  }\n\n    // 订阅\n  depend () {\n    if (Dep.target) {\n      Dep.target.addDep(this)\n    }\n  }\n    // 通知更新\n  notify () {\n    // 转化成数组\n    const subs = this.subs.slice()\n    if (process.env.NODE_ENV !== 'production' && !config.async) {\n      subs.sort((a, b) => a.id - b.id)\n    }\n    for (let i = 0, l = subs.length; i < l; i++) {\n      subs[i].update()\n    }\n  }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br")])]),e("p",[s._v("有了依赖管理器后，我们就可以在 getter 中收集依赖，在 setter 中通知依赖更新了，代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("function defineReactive (obj,key,val){\n  const dep = new Dep()\n\n  const property = Object.getOwnPropertyDescriptor(obj, key)\n  if (property && property.configurable === false) {\n    return\n  }\n\n  // cater for pre-defined getter/setters\n  const getter = property && property.get\n  const setter = property && property.set\n  if ((!getter || setter) && arguments.length === 2) {\n    val = obj[key]\n  }\n\n  let childOb = !shallow && observe(val)\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: true,\n    get: function reactiveGetter () {\n      const value = getter ? getter.call(obj) : val\n      if (Dep.target) {\n        dep.depend()\n        if (childOb) {\n          childOb.dep.depend()\n          if (Array.isArray(value)) {\n            dependArray(value)\n          }\n        }\n      }\n      return value\n    },\n    set: function reactiveSetter (newVal) {\n      const value = getter ? getter.call(obj) : val\n      /* eslint-disable no-self-compare */\n      if (newVal === value || (newVal !== newVal && value !== value)) {\n        return\n      }\n      /* eslint-enable no-self-compare */\n      if (process.env.NODE_ENV !== 'production' && customSetter) {\n        customSetter()\n      }\n      // #7981: for accessor properties without setter\n      if (getter && !setter) return\n      if (setter) {\n        setter.call(obj, newVal)\n      } else {\n        val = newVal\n      }\n      childOb = !shallow && observe(newVal)\n      dep.notify()\n    }\n  })\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br")])]),e("p",[s._v("在上述代码中，我们在"),e("code",[s._v("getter")]),s._v("中调用了"),e("code",[s._v("dep.depend()")]),s._v("方法收集依赖，在"),e("code",[s._v("setter")]),s._v("中调用"),e("code",[s._v("dep.notify()")]),s._v("方法通知所有依赖更新。")]),s._v(" "),e("p",[e("strong",[s._v("依赖到底是谁")])]),s._v(" "),e("p",[s._v("上面我们明白了什么是依赖？何时收集依赖？以及收集的依赖存放到何处？那么我们收集的依赖到底是谁？")]),s._v(" "),e("p",[s._v("其实在"),e("code",[s._v("Vue")]),s._v("中还实现了一个叫做"),e("code",[s._v("Watcher")]),s._v("的类，而"),e("code",[s._v("Watcher")]),s._v("类的实例就是我们上面所说的那个“谁”。换句话说就是：谁用了数据，谁就是依赖，我们就为谁创建一个"),e("code",[s._v("Watcher")]),s._v("实例。在之后数据变化时，我们不直接去通知依赖更新，而通知依赖对应的"),e("code",[s._v("Watch")]),s._v("实例，由"),e("code",[s._v("Watcher")]),s._v("实例去通知真正的视图。")]),s._v(" "),e("p",[e("code",[s._v("Watcher")]),s._v("类的具体实现如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("export default class Watcher {\n  constructor (vm,expOrFn,cb) {\n    this.vm = vm;\n    this.cb = cb;\n    this.getter = parsePath(expOrFn)\n    this.value = this.get()\n  }\n  get () {\n    window.target = this;\n    const vm = this.vm\n    let value = this.getter.call(vm, vm)\n    window.target = undefined;\n    return value\n  }\n  update () {\n    const oldValue = this.value\n    this.value = this.get()\n    this.cb.call(this.vm, this.value, oldValue)\n  }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("p",[e("code",[s._v("Watcher")]),s._v("类的代码实现逻辑：")]),s._v(" "),e("ol",[e("li",[s._v("当实例化"),e("code",[s._v("Watcher")]),s._v("类时，会先执行其构造函数；")]),s._v(" "),e("li",[s._v("在构造函数中调用了"),e("code",[s._v("this.get()")]),s._v("实例方法；")]),s._v(" "),e("li",[s._v("在"),e("code",[s._v("get()")]),s._v("方法中，首先通过"),e("code",[s._v("window.target = this")]),s._v("把实例自身赋给了全局的一个唯一对象"),e("code",[s._v("window.target")]),s._v("上，然后通过"),e("code",[s._v("let value = this.getter.call(vm,vm)")]),s._v("获取一下被依赖的数据，获取被依赖数据的目的是触发该数据上面的"),e("code",[s._v("getter")]),s._v("，上文我们说过，在"),e("code",[s._v("getter")]),s._v("里会调用"),e("code",[s._v("dep.depend()")]),s._v("收集依赖，而在"),e("code",[s._v("dep.depend()")]),s._v("中取到挂载"),e("code",[s._v("window.target")]),s._v("上的值并将其存入依赖数组中，在"),e("code",[s._v("get()")]),s._v("方法最后将"),e("code",[s._v("window.target")]),s._v("释放掉。")]),s._v(" "),e("li",[s._v("而当数据变化时，会触发数据的"),e("code",[s._v("setter")]),s._v("，在"),e("code",[s._v("setter")]),s._v("中调用了"),e("code",[s._v("dep.notify()")]),s._v("方法，在"),e("code",[s._v("dep.notify()")]),s._v("方法中，遍历所有依赖(即 watcher 实例)，执行依赖的"),e("code",[s._v("update()")]),s._v("方法，也就是"),e("code",[s._v("Watcher")]),s._v("类中的"),e("code",[s._v("update()")]),s._v("实例方法，在"),e("code",[s._v("update()")]),s._v("方法中调用数据变化的更新回调函数，从而更新视图")])]),s._v(" "),e("p",[s._v("总结一下："),e("code",[s._v("Watcher")]),s._v("先把自己设置到全局唯一的指定位置("),e("code",[s._v("window.target")]),s._v(")，然后读取数据。因为读取了数据，所以会触发这个数据的"),e("code",[s._v("getter")]),s._v("。接着，在"),e("code",[s._v("getter")]),s._v("中就会从全局唯一的那个位置读取当前正在读取数据的"),e("code",[s._v("Watcher")]),s._v("，并把这个"),e("code",[s._v("wather")]),s._v("收集到"),e("code",[s._v("Dep")]),s._v("中去。收集好之后，当数据发生变化时，会向"),e("code",[s._v("Dep")]),s._v("中的每个"),e("code",[s._v("Wather")]),s._v("发送通知。通过这样的方式。"),e("code",[s._v("Wather")]),s._v("可以主动去订阅任意一个数据的变化。")]),s._v(" "),e("p",[e("strong",[s._v("不足之处")])]),s._v(" "),e("p",[s._v("虽然我们通过"),e("code",[s._v("Object.defineProperty")]),s._v("方法实现了对"),e("code",[s._v("object")]),s._v("数据的可观测，但是这个方法仅仅只能观测到"),e("code",[s._v("object")]),s._v("数据的取值及设置值，当我们向"),e("code",[s._v("object")]),s._v("数据里添加一对新的"),e("code",[s._v("key/value")]),s._v("或删除一对已有的"),e("code",[s._v("key/value")]),s._v("时，它是无法观测到的，导致当我们对"),e("code",[s._v("object")]),s._v("数据添加或删除时，无法通知依赖，无法驱动视力进行响应式更新。")]),s._v(" "),e("p",[e("code",[s._v("Vue")]),s._v("也注意到了这一点，为了解决这一问题，"),e("code",[s._v("Vue")]),s._v("增加了两个全局 API："),e("code",[s._v("Vue.set")]),s._v("和"),e("code",[s._v("Vue.delete")]),s._v("。")]),s._v(" "),e("p",[e("strong",[s._v("总结")])]),s._v(" "),e("p",[s._v("我们通过"),e("code",[s._v("Object.defineProperty")]),s._v("方法实现了对"),e("code",[s._v("object")]),s._v("数据的可观测，并且封装了"),e("code",[s._v("Observer")]),s._v("类，让我们能够方便的把"),e("code",[s._v("object")]),s._v("数据中的所有属性（包括子属性）都转换成"),e("code",[s._v("getter/setter")]),s._v("的形式来侦测变化。")]),s._v(" "),e("p",[s._v("其整个流程大致如下：")]),s._v(" "),e("ol",[e("li",[e("code",[s._v("Data")]),s._v("通过"),e("code",[s._v("observer")]),s._v("转换成了"),e("code",[s._v("getter/setter")]),s._v("的形式来追踪变化。")]),s._v(" "),e("li",[s._v("当外界通过"),e("code",[s._v("Watcher")]),s._v("读取数据时，会触发"),e("code",[s._v("getter")]),s._v("从而将"),e("code",[s._v("Watcher")]),s._v("添加到依赖中。")]),s._v(" "),e("li",[s._v("当数据发生了变化时，会触发"),e("code",[s._v("setter")]),s._v("，从而向"),e("code",[s._v("Dep")]),s._v("'中的依赖（vcb 即 Watcher）发送通知。")]),s._v(" "),e("li",[e("code",[s._v("Watcher")]),s._v("接收到通知后，会向外界发送能知，变化通知到外界后可能会触发视图更新，也有可能触发某个回调数等。")])]),s._v(" "),e("h4",{attrs:{id:"_2-2-array-的变化侦测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-array-的变化侦测"}},[s._v("#")]),s._v(" 2.2 Array 的变化侦测")]),s._v(" "),e("p",[s._v("上一节文章中我们介绍了"),e("code",[s._v("Object")]),s._v("数据的变化侦测方式，本节我们来看一下对"),e("code",[s._v("Array")]),s._v("型数据的变化"),e("code",[s._v("Vue")]),s._v("是如何进行侦测的。")]),s._v(" "),e("p",[s._v("我们知道，"),e("code",[s._v("Object.defineProperty")]),s._v("监测"),e("code",[s._v("Object")]),s._v("型数据时是给"),e("code",[s._v("Object")]),s._v("型数据的每个"),e("code",[s._v("key/value")]),s._v("添加上了"),e("code",[s._v("getter")]),s._v("和"),e("code",[s._v("setter")]),s._v("，这样，对于"),e("code",[s._v("Object")]),s._v("型数据我们再通过"),e("code",[s._v("key")]),s._v("值取值或设置值时就可以被监测到。")]),s._v(" "),e("p",[s._v("数组并不是只能由索引值来操作数组，更常用的操作数组的方法是使用数组原型上的一些方法如"),e("code",[s._v("push")]),s._v("，"),e("code",[s._v("shift")]),s._v("等来操作数组，当使用这些数据原型方法来数组时，"),e("code",[s._v("Object.defineProperty")]),s._v("就监测不到了，所以"),e("code",[s._v("Vue")]),s._v("对"),e("code",[s._v("Array")]),s._v("型数据单独设计了数据监测方式。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("const methodsToPatch = [\n  'push',\n  'pop',\n  'shift',\n  'unshift',\n  'splice',\n  'sort',\n  'reverse'\n]\n\n/**\n * Intercept mutating methods and emit events\n */\nmethodsToPatch.forEach(function (method) {\n  // cache original method\n  const original = arrayProto[method]\n  def(arrayMethods, method, function mutator (...args) {\n    const result = original.apply(this, args)\n    const ob = this.__ob__\n    let inserted\n    switch (method) {\n      case 'push':\n      case 'unshift':\n        inserted = args\n        break\n      case 'splice':\n        inserted = args.slice(2)\n        break\n    }\n    if (inserted) ob.observeArray(inserted)\n    // notify change\n    ob.dep.notify()\n    return result\n  })\n})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br")])]),e("p",[e("strong",[s._v("数组方法拦截器")])]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("Vue")]),s._v("中创建了一个数组方法拦截器，它拦截在数组实例与"),e("code",[s._v("Array.prototype")]),s._v("之间，在拦截器内重写了操作数组的一些方法，当数组实例使用操作数组方法时，其实使用的是拦截器中重写的方法，而不再使用"),e("code",[s._v("Array.prototype")]),s._v("上的原生方法。如下图所示：")]),s._v(" "),e("p",[e("img",{attrs:{src:"vue12.png",alt:"images"}})]),s._v(" "),e("p",[s._v("经过整理，"),e("code",[s._v("Array")]),s._v("原型中可以改变数组自身内容的方法有 7 个，分别是："),e("code",[s._v("push")]),s._v("、"),e("code",[s._v("pop")]),s._v("、"),e("code",[s._v("shift")]),s._v("、"),e("code",[s._v("unshift")]),s._v("、"),e("code",[s._v("splice")]),s._v("、"),e("code",[s._v("sort")]),s._v("、"),e("code",[s._v("reverse")]),s._v("。源码中的拦截器代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 源码位置：/src/core/observer/array.js\n\nconst arrayProto = Array.prototype\n// 创建一个对象作为拦截器\nexport const arrayMethods = Object.create(arrayProto)\n\n// 改变数组自身内容的7个方法\nconst methodsToPatch = [\n  'push',\n  'pop',\n  'shift',\n  'unshift',\n  'splice',\n  'sort',\n  'reverse'\n]\n\n/**\n * Intercept mutating methods and emit events\n */\nmethodsToPatch.forEach(function (method) {\n  const original = arrayProto[method]      // 缓存原生方法\n  Object.defineProperty(arrayMethods, method, {\n    enumerable: false,\n    configurable: true,\n    writable: true,\n    value:function mutator(...args){\n      const result = original.apply(this, args)\n      return result\n    }\n  })\n})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br")])]),e("p",[e("strong",[s._v("使用拦截器")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 源码位置：/src/core/observer/index.js\nexport class Observer {\n  constructor (value) {\n    this.value = value\n    if (Array.isArray(value)) {\n      const augment = hasProto\n        ? protoAugment\n        : copyAugment\n      augment(value, arrayMethods, arrayKeys)\n    } else {\n      this.walk(value)\n    }\n  }\n}\n// 能力检测：判断__proto__是否可用，因为有的浏览器不支持该属性\nexport const hasProto = '__proto__' in {}\n\nconst arrayKeys = Object.getOwnPropertyNames(arrayMethods)\n\n/**\n * Augment an target Object or Array by intercepting\n * the prototype chain using __proto__\n */\nfunction protoAugment (target, src: Object, keys: any) {\n  target.__proto__ = src\n}\n\n/**\n * Augment an target Object or Array by defining\n * hidden properties.\n */\n/* istanbul ignore next */\nfunction copyAugment (target: Object, src: Object, keys: Array<string>) {\n  for (let i = 0, l = keys.length; i < l; i++) {\n    const key = keys[i]\n    def(target, key, src[key])\n  }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br")])]),e("h4",{attrs:{id:"_2-3-变化侦测的-api-实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-变化侦测的-api-实现"}},[s._v("#")]),s._v(" 2.3 变化侦测的 API 实现")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("vm.$watch")])]),s._v(" "),e("li",[e("code",[s._v("vm.$set")])]),s._v(" "),e("li",[e("code",[s._v("vm.$delete")])])]),s._v(" "),e("p",[e("strong",[e("code",[s._v("vm.$watch")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("vm.$watch(expOrFn, callback, [options]);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("参数：\n"),e("ul",[e("li",[e("code",[s._v("{string | Function} expOrFn")])]),s._v(" "),e("li",[e("code",[s._v("{Function | Object} callback")])]),s._v(" "),e("li",[e("code",[s._v("{Object} [options]")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("{boolean} deep")])]),s._v(" "),e("li",[e("code",[s._v("{boolean} immediate")])])])])])]),s._v(" "),e("li",[s._v("返回值："),e("code",[s._v("{Function} unwatch")])]),s._v(" "),e("li",[s._v("用法：")])]),s._v(" "),e("p",[s._v("观察"),e("code",[s._v("Vue")]),s._v("实例变化的一个表达式或计算属性函数。回调函数得到的参数为新值和旧值。表达式只接受监督的键路径。对于更复杂的表达式，用一个函数取代。")]),s._v(" "),e("p",[s._v("注意：在变异（不是替换）对象或数组时，旧值将与新值相同，因为它们的引用指向同一个对象/数组。"),e("code",[s._v("Vue")]),s._v("不会保留变异之前值的副本。")]),s._v(" "),e("ul",[e("li",[s._v("示例：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('//  键路径\nvm.$watch("a.b.c",function(newVal,oldVal){\n    // 做点什么\n})\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[s._v("选项：deep")])]),s._v(" "),e("p",[s._v("为了发现对象内部值的变化，可以在选项参数中指定"),e("code",[s._v("deep:true")]),s._v("。注意监听数组的变动不需要这么做。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('vm.$watch("someObject", callback, {\n  deep: true\n});\nvm.someObject.nestedValue = 123;\n// callback is fired\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("选项：immediate")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('vm.$watch("a", callback, {\n  immediate: true\n});\n// 立即以 `a` 的当前值触发回调\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[s._v("内部原理")])]),s._v(" "),e("p",[e("code",[s._v("$watch")]),s._v("的定义位于源码的"),e("code",[s._v("src/core/instance/state.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('Vue.prototype.$watch = function (\n    expOrFn: string | Function,\n    cb: any,\n    options?: Object\n  ): Function {\n    const vm: Component = this\n    if (isPlainObject(cb)) {\n      return createWatcher(vm, expOrFn, cb, options)\n    }\n    options = options || {}\n    options.user = true\n    const watcher = new Watcher(vm, expOrFn, cb, options)\n    if (options.immediate) {\n      try {\n        cb.call(vm, watcher.value)\n      } catch (error) {\n        handleError(error, vm, `callback for immediate watcher "${watcher.expression}"`)\n      }\n    }\n    return function unwatchFn () {\n      watcher.teardown()\n    }\n  }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[e("strong",[e("code",[s._v("vm.$set")])])]),s._v(" "),e("p",[e("code",[s._v("vm.$set")]),s._v("是全局"),e("code",[s._v("Vue.set")]),s._v("的"),e("strong",[s._v("别名")]),s._v("，其用法相同。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("vm.$set(target, propertyName / index, value);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[e("strong",[s._v("参数")]),s._v("：\n"),e("ul",[e("li",[e("code",[s._v("{Object | Array} target")])])])])]),s._v(" "),e("p",[e("strong",[e("code",[s._v("vm.$delete")])])]),s._v(" "),e("p",[e("code",[s._v("vm.$delete")]),s._v("是全局"),e("code",[s._v("Vue.delete")]),s._v("的"),e("strong",[s._v("别名")]),s._v("，其用法相同")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("vm.$delete(target, propertyName / index);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[e("p",[e("strong",[s._v("参数")]),s._v("：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("{Object | Array} target")])]),s._v(" "),e("li",[e("code",[s._v("{string | number} propertyName/index")])])])]),s._v(" "),e("li",[e("p",[e("strong",[s._v("用法")]),s._v("：")])]),s._v(" "),e("li",[e("p",[e("strong",[s._v("内部原理")]),s._v("：")])])]),s._v(" "),e("p",[e("code",[s._v("delete")]),s._v("方法是用来解决"),e("code",[s._v("Vue")]),s._v("不能检测到属性被删除的限制，该方法的定义位于源码的"),e("code",[s._v("src/core/observer/index.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("export function del (target: Array<any> | Object, key: any) {\n  if (process.env.NODE_ENV !== 'production' &&\n    (isUndef(target) || isPrimitive(target))\n  ) {\n    warn(`Cannot delete reactive property on undefined, null, or primitive value: ${(target: any)}`)\n  }\n  if (Array.isArray(target) && isValidArrayIndex(key)) {\n    target.splice(key, 1)\n    return\n  }\n  const ob = (target: any).__ob__\n  if (target._isVue || (ob && ob.vmCount)) {\n    process.env.NODE_ENV !== 'production' && warn(\n      'Avoid deleting properties on a Vue instance or its root $data ' +\n      '- just set it to null.'\n    )\n    return\n  }\n  if (!hasOwn(target, key)) {\n    return\n  }\n  delete target[key]\n  if (!ob) {\n    return\n  }\n  ob.dep.notify()\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("h3",{attrs:{id:"三、虚拟-dom-篇"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、虚拟-dom-篇"}},[s._v("#")]),s._v(" 三、虚拟 DOM 篇")]),s._v(" "),e("p",[s._v("参考"),e("a",{attrs:{href:"https://km.xiaowuzi.info/js/vue-dom.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Vue 虚拟 DOM"),e("OutboundLink")],1)]),s._v(" "),e("h3",{attrs:{id:"四、模板编译篇"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、模板编译篇"}},[s._v("#")]),s._v(" 四、模板编译篇")]),s._v(" "),e("ul",[e("li",[s._v("整体运行流程")]),s._v(" "),e("li",[s._v("HTML 解析器")]),s._v(" "),e("li",[s._v("文本解析器")]),s._v(" "),e("li",[s._v("优化阶段")]),s._v(" "),e("li",[s._v("代码生成阶段")])]),s._v(" "),e("p",[s._v("我们知道，在日常开发中，我们把写在"),e("code",[s._v("<template></template>")]),s._v("标签中的类似于原生"),e("code",[s._v("HTML")]),s._v("的内容称之为模板。这时你可能会问了，为什么说是“类似于原生"),e("code",[s._v("HTML")]),s._v("的内容”而不是“就是"),e("code",[s._v("HTML")]),s._v("的内容”？因为我们在开发中，在"),e("code",[s._v("<template></template>")]),s._v("标签中除了写一些原生"),e("code",[s._v("HTML")]),s._v("的标签，我们还会写一些亦是插值，如或者写一些"),e("code",[s._v("Vue")]),s._v("指令，如"),e("code",[s._v("v-on")]),s._v("、"),e("code",[s._v("v-if")]),s._v("等。而这些东西都是在原生"),e("code",[s._v("HTML")]),s._v("语法中不存在的，不被接受的。但事实上我们确实这么写了，也被正确识别了，页面也正常显示了，这又是为什么呢？")]),s._v(" "),e("p",[s._v("这就归功于"),e("code",[s._v("Vue")]),s._v("的模板编译了，"),e("code",[s._v("Vue")]),s._v("会把用户在"),e("code",[s._v("<template></template>")]),s._v("标签中写的类似于原生"),e("code",[s._v("HTML")]),s._v("的内容进行编译，把原生"),e("code",[s._v("HTML")]),s._v("的内容找出来，再把非原生"),e("code",[s._v("HTML")]),s._v("找出来，经过一系列的逻辑处理生成渲染函数，也就是"),e("code",[s._v("render")]),s._v("函数，而"),e("code",[s._v("redner")]),s._v("函数会将模板内容生成对应的"),e("code",[s._v("VNode")]),s._v("，而"),e("code",[s._v("VNode")]),s._v("再经过"),e("code",[s._v("patch")]),s._v("过程从而得到将要渲染的视图中的"),e("code",[s._v("VNode")]),s._v("，最后根据"),e("code",[s._v("VNode")]),s._v("创建真实的"),e("code",[s._v("DOM")]),s._v("节点并插入到视图中，最终完成视图的渲染更新。")]),s._v(" "),e("p",[s._v("而把用户在"),e("code",[s._v("<template></template>")]),s._v("标签中写的类似于原生"),e("code",[s._v("HTML")]),s._v("的内容进行编译，把原生"),e("code",[s._v("HTML")]),s._v("的内容找出来，再把非原生"),e("code",[s._v("HTML")]),s._v("找出来，经过一系列的逻辑处理成渲染函数，也就是"),e("code",[s._v("render")]),s._v("函数的这一段过程称之为模板编译过程。")]),s._v(" "),e("h4",{attrs:{id:"_4-1-整体渲染流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-整体渲染流程"}},[s._v("#")]),s._v(" 4.1 整体渲染流程")]),s._v(" "),e("p",[s._v("所谓渲染流程，就是把用户写的类似原生"),e("code",[s._v("HTML")]),s._v("的模板经过一系列处理最终反应到视图中称之为整个渲染流程。这个流程在上文中其实已经说到了，下面我们以流程图的形式宏观的了解一下，流程图如下：")]),s._v(" "),e("p",[e("img",{attrs:{src:"vue-code01.png",alt:"images"}})]),s._v(" "),e("p",[s._v("从图中我们也可以看到，模板编译过程就是把用户写的模板经过一系列处理最终生成"),e("code",[s._v("render")]),s._v("函数的过程。")]),s._v(" "),e("p",[s._v("将一堆字符串模板解析成抽象语法树"),e("code",[s._v("AST")]),s._v("后，我们就可以对其进行各种操作处理了，处理完后用处理后的"),e("code",[s._v("AST")]),s._v("来生成"),e("code",[s._v("render")]),s._v("函数。其具体流程可大致分为三个阶段：")]),s._v(" "),e("ol",[e("li",[s._v("模板解析阶段：将一堆模板字符串用正则等方式解析成抽象语法树"),e("code",[s._v("AST")]),s._v("；")]),s._v(" "),e("li",[s._v("优化阶段：遍历"),e("code",[s._v("AST")]),s._v("，找出其中的静态节点，并打上标记；")]),s._v(" "),e("li",[s._v("代码生成阶段：将"),e("code",[s._v("AST")]),s._v("转换成渲染函数；")])]),s._v(" "),e("p",[s._v("这三个阶段在源码中分别对应三个模块，下面给出三个模块的源代码在源码中的路径：")]),s._v(" "),e("ol",[e("li",[s._v("模板解析段——解析器——源码路径："),e("code",[s._v("src/compiler/parser/index.js")])]),s._v(" "),e("li",[s._v("优化阶段——优化器——源码路径："),e("code",[s._v("src/compiler/optimizer.js")])]),s._v(" "),e("li",[s._v("代码生成阶段——代码生成器——源码路径："),e("code",[s._v("src/compiler/codegen/index.js")])])]),s._v(" "),e("p",[s._v("其对应的源码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 源码位置：/src/complier/index.js\n\nexport const createCompiler = createCompilerCreator(function baseCompile (\n  template: string,\n  options: CompilerOptions\n): CompiledResult {\n  const ast = parse(template.trim(), options)\n  if (options.optimize !== false) {\n    optimize(ast, options)\n  }\n  const code = generate(ast, options)\n  return {\n    ast,\n    render: code.render,\n    staticRenderFns: code.staticRenderFns\n  }\n})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("p",[s._v("可以看到"),e("code",[s._v("baseCompile")]),s._v("的代码非常的简短主要核心代码。")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("const ast = parse(template.trim(),options)")]),s._v("："),e("code",[s._v("parse")]),s._v("会用与此同时等方式解析"),e("code",[s._v("template")]),s._v("模板中的指令、"),e("code",[s._v("class")]),s._v("、"),e("code",[s._v("style")]),s._v("等数据，形成"),e("code",[s._v("AST")]),s._v("。")]),s._v(" "),e("li",[e("strong",[s._v("optimize(ast,options)")]),s._v("："),e("code",[s._v("optimize")]),s._v("的主要作用是标记静态节点，这是"),e("code",[s._v("Vue")]),s._v("在编译过程中的一处优化，档在进行"),e("code",[s._v("patch")]),s._v("的过程中，"),e("code",[s._v("DOM-Diff")]),s._v("算法会直接跳过静态节点，从而减少了比较的过程，优化了"),e("code",[s._v("patch")]),s._v("的性能。")]),s._v(" "),e("li",[e("strong",[s._v("const code = generate(ast,options)")]),s._v("：将"),e("code",[s._v("AST")]),s._v("转化成"),e("code",[s._v("render")]),s._v("函数字符串的过程，得到结果是"),e("code",[s._v("render")]),s._v("函数的字符串以及"),e("code",[s._v("staticRenderFns")]),s._v("字符串。")])]),s._v(" "),e("p",[s._v("最终"),e("code",[s._v("baseCompile")]),s._v("的返回值")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("{\n    ast:ast,\n    render: code.render,\n    staticRenderFns: code.staticRenderFns\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("最终返回了抽象语法树(ast)，渲染函数(render)，静态渲染函数(staticRenderFns)，且"),e("code",[s._v("render")]),s._v("的值为"),e("code",[s._v("code.render")]),s._v("，"),e("code",[s._v("staticRendreFns")]),s._v("的值为"),e("code",[s._v("code.staticRenderFns")]),s._v("，也就是说通过"),e("code",[s._v("generate")]),s._v("处理"),e("code",[s._v("ast")]),s._v("之后得到的返回值"),e("code",[s._v("code")]),s._v("是一个对象。")]),s._v(" "),e("p",[s._v("流程图如下：")]),s._v(" "),e("p",[e("img",{attrs:{src:"vue13.png",alt:"images"}})]),s._v(" "),e("h4",{attrs:{id:"_4-2-整体运行流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-整体运行流程"}},[s._v("#")]),s._v(" 4.2 整体运行流程")]),s._v(" "),e("p",[s._v("在模板解析阶段主要做的工作是把用户在"),e("code",[s._v("<template></template>")]),s._v("标签内写的模板使用正则等方式解析成抽象语法树（"),e("code",[s._v("AST")]),s._v("）。而这一阶段在源码中对应解析器（"),e("code",[s._v("parser")]),s._v("）模块。")]),s._v(" "),e("p",[s._v("解析器，顾名思义，就是把用户所写的模板根据一定的解析规则解析出有效的信息，最后用这些信息形成"),e("code",[s._v("AST")]),s._v("。我们知道在"),e("code",[s._v("<template></template>")]),s._v("模板内，除了有常规的"),e("code",[s._v("HTML")]),s._v("标签外，用户还会一些文本信息以及在文本信息中包含过滤器。而这些不同的内容在解析起来肯定需要不同的解析规则，所以解析器不可能只有一个，它应该除了有解析常规"),e("code",[s._v("HTML")]),s._v("的 HTML 解析器，还应该有解析文本的文本解析器以及解析文本如果包含过滤器的过滤器解析器。")]),s._v(" "),e("p",[s._v("文本信息和标签属性信息却又是存在于 HTML 标签之内的，所以在解析整个模板的时候它的流程应该是这样子的")]),s._v(" "),e("p",[e("strong",[s._v("回到源码")])]),s._v(" "),e("p",[s._v("解析器的源码位于"),e("code",[s._v("/src/complier/parser")]),s._v("文件夹下，其主线代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 代码位置：/src/complier/parser/index.js\n\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[e("strong",[s._v("总结")])]),s._v(" "),e("p",[s._v("模板解析其实就是根据被解析内容的特点使用正则等方式将有效信息解析提取出来，根据解析内容的不同分为 HTML 解析器，文本解析器和过滤器解析器。而文本信息与过滤器信息又存在于 HTML 标签中，所以在解析器主线函数"),e("code",[s._v("parse")]),s._v("中先调用 HTML 解析器"),e("code",[s._v("parseHTML")]),s._v("函数对模板字符串进行解析，如果在解析过程中遇到文本或过滤器信息则再调用相应的解析器进行解析，最终完成对整个模板字符串的解析。")]),s._v(" "),e("h4",{attrs:{id:"_4-3-html-解析器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-html-解析器"}},[s._v("#")]),s._v(" 4.3 HTML 解析器")]),s._v(" "),e("p",[e("strong",[s._v("HTML 解析器内部运行流程")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("//  代码位置：/src/complier/parser/index.js\n\n/**\n *  Convert HTML string to AST.\n *  将HTML模板字符串转化为AST\n */\nexport function parse(template,options){\n    // ...\n    parseHTML(template,{\n        warn,\n        expectHTML: options.expectHTML,\n        isUnaryTag: options.isUnaryTag,\n        canBeLeftOpenTag: options.canBeLeftOpenTag,\n        shouldDecodeNewlines: options.shouldDecodeNewlines,\n        shouldDecodeNewlinesForHref: options.shouldDecodeNewlinesForHref,\n        shouldKeepComment: options.comments,\n        // 当解析到开始标签时，调用该函数\n        start(tag,attrs,unary){\n\n        },\n        // 当解析到结束标签时，调用该函数\n        end(){\n\n        },\n        // 当解析到文本时，调用该函数\n        chars(text){\n\n        },\n        // 当解析到注释时，调用该函数\n        comment(text){\n\n        }\n    })\n    return root\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br")])]),e("p",[s._v("从代码中我们可以看到，调用"),e("code",[s._v("parseHTML")]),s._v("函数时为其传入的两个参数分别是：")]),s._v(" "),e("ul",[e("li",[s._v("template 待转换的模板字符串；")]),s._v(" "),e("li",[s._v("options 转换时所需的选项；")])]),s._v(" "),e("p",[s._v("第一个参数是待转换的模板字符串，无需多言；重点看第二个参数，第二个参数提供了")]),s._v(" "),e("ul",[e("li",[s._v("当解析到开始标签时调用"),e("code",[s._v("start")]),s._v("函数生成元素类型的"),e("code",[s._v("AST")]),s._v("节点，代码如下；")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 当解析到标签的开始位置时，触发start\nstart (tag, attrs, unary, start, end) {\n    let element = crateASTElement(tag,atrrs,currentParent)\n}\n\nexport function crateASTElement(tag,attrs,parent){\n    return {\n        type: 1,\n        tag,\n        attrsList: attrs,\n        attrsMap: makeAttrsMap(attrs),\n        rawAttrsMap: {},\n        parent,\n        children: []\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("从上面代码中我们可以看到，"),e("code",[s._v("start")]),s._v("函数接收五个参数，分别是标签名"),e("code",[s._v("tag")]),s._v("、标签属性"),e("code",[s._v("attrs")]),s._v("、标签是否自闭合"),e("code",[s._v("unary")]),s._v("、开始"),e("code",[s._v("start")]),s._v("、结束"),e("code",[s._v("end")]),s._v("。当调用该钩子函数时，内部会调用"),e("code",[s._v("createASTElement")]),s._v("函数来创建元素类型的"),e("code",[s._v("AST")]),s._v("节点")]),s._v(" "),e("ul",[e("li",[s._v("当解析到结束标签时调用"),e("code",[s._v("end")]),s._v("函数；")]),s._v(" "),e("li",[s._v("当解析到文本调用"),e("code",[s._v("chars")]),s._v("函数生成文本类型的"),e("code",[s._v("AST")]),s._v("节点；")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("chars (text: string, start: number, end: number) {\n      if (!currentParent) {\n        if (process.env.NODE_ENV !== 'production') {\n          if (text === template) {\n            warnOnce(\n              'Component template requires a root element, rather than just text.',\n              { start }\n            )\n          } else if ((text = text.trim())) {\n            warnOnce(\n              `text \"${text}\" outside root element will be ignored.`,\n              { start }\n            )\n          }\n        }\n        return\n      }\n      // IE textarea placeholder bug\n      /* istanbul ignore if */\n      if (isIE &&\n        currentParent.tag === 'textarea' &&\n        currentParent.attrsMap.placeholder === text\n      ) {\n        return\n      }\n      const children = currentParent.children\n      if (inPre || text.trim()) {\n        text = isTextTag(currentParent) ? text : decodeHTMLCached(text)\n      } else if (!children.length) {\n        // remove the whitespace-only node right after an opening tag\n        text = ''\n      } else if (whitespaceOption) {\n        if (whitespaceOption === 'condense') {\n          // in condense mode, remove the whitespace node if it contains\n          // line break, otherwise condense to a single space\n          text = lineBreakRE.test(text) ? '' : ' '\n        } else {\n          text = ' '\n        }\n      } else {\n        text = preserveWhitespace ? ' ' : ''\n      }\n      if (text) {\n        if (!inPre && whitespaceOption === 'condense') {\n          // condense consecutive whitespaces into single space\n          text = text.replace(whitespaceRE, ' ')\n        }\n        let res\n        let child: ?ASTNode\n        if (!inVPre && text !== ' ' && (res = parseText(text, delimiters))) {\n          child = {\n            type: 2,\n            expression: res.expression,\n            tokens: res.tokens,\n            text\n          }\n        } else if (text !== ' ' || !children.length || children[children.length - 1].text !== ' ') {\n          child = {\n            type: 3,\n            text\n          }\n        }\n        if (child) {\n          if (process.env.NODE_ENV !== 'production' && options.outputSourceRange) {\n            child.start = start\n            child.end = end\n          }\n          children.push(child)\n        }\n      }\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br")])]),e("p",[s._v("当解析到标签的文本时，触发"),e("code",[s._v("charts")]),s._v("钩子函数，在该钩子函数内部，首先会判断文本是不是一个带变量的动态文本，如“hello”。如果是动态文本，则创建动态文本类型的"),e("code",[s._v("AST")]),s._v("节点；如果不是动态文本，则创建纯静态文本类型的"),e("code",[s._v("AST")]),s._v("节点。")]),s._v(" "),e("ul",[e("li",[s._v("当解析到注释时调用"),e("code",[s._v("comment")]),s._v("函数生成注释类型的"),e("code",[s._v("AST")]),s._v("节点；")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 当解析到标签的注释时，触发comment\ncomment (text: string) {\n  let element = {\n    type: 3,\n    text,\n    isComment: true\n  }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("当解析到标签的注释时，触发"),e("code",[s._v("comment")]),s._v("钩子函数，该钩子函数会创建一个注释类型的"),e("code",[s._v("AST")]),s._v("节点。")]),s._v(" "),e("p",[s._v("一边解析不同的内容一边调用对应的钩子函数生成对应的"),e("code",[s._v("AST")]),s._v("节点，最终完成将整个模板字符串转化成"),e("code",[s._v("AST")]),s._v("，这就是"),e("code",[s._v("HTML")]),s._v("解析器所要做的工作。")]),s._v(" "),e("p",[e("strong",[s._v("如何解析不同的内容")])]),s._v(" "),e("p",[s._v("要从模板字符串中解析出不同的内容，那")]),s._v(" "),e("ul",[e("li",[s._v("文本，例如“难凉热血”")]),s._v(" "),e("li",[s._v("HTML 注释，例如"),e("code",[s._v("\x3c!--我是注释--\x3e")])]),s._v(" "),e("li",[s._v("条件注释，例如"),e("code",[s._v("\x3c!--[if !IE] --\x3e我是注释<![endif]--\x3e")])]),s._v(" "),e("li",[s._v("DOCTYPE，例如"),e("code",[s._v("<!DOCTYPE html>")])]),s._v(" "),e("li",[s._v("开始标签，例如"),e("code",[s._v("<div>")])]),s._v(" "),e("li",[s._v("结束标签，例如"),e("code",[s._v("</div>")])])]),s._v(" "),e("p",[s._v("这几种内容都有其各自独有的特点，也就是说我们要根据不同内容所具有的不同的特点通过编写不同的表达式将这些内容从模板字符串中一一解析出来，然后再把不同的内容做不同的处理。")]),s._v(" "),e("p",[e("strong",[s._v("解析 HTML 注释")])]),s._v(" "),e("p",[s._v("解析注释比较简单，我们知道"),e("code",[s._v("HTML")]),s._v("注释是以"),e("code",[s._v("\x3c!--")]),s._v("开头，以"),e("code",[s._v("--\x3e")]),s._v("结尾，这两者中间的内容，那么我们只需用正则判断")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("const comment = /^<!\\--/\nif(comment.test(html)){\n    // 若为注释，则继续查找是否存在'--\x3e'\n    const commentEnd = html.indexOf('--\x3e')\n\n    if(commentEnd >= 0){\n        // 若存在 '--\x3e'，继续判断options中是否保留注释\n        if(options.shouldKeepComment){\n            // 若保留注释，则把注释截取出来给options.comment，创建溈类型的AST节点\n            options.comment(html,substring(4,commentEnd) index, index + commentEnd + 3)\n        }\n        // 若不保留注释，则将游标移动到'--\x3e'之后，继续向后解析\n        advance(commentEnd+3)\n        continue\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("在上面代码中，如果模板字符串"),e("code",[s._v("html")]),s._v("符合注释开始的正则，那么就继续向后查找是否存在"),e("code",[s._v("--\x3e")]),s._v("，若存在，则把"),e("code",[s._v("html")]),s._v("从第 4 位（"),e("code",[s._v('"\x3c!--"')]),s._v("长度为 4）开始截取，直到"),e("code",[s._v("--\x3e")]),s._v("处，截取得到的内容就是注释的真实内容，然后调用 4 个钩子函数中的"),e("code",[s._v("comment")]),s._v("函数，将真实的注释内容传进去，创建溈类型的"),e("code",[s._v("AST")]),s._v("节点。")]),s._v(" "),e("p",[s._v("上面代码中有一处值得注意的地方，那就是我们平常在模板中可以在"),e("code",[s._v("<template></template>")]),s._v("标签上配置"),e("code",[s._v("comments")])]),s._v(" "),e("p",[e("code",[s._v("advance")]),s._v("函数是用来移动解析游标的，解析完一部分就把游标向后移动一部分，确保不会重复解析，其代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("function advance(n){\n    index +=n       // index为解析游标\n    html = html.substring(n)\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("strong",[s._v("解析条件注释")])]),s._v(" "),e("p",[s._v("解析条件注释也比较简单，其原理跟解析注释相同，都是先用与正则判断是否是以条件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("// 解析是否是条件注释\nconst conditionalComment = /^<!\\[/\nif(conditionalComment.test(html)){\n\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("strong",[s._v("解析 DOCTYPE")])]),s._v(" "),e("p",[s._v("解析"),e("code",[s._v("DOCTYPE")]),s._v("的原理同解析条件注释完全相同，此处不再赘述，代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("const doctype = /^<!DOCTYPE [^>]+>/i\n// 解析是否是DOCTYPE\nconst doctypeMatch  = html.match(doctype)\nif (doctypeMatch) {\n  advance(doctypeMatch[0].length)\n  continue\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[e("strong",[s._v("解析开始标签")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("解析结束标签")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("解析文本")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h4",{attrs:{id:"_4-4-文本解析器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-文本解析器"}},[s._v("#")]),s._v(" 4.4 文本解析器")]),s._v(" "),e("h4",{attrs:{id:"_4-5-优化阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-优化阶段"}},[s._v("#")]),s._v(" 4.5 优化阶段")]),s._v(" "),e("p",[s._v("优化阶段其实干了两件事：")]),s._v(" "),e("ol",[e("li",[s._v("在"),e("code",[s._v("AST")]),s._v("中找出所有静态节点并打上标记；")]),s._v(" "),e("li",[s._v("在"),e("code",[s._v("AST")]),s._v("中找出所有表态根节点并打上标记；")])]),s._v(" "),e("p",[s._v("优化阶段的源码位于"),e("code",[s._v("src/compiler/optimizer.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function optimize (root: ?ASTElement, options: CompilerOptions) {\n    if (!root) return\n    isStaticKey = genStaticKeysCached(options.staticKeys || '')\n    isPlatformReservedTag = options.isReservedTag || no\n    // 标记静态节点\n    markStatic(root)\n    // 标记静态根节点\n    markStaticRoots(root, false)\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[e("strong",[s._v("标记静态节点")])]),s._v(" "),e("p",[s._v("从"),e("code",[s._v("AST")]),s._v("中找出所有静态节点并标记其实不难，我们只需从根节点开始，先标记点是否静态节点，然后看根节点如果是元素节点，那么就向下递归它的子节点，子节点如果还有子节点那就继续向下递归，直到票房完所有节点。代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nfunction markStatic (node: ASTNode) {\nnode.static = isStatic(node)\nif (node.type === 1) {\n// do not make component slot content static. this avoids\n// 1. components not able to mutate slot nodes\n// 2. static slot content fails for hot-reloading\nif (\n!isPlatformReservedTag(node.tag) &&\nnode.tag !== 'slot' &&\nnode.attrsMap['inline-template'] == null\n) {\nreturn\n}\nfor (let i = 0, l = node.children.length; i < l; i++) {\nconst child = node.children[i]\nmarkStatic(child)\nif (!child.static) {\nnode.static = false\n}\n}\nif (node.ifConditions) {\nfor (let i = 1, l = node.ifConditions.length; i < l; i++) {\nconst block = node.ifConditions[i].block\nmarkStatic(block)\nif (!block.static) {\nnode.static = false\n}\n}\n}\n}\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("p",[s._v("上面代码中，首先调用"),e("code",[s._v("isStatic")]),s._v("函数标记节点是否为静态节点，该函数若返回"),e("code",[s._v("true")]),s._v("表示该节点是静态节点，若返回"),e("code",[s._v("false")]),s._v("表示该节点不是静态节点，函数实现如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nfunction isStatic (node: ASTNode): boolean {\nif (node.type === 2) { // expression\nreturn false\n}\nif (node.type === 3) { // text\nreturn true\n}\nreturn !!(node.pre || (\n!node.hasBindings && // no dynamic bindings\n!node.if && !node.for && // not v-if or v-for or v-else\n!isBuiltInTag(node.tag) && // not a built-in\nisPlatformReservedTag(node.tag) && // not a component\n!isDirectChildOfTemplateFor(node) &&\nObject.keys(node).every(isStaticKey)\n))\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("该函数的实现过程其实也说明了如何判断一个节点是否为静态节点。")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("type 取值")]),s._v(" "),e("th",[s._v("对应的 AST 节点类型")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("1")]),s._v(" "),e("td",[s._v("元素节点")])]),s._v(" "),e("tr",[e("td",[s._v("2")]),s._v(" "),e("td",[s._v("包含变量的动态文本节点")])]),s._v(" "),e("tr",[e("td",[s._v("3")]),s._v(" "),e("td",[s._v("不包含变量的纯文本节点")])])])]),s._v(" "),e("p",[s._v("如果元素节点是静态节点，那就必须满足以下几点要求：")]),s._v(" "),e("ul",[e("li",[s._v("如果节点使用"),e("code",[s._v("v-pre")]),s._v("指令，那就断定它是静态节点；")]),s._v(" "),e("li",[s._v("如果节点没有使用"),e("code",[s._v("v-pre")]),s._v("指令，那它要成为静态节点必须满足：\n"),e("ul",[e("li",[s._v("不能使用动态绑定语法，即标签上不能有"),e("code",[s._v("v-")]),s._v("、"),e("code",[s._v("@")]),s._v("、"),e("code",[s._v(":")]),s._v("开头的属性；")]),s._v(" "),e("li",[s._v("不能使用"),e("code",[s._v("v-if")]),s._v("、"),e("code",[s._v("v-else")]),s._v("、"),e("code",[s._v("v-for")]),s._v(" 指令；")]),s._v(" "),e("li",[s._v("不能是内置组件，即标签名不能是"),e("code",[s._v("slot")]),s._v("和"),e("code",[s._v("component")]),s._v(";")]),s._v(" "),e("li",[s._v("标签名必须是平台保留标签，即不能是组件；")]),s._v(" "),e("li",[s._v("当前节点的父节点不能是带有"),e("code",[s._v("v-for")]),s._v("和"),e("code",[s._v("template")]),s._v("标签；")]),s._v(" "),e("li",[s._v("节点的所有属性的"),e("code",[s._v("key")]),s._v("都必须是静态节点才有的"),e("code",[s._v("key")]),s._v("，注：静态节点的"),e("code",[s._v("key")]),s._v("是有限的，它只能是"),e("code",[s._v("type")]),s._v("、"),e("code",[s._v("tag")]),s._v("、"),e("code",[s._v("attrsList")]),s._v("、"),e("code",[s._v("attrsMap")]),s._v("、"),e("code",[s._v("plain")]),s._v("、"),e("code",[s._v("parent")]),s._v("、"),e("code",[s._v("children")]),s._v("、"),e("code",[s._v("attrs")]),s._v("之一；")])])])]),s._v(" "),e("p",[e("strong",[s._v("标记静态根节点")])]),s._v(" "),e("p",[s._v("寻找表态根节点找静态节点的逻辑类似，都是从"),e("code",[s._v("AST")]),s._v("根节点递归向上遍历寻找，其代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nfunction markStaticRoots (node: ASTNode, isInFor: boolean) {\nif (node.type === 1) {\nif (node.static || node.once) {\nnode.staticInFor = isInFor\n}\n// For a node to qualify as a static root, it should have children that\n// are not just static text. Otherwise the cost of hoisting out will\n// outweigh the benefits and it's better off to just always render it fresh.\nif (node.static && node.children.length && !(\nnode.children.length === 1 &&\nnode.children[0].type === 3\n)) {\nnode.staticRoot = true\nreturn\n} else {\nnode.staticRoot = false\n}\nif (node.children) {\nfor (let i = 0, l = node.children.length; i < l; i++) {\nmarkStaticRoots(node.children[i], isInFor || !!node.for)\n}\n}\nif (node.ifConditions) {\nfor (let i = 1, l = node.ifConditions.length; i < l; i++) {\nmarkStaticRoots(node.ifConditions[i].block, isInFor)\n}\n}\n}\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("h4",{attrs:{id:"_4-5-代码生成阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-代码生成阶段"}},[s._v("#")]),s._v(" 4.5 代码生成阶段")]),s._v(" "),e("h3",{attrs:{id:"五、生命周期篇"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五、生命周期篇"}},[s._v("#")]),s._v(" 五、生命周期篇")]),s._v(" "),e("ul",[e("li",[s._v("初始化阶段")]),s._v(" "),e("li",[s._v("模板编译阶段")]),s._v(" "),e("li",[s._v("挂载阶段")]),s._v(" "),e("li",[s._v("销毁阶段")])]),s._v(" "),e("h4",{attrs:{id:"_5-1-初始化阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-初始化阶段"}},[s._v("#")]),s._v(" 5.1 初始化阶段")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("new Vue")])]),s._v(" "),e("li",[e("code",[s._v("initLifecycle")])]),s._v(" "),e("li",[e("code",[s._v("initEvents")])]),s._v(" "),e("li",[e("code",[s._v("initInjections")])]),s._v(" "),e("li",[e("code",[s._v("initState")])])]),s._v(" "),e("p",[e("strong",[s._v("new Vue 都干了什么")])]),s._v(" "),e("p",[s._v("初始化阶段所做的第一件事就是"),e("code",[s._v("new Vue()")]),s._v("创建一个"),e("code",[s._v("Vue")]),s._v("实例，那么"),e("code",[s._v("new Vue()")]),s._v("的内部都干了什么呢？我们知道，"),e("code",[s._v("new")]),s._v("关键字在"),e("code",[s._v("JS")]),s._v("中表示从一个类中实例化出一个对象来，由此可见，"),e("code",[s._v("Vue")]),s._v("实际上是一个类。所以"),e("code",[s._v("new Vue()")]),s._v("实际上是执行了"),e("code",[s._v("Vue")]),s._v("类的构造函数")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nfunction Vue (options) {\nif (process.env.NODE_ENV !== 'production' &&\n!(this instanceof Vue)\n) {\nwarn('Vue is a constructor and should be called with the `new` keyword')\n}\nthis.\\_init(options)\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[e("strong",[s._v("合并属性")])]),s._v(" "),e("p",[s._v("在上文中，"),e("code",[s._v("_init")]),s._v("方法里首先会调用"),e("code",[s._v("mergeOptions")]),s._v("函数来进行属性合并，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nvm.\\$options = mergeOptions(\nresolveConstructorOptions(vm.constructor),\noptions || {},\nvm\n)\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("它实际上就是把 "),e("code",[s._v("resolveConstructorOptions(vm.constructor)")]),s._v(" 的返回值和 "),e("code",[s._v("options")]),s._v(" 做合并，返回"),e("code",[s._v("vm.constructor.options")]),s._v("，相当于"),e("code",[s._v("Vue.options")]),s._v("，那么这个"),e("code",[s._v("Vue.options")]),s._v("又是什么呢，其实在"),e("code",[s._v("initGlobalAPI(Vue)")]),s._v("的时候定义了这个值，代码在"),e("code",[s._v("src/core/global-api/index.js")]),s._v("中：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function initGlobalAPI (Vue: GlobalAPI) {\n// ...\nVue.options = Object.create(null)\nASSET_TYPES.forEach(type => {\nVue.options[type + 's'] = Object.create(null)\n})\n\nextend(Vue.options.components, builtInComponents)\n// ...\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("首先通过"),e("code",[s._v("Vue.options = Object.create(null)")]),s._v("创建一个空对象，然后遍历"),e("code",[s._v("ASSET_TYPES")]),s._v("，"),e("code",[s._v("ASSET_TYPES")]),s._v("的定义在"),e("code",[s._v("src/shared/contstants.js")]),s._v("中：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport const ASSET_TYPES = [\n'component',\n'directive',\n'filter'\n]\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("上面遍历"),e("code",[s._v("ASSET_TYPES")]),s._v("后代码相当于：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nVue.options.components = {}\nVue.options.directives = {}\nVue.options.filters = {}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("最后通过"),e("code",[s._v("extend(Vue.options.components,builtInCompontents)")]),s._v("把一些内置组件扩展到"),e("code",[s._v("Vue.options.components")]),s._v("上，"),e("code",[s._v("Vue")]),s._v("的内置组件目前有"),e("code",[s._v("<keep-alive>")]),s._v("、"),e("code",[s._v("<transition>")]),s._v("和"),e("code",[s._v("<transition-group>")]),s._v("组件，这也就是为什么我们在其它组件中使用这些组件不需要注册的原因。")]),s._v(" "),e("p",[e("code",[s._v("mergeOptions")]),s._v("这个函数，它的定义在"),e("code",[s._v("src/core/util/options.js")]),s._v("中：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\n/\\*\\*\n\n- Merge two option objects into a new one.\n- Core utility used in both instantiation and inheritance.\n  \\*/\n  export function mergeOptions (\n  parent: Object,\n  child: Object,\n  vm?: Component\n  ): Object {\n  if (process.env.NODE_ENV !== 'production') {\n  checkComponents(child)\n  }\n\nif (typeof child === 'function') {\nchild = child.options\n}\n\nnormalizeProps(child, vm)\nnormalizeInject(child, vm)\nnormalizeDirectives(child)\n\n// Apply extends and mixins on the child options,\n// but only if it is a raw options object that isn't\n// the result of another mergeOptions call.\n// Only merged options has the \\_base property.\nif (!child.\\_base) {\nif (child.extends) {\nparent = mergeOptions(parent, child.extends, vm)\n}\nif (child.mixins) {\nfor (let i = 0, l = child.mixins.length; i < l; i++) {\nparent = mergeOptions(parent, child.mixins[i], vm)\n}\n}\n}\n\nconst options = {}\nlet key\nfor (key in parent) {\nmergeField(key)\n}\nfor (key in child) {\nif (!hasOwn(parent, key)) {\nmergeField(key)\n}\n}\nfunction mergeField (key) {\nconst strat = strats[key] || defaultStrat\noptions[key] = strat(parent[key], child[key], vm, key)\n}\nreturn options\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br")])]),e("p",[s._v("可以看出，"),e("code",[s._v("mergeOptions")]),s._v("函数的主要功能是把"),e("code",[s._v("parent")]),s._v("和"),e("code",[s._v("child")]),s._v("这两个对象根据一些合并策略，合并成一个新对象并返回。首先递归把"),e("code",[s._v("extends")]),s._v("和"),e("code",[s._v("mixins")]),s._v("合并到"),e("code",[s._v("parent")]),s._v("上")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("生命周期钩子函数的合并策略如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nfunction mergeHook(parentVal,childVal){\nreturn childVal? parentVal ? parentVal.concat(childVal) : Array.isArray(childVal) ? childVal : [childVal] : parentVal\n}\n\nLIFECYCLE_HOOKS.forEach(hook => {\nstrats[hook] = mergeHook\n})\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("这其中的"),e("code",[s._v("LIFECYCLE_HOOKS")]),s._v("的定义在"),e("code",[s._v("src/shared/constants.js")]),s._v("中：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport const LIFECYCLE_HOOKS = [\n'beforeCreate',\n'created',\n'beforeMount',\n'mounted',\n'beforeUpdate',\n'updated',\n'beforeDestroy',\n'destroyed',\n'activated',\n'deactivated',\n'errorCaptured'\n]\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[e("strong",[s._v("callHook 函数如何触发钩子函数")])]),s._v(" "),e("p",[s._v("关于"),e("code",[s._v("callHook")]),s._v("函数如何触发钩子函数的问题，我们只需看一下该函数的实现源码即可，该函数的源码位于"),e("code",[s._v("src/core/instance/lifecycle.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function callHook(vm,hook){\nconst handlers = vm.\\$options[hook]\nif(handlers){\nfor(let i = 0,j = handlers.length;i<j;i++){\ntry{\nhanlders[i].call(vm)\n}catch(e){\nhandleError(e,vm,`${hook} hook`)\n}\n}\n}\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("可以看到，"),e("code",[s._v("callHook")]),s._v("函数逻辑非常简单。首先从实例的"),e("code",[s._v("$options")]),s._v("中获取到需要触发的钩子名称所对应的钩子函数数组"),e("code",[s._v("handlers")]),s._v("，我们说过，每个生命周期钩子名称都对应一个钩子函数数组。然后遍历该数组，将数组中的每个钩子函数都执行一遍。")]),s._v(" "),e("p",[e("strong",[s._v("initLifecycle 函数分析")])]),s._v(" "),e("p",[e("code",[s._v("initLifecycle")]),s._v("函数的定义的位于源码的"),e("code",[s._v("src/core/instance/lifecycle.js")]),s._v("中，其代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function initLifecycle (vm: Component) {\nconst options = vm.$options\n\n// locate first non-abstract parent\nlet parent = options.parent\nif (parent && !options.abstract) {\nwhile (parent.$options.abstract && parent.$parent) {\nparent = parent.$parent\n    }\n    parent.$children.push(vm)\n}\n\nvm.$parent = parent\n  vm.$root = parent ? parent.\\$root : vm\n\nvm.$children = []\n  vm.$refs = {}\n\nvm._watcher = null\nvm._inactive = null\nvm._directInactive = false\nvm._isMounted = false\nvm._isDestroyed = false\nvm._isBeingDestroyed = false\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("p",[e("strong",[s._v("解析事件")])]),s._v(" "),e("p",[s._v("在"),e("code",[s._v("Vue")]),s._v("中，当我们在父组件中使用子组件时可以给子组件上注册一些事件，这些事件包括使用"),e("code",[s._v("v-on")]),s._v("或"),e("code",[s._v("@")]),s._v("注册的自定义事件，也包括注册的浏览器原生事件，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('<child @select="selectHandler" @click.native="clickHandler"></child>\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("上面代码，首先要从解析事件开始说起，当遇到开始标签的时候，除了会解析开始标签，还会调用"),e("code",[s._v("processAttrs")]),s._v("方法解析标签中的属性，"),e("code",[s._v("processAttrs")]),s._v("方法位于源码的"),e("code",[s._v("src/compiler/parser/index.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nfunction processAttrs (el) {\nconst list = el.attrsList\nlet i, l, name, rawName, value, modifiers, syncGen, isDynamic\nfor (i = 0, l = list.length; i < l; i++) {\nname = rawName = list[i].name\nvalue = list[i].value\nif (dirRE.test(name)) {\n// mark element as dynamic\nel.hasBindings = true\n// modifiers\nmodifiers = parseModifiers(name.replace(dirRE, ''))\n// support .foo shorthand syntax for the .prop modifier\nif (process.env.VBIND_PROP_SHORTHAND && propBindRE.test(name)) {\n(modifiers || (modifiers = {})).prop = true\nname = `.` + name.slice(1).replace(modifierRE, '')\n} else if (modifiers) {\nname = name.replace(modifierRE, '')\n}\nif (bindRE.test(name)) { // v-bind\nname = name.replace(bindRE, '')\nvalue = parseFilters(value)\nisDynamic = dynamicArgRE.test(name)\nif (isDynamic) {\nname = name.slice(1, -1)\n}\nif (\nprocess.env.NODE_ENV !== 'production' &&\nvalue.trim().length === 0\n) {\nwarn(\n`The value for a v-bind expression cannot be empty. Found in \"v-bind:${name}\"`\n)\n}\nif (modifiers) {\nif (modifiers.prop && !isDynamic) {\nname = camelize(name)\nif (name === 'innerHtml') name = 'innerHTML'\n}\nif (modifiers.camel && !isDynamic) {\nname = camelize(name)\n}\nif (modifiers.sync) {\nsyncGen = genAssignmentCode(value, `$event`)\nif (!isDynamic) {\naddHandler(\nel,\n`update:${camelize(name)}`,\nsyncGen,\nnull,\nfalse,\nwarn,\nlist[i]\n)\nif (hyphenate(name) !== camelize(name)) {\naddHandler(\nel,\n`update:${hyphenate(name)}`,\nsyncGen,\nnull,\nfalse,\nwarn,\nlist[i]\n)\n}\n} else {\n// handler w/ dynamic event name\naddHandler(\nel,\n`\"update:\"+(${name})`,\nsyncGen,\nnull,\nfalse,\nwarn,\nlist[i],\ntrue // dynamic\n)\n}\n}\n}\nif ((modifiers && modifiers.prop) || (\n!el.component && platformMustUseProp(el.tag, el.attrsMap.type, name)\n)) {\naddProp(el, name, value, list[i], isDynamic)\n} else {\naddAttr(el, name, value, list[i], isDynamic)\n}\n} else if (onRE.test(name)) { // v-on\nname = name.replace(onRE, '')\nisDynamic = dynamicArgRE.test(name)\nif (isDynamic) {\nname = name.slice(1, -1)\n}\naddHandler(el, name, value, modifiers, false, warn, list[i], isDynamic)\n} else { // normal directives\nname = name.replace(dirRE, '')\n// parse arg\nconst argMatch = name.match(argRE)\nlet arg = argMatch && argMatch[1]\nisDynamic = false\nif (arg) {\nname = name.slice(0, -(arg.length + 1))\nif (dynamicArgRE.test(arg)) {\narg = arg.slice(1, -1)\nisDynamic = true\n}\n}\naddDirective(el, name, rawName, value, arg, isDynamic, modifiers, list[i])\nif (process.env.NODE_ENV !== 'production' && name === 'model') {\ncheckForAliasModel(el, value)\n}\n}\n} else {\n// literal attribute\nif (process.env.NODE_ENV !== 'production') {\nconst res = parseText(value, delimiters)\nif (res) {\nwarn(\n`${name}=\"${value}\":` +\n'Interpolation inside attributes has been removed. ' +\n'Use v-bind or the colon shorthand instead. For example, ' +\n'instead of <div id=\"{{ val }}\">, use <div :id=\"val\">.',\nlist[i]\n)\n}\n}\naddAttr(el, name, JSON.stringify(value), list[i])\nif (!el.component &&\nname === 'muted' &&\nplatformMustUseProp(el.tag, el.attrsMap.type, name)) {\naddProp(el, name, 'true', list[i])\n}\n}\n}\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br"),e("span",{staticClass:"line-number"},[s._v("91")]),e("br"),e("span",{staticClass:"line-number"},[s._v("92")]),e("br"),e("span",{staticClass:"line-number"},[s._v("93")]),e("br"),e("span",{staticClass:"line-number"},[s._v("94")]),e("br"),e("span",{staticClass:"line-number"},[s._v("95")]),e("br"),e("span",{staticClass:"line-number"},[s._v("96")]),e("br"),e("span",{staticClass:"line-number"},[s._v("97")]),e("br"),e("span",{staticClass:"line-number"},[s._v("98")]),e("br"),e("span",{staticClass:"line-number"},[s._v("99")]),e("br"),e("span",{staticClass:"line-number"},[s._v("100")]),e("br"),e("span",{staticClass:"line-number"},[s._v("101")]),e("br"),e("span",{staticClass:"line-number"},[s._v("102")]),e("br"),e("span",{staticClass:"line-number"},[s._v("103")]),e("br"),e("span",{staticClass:"line-number"},[s._v("104")]),e("br"),e("span",{staticClass:"line-number"},[s._v("105")]),e("br"),e("span",{staticClass:"line-number"},[s._v("106")]),e("br"),e("span",{staticClass:"line-number"},[s._v("107")]),e("br"),e("span",{staticClass:"line-number"},[s._v("108")]),e("br"),e("span",{staticClass:"line-number"},[s._v("109")]),e("br"),e("span",{staticClass:"line-number"},[s._v("110")]),e("br"),e("span",{staticClass:"line-number"},[s._v("111")]),e("br"),e("span",{staticClass:"line-number"},[s._v("112")]),e("br"),e("span",{staticClass:"line-number"},[s._v("113")]),e("br"),e("span",{staticClass:"line-number"},[s._v("114")]),e("br"),e("span",{staticClass:"line-number"},[s._v("115")]),e("br"),e("span",{staticClass:"line-number"},[s._v("116")]),e("br"),e("span",{staticClass:"line-number"},[s._v("117")]),e("br"),e("span",{staticClass:"line-number"},[s._v("118")]),e("br"),e("span",{staticClass:"line-number"},[s._v("119")]),e("br"),e("span",{staticClass:"line-number"},[s._v("120")]),e("br"),e("span",{staticClass:"line-number"},[s._v("121")]),e("br"),e("span",{staticClass:"line-number"},[s._v("122")]),e("br"),e("span",{staticClass:"line-number"},[s._v("123")]),e("br"),e("span",{staticClass:"line-number"},[s._v("124")]),e("br"),e("span",{staticClass:"line-number"},[s._v("125")]),e("br"),e("span",{staticClass:"line-number"},[s._v("126")]),e("br"),e("span",{staticClass:"line-number"},[s._v("127")]),e("br"),e("span",{staticClass:"line-number"},[s._v("128")]),e("br"),e("span",{staticClass:"line-number"},[s._v("129")]),e("br"),e("span",{staticClass:"line-number"},[s._v("130")]),e("br"),e("span",{staticClass:"line-number"},[s._v("131")]),e("br"),e("span",{staticClass:"line-number"},[s._v("132")]),e("br"),e("span",{staticClass:"line-number"},[s._v("133")]),e("br"),e("span",{staticClass:"line-number"},[s._v("134")]),e("br"),e("span",{staticClass:"line-number"},[s._v("135")]),e("br"),e("span",{staticClass:"line-number"},[s._v("136")]),e("br")])]),e("p",[e("strong",[s._v("initEvents 函数分析")])]),s._v(" "),e("p",[s._v("了解了以上过程之后，开始分析"),e("code",[s._v("initEvents")]),s._v("函数，该函数位于源码的"),e("code",[s._v("src/instance/events.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function initEvents (vm: Component) {\n    vm._events = Object.create(null)\n    vm._hasHookEvent = false\n    const listeners = vm.$options._parentListeners\n    if (listeners) {\n        updateComponentListeners(vm, listeners)\n    }\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("这个"),e("code",[s._v("updateComponentListeners")]),s._v("函数是什么呢？该函数定义如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function updateComponentListeners (\nvm: Component,\nlisteners: Object,\noldListeners: ?Object\n) {\ntarget = vm\nupdateListeners(listeners, oldListeners || {}, add, remove, createOnceHandler, vm)\ntarget = undefined\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[e("strong",[s._v("initInjections 函数分析")])]),s._v(" "),e("p",[s._v("从函数名字上来看，该函数是用来初始化实例中的"),e("code",[s._v("inject")]),s._v("选项的。说到"),e("code",[s._v("inject")]),s._v("选项，那必然离不开"),e("code",[s._v("provide")]),s._v("选项，这两个选项都是成对出现的，它们的作用是：鸡毛一个祖先组件向其所有子孙后代注入一个依赖，不论组件层次有多深，并在起上下游关系成立的时间始终生效。")]),s._v(" "),e("p",[e("code",[s._v("provide")]),s._v("选项应该是一个对象或返回一个对象的函数。该对象包含可注入其子孙的属性。在该对象中你可以使用 ES 2015 Symbols 作为 key，但是只在原生支持"),e("code",[s._v("Symbol")]),s._v("和"),e("code",[s._v("Reflect.ownKeys")]),s._v("的环境下可工作。")]),s._v(" "),e("p",[e("code",[s._v("inject")]),s._v("选项应该是：")]),s._v(" "),e("ul",[e("li",[s._v("一个字符串数组或")]),s._v(" "),e("li",[s._v("一个对象，对象的 key 是本地的绑定名，value 是：\n"),e("ul",[e("li",[s._v("在可用的注入")])])])]),s._v(" "),e("p",[e("code",[s._v("initInjections")]),s._v("函数的具体原理，该函数定义在位于源码的``中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function initInjections (vm: Component) {\nconst result = resolveInject(vm.\\$options.inject, vm)\nif (result) {\ntoggleObserving(false)\nObject.keys(result).forEach(key => {\n/\\* istanbul ignore else \\*/\nif (process.env.NODE_ENV !== 'production') {\ndefineReactive(vm, key, result[key], () => {\nwarn(\n`Avoid mutating an injected value directly since the changes will be` +\n`overwritten whenever the provided component re-renders.` +\n`injection being mutated: \"${key}\"`,\nvm\n)\n})\n} else {\ndefineReactive(vm, key, result[key])\n}\n})\ntoggleObserving(true)\n}\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[e("strong",[s._v("initState 函数分析")])]),s._v(" "),e("p",[s._v("这个函数是用来初始化实例状态的，主要包括"),e("code",[s._v("props")]),s._v("、"),e("code",[s._v("data")]),s._v("、"),e("code",[s._v("methods")]),s._v("、"),e("code",[s._v("computed")]),s._v("、"),e("code",[s._v("watch")]),s._v("，我们把这些选项称为实例的状态选项。也就是说，"),e("code",[s._v("initState")]),s._v("函数就是用来初始化这些状态的。")]),s._v(" "),e("p",[s._v("首先我们先来分析"),e("code",[s._v("initState")]),s._v("函数，该函数的定义位于源码的"),e("code",[s._v("src/core/instance/state.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function initState (vm: Component) {\n    vm._watchers = []\n    const opts = vm.$options\n    if (opts.props) initProps(vm, opts.props)\n    if (opts.methods) initMethods(vm, opts.methods)\n    if (opts.data) {\n        initData(vm)\n    } else {\n        observe(vm._data = {}, true)\n    }\n    if (opts.computed) initComputed(vm, opts.computed)\n    if (opts.watch && opts.watch !== nativeWatch) {\n        initWatch(vm, opts.watch)\n    }\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("p",[s._v("首先，给实例上新增了一个属性"),e("code",[s._v("_watchers")]),s._v("，用来存储当前实例中所有的"),e("code",[s._v("watcher")]),s._v("实例，无论是使用"),e("code",[s._v("vm.$watch")]),s._v("注册的"),e("code",[s._v("watcher")]),s._v("实例还是使用"),e("code",[s._v("watch")]),s._v("选项注册的"),e("code",[s._v("watcher")]),s._v("实例，都会被保存到该属性中。")]),s._v(" "),e("p",[e("code",[s._v("initProps")]),s._v("函数的定义位于源码的"),e("code",[s._v("src/core/instance/state.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('function initProps (vm: Component, propsOptions: Object) {\nconst propsData = vm.$options.propsData || {}\n  const props = vm._props = {}\n  // cache prop keys so that future props updates can iterate using Array\n  // instead of dynamic object key enumeration.\n  const keys = vm.$options.\\_propKeys = []\nconst isRoot = !vm.\\$parent\n// root instance props should be converted\nif (!isRoot) {\ntoggleObserving(false)\n}\nfor (const key in propsOptions) {\nkeys.push(key)\nconst value = validateProp(key, propsOptions, propsData, vm)\nif (process.env.NODE_ENV !== \'production\') {\nconst hyphenatedKey = hyphenate(key)\nif (isReservedAttribute(hyphenatedKey) ||\nconfig.isReservedAttr(hyphenatedKey)) {\nwarn(`"${hyphenatedKey}" is a reserved attribute and cannot be used as component prop.`,vm)\n}\ndefineReactive(props, key, value, () => {\nif (!isRoot && !isUpdatingChildComponent) {\nwarn(\n`Avoid mutating a prop directly since the value will be` +\n`overwritten whenever the parent component re-renders.` +\n`Instead, use a data or computed property based on the prop\'s` +\n`value. Prop being mutated: "${key}"`,\nvm\n)\n}\n})\n} else {\ndefineReactive(props, key, value)\n}\n    if (!(key in vm)) {\n        proxy(vm, `_props`, key)\n    }\n}\n    toggleObserving(true)\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br")])]),e("p",[s._v("可以看到，该函数接收两个参数：当前"),e("code",[s._v("Vue")]),s._v("实例和当前实例规范化后的"),e("code",[s._v("props")]),s._v("选项。")]),s._v(" "),e("p",[s._v("在函数内部首先定义了 4 个变量，分别是：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("const propsData = vm.$options.propsData || {}\nconst props = vm._props = {}\nconst keys = vm.$options._propKeys = []\nconst isRoot = !vm.$parent\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("propsData：父组件传入的真实"),e("code",[s._v("props")]),s._v("数据。")]),s._v(" "),e("li",[s._v("props：指向"),e("code",[s._v("vm._props")]),s._v("指针，所有设置到")]),s._v(" "),e("li",[s._v("keys：指向"),e("code",[s._v("vm.$options._propKeys")]),s._v("的指针，缓存")]),s._v(" "),e("li",[s._v("isRoot：当前组件是否为根组件。")])]),s._v(" "),e("p",[s._v("初始化"),e("code",[s._v("methods")]),s._v("相较而言就比较简单了，它的初始函数定义位于源码的"),e("code",[s._v("src/core/instance/state.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('\nfunction initMethods (vm: Component, methods: Object) {\n    const props = vm.$options.props\n    for (const key in methods) {\n        if (process.env.NODE_ENV !== \'production\') {\n            if (typeof methods[key] !== \'function\') {\n                warn(\n                    `Method "${key}" has type "${typeof methods[key]}" in the component definition.` +\n                    `Did you reference the function correctly?`,vm\n                )\n            }\n            if (props && hasOwn(props, key)) {\n                warn(\n                `Method "${key}" has already been defined as a prop.`,\n                vm\n                )\n            }\n            if ((key in vm) && isReserved(key)) {\n                warn(\n                `Method "${key}" conflicts with an existing Vue instance method.` +\n                `Avoid defining component methods that start with _ or $.`\n                )\n            }\n    }\n        vm[key] = typeof methods[key] !== \'function\' ? noop : bind(methods[key], vm)\n    }\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br")])]),e("p",[s._v("初始化"),e("code",[s._v("data")]),s._v("也比较简单，它的初始化函数定义位于源码的"),e("code",[s._v("src/core/instance/state.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nexport function initState (vm: Component) {\n    vm._watchers = []\n    const opts = vm.$options\n    if (opts.props) initProps(vm, opts.props)\n    if (opts.methods) initMethods(vm, opts.methods)\n    if (opts.data) {\n        initData(vm)\n    } else {\n        observe(vm._data = {}, true)\n    }\n    if (opts.computed) initComputed(vm, opts.computed)\n    if (opts.watch && opts.watch !== nativeWatch) {\n        initWatch(vm, opts.watch)\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("初始化"),e("code",[s._v("initComputed")]),s._v("的内部原理是怎样的。"),e("code",[s._v("initComputed")]),s._v("函数的定义位于源码的"),e("code",[s._v("src/core/instance/state.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nfunction initComputed (vm: Component, computed: Object) {\n    const watchers = vm._computedWatchers = Object.create(null)\n    const isSSR = isServerRendering()\n    for (const key in computed) {\n        const userDef = computed[key]\n        const getter = typeof userDef === 'function' ? userDef : userDef.get\n        if (process.env.NODE_ENV !== 'production' && getter == null) {\n            warn(\n            `Getter is missing for computed property \"${key}\".`,\n            vm\n            )\n        }\n\n        if (!isSSR) {\n            watchers[key] = new Watcher(\n                vm,\n                getter || noop,\n                noop,\n                computedWatcherOptions\n            )\n        }\n\n        if (!(key in vm)) {\n            defineComputed(vm, key, userDef)\n        } else if (process.env.NODE_ENV !== 'production') {\n            if (key in vm.$data) {\n                warn(`The computed property \"${key}\" is already defined in data.`, vm)\n            } else if (vm.$options.props && key in vm.$options.props) {\n                warn(`The computed property \"${key}\" is already defined as a prop.`, vm)\n            }\n        }\n    }\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br")])]),e("p",[s._v("初始化"),e("code",[s._v("watch")]),s._v("选项，在日常开发中"),e("code",[s._v("watch")]),s._v("选项也经常会使用到，它可以用来侦听某个已有的数据，当该数据发生变化时执行对应的回调函数。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nfunction initWatch (vm: Component, watch: Object) {\n    for (const key in watch) {\n        const handler = watch[key]\n        if (Array.isArray(handler)) {\n            for (let i = 0; i < handler.length; i++) {\n                createWatcher(vm, key, handler[i])\n            }\n        } else {\n            createWatcher(vm, key, handler)\n        }\n    }\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("h4",{attrs:{id:"_5-2-模板编译阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-模板编译阶段"}},[s._v("#")]),s._v(" 5.2 模板编译阶段")]),s._v(" "),e("h4",{attrs:{id:"_5-3-挂载阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-挂载阶段"}},[s._v("#")]),s._v(" 5.3 挂载阶段")]),s._v(" "),e("h4",{attrs:{id:"_5-4-销毁阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-销毁阶段"}},[s._v("#")]),s._v(" 5.4 销毁阶段")]),s._v(" "),e("h3",{attrs:{id:"六、实例方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六、实例方法"}},[s._v("#")]),s._v(" 六、实例方法")]),s._v(" "),e("ul",[e("li",[s._v("数据相关的方法")]),s._v(" "),e("li",[s._v("事件相关的方法")]),s._v(" "),e("li",[s._v("生命周期相关的方法")])]),s._v(" "),e("h4",{attrs:{id:"_6-1-数据相关的方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-数据相关的方法"}},[s._v("#")]),s._v(" 6.1 数据相关的方法")]),s._v(" "),e("p",[s._v("参考小节"),e("a",{attrs:{href:"#2.3-%E5%8F%98%E5%8C%96%E4%BE%A6%E6%B5%8B%E7%9A%84-API-%E5%AE%9E%E7%8E%B0"}},[s._v("变化侦测的 API 实现")])]),s._v(" "),e("h4",{attrs:{id:"_6-2-事件相关的方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-事件相关的方法"}},[s._v("#")]),s._v(" 6.2 事件相关的方法")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("vm.$on")])]),s._v(" "),e("li",[e("code",[s._v("vm.$emit")])]),s._v(" "),e("li",[e("code",[s._v("vm.$off")])]),s._v(" "),e("li",[e("code",[s._v("vm.$once")])])]),s._v(" "),e("p",[e("strong",[e("code",[s._v("vm.$on")])])]),s._v(" "),e("ul",[e("li",[e("p",[e("strong",[s._v("参数：")])]),s._v(" "),e("ul",[e("li",[e("code",[s._v("{string | Array<string>} event")]),s._v("(数组只在 2.2.0+中支持)")]),s._v(" "),e("li",[e("code",[s._v("{Function} callback")])])])]),s._v(" "),e("li",[e("p",[e("strong",[s._v("作用：")])])])]),s._v(" "),e("p",[s._v("内部原理：")]),s._v(" "),e("h4",{attrs:{id:"_6-3-生命周期相关的方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-生命周期相关的方法"}},[s._v("#")]),s._v(" 6.3 生命周期相关的方法")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("vm.$mount")])]),s._v(" "),e("li",[e("code",[s._v("vm.$forceUpdate")])]),s._v(" "),e("li",[e("code",[s._v("vm.$nextTick")])]),s._v(" "),e("li",[e("code",[s._v("vm.$destory")])])]),s._v(" "),e("h3",{attrs:{id:"七、全局-api-篇"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#七、全局-api-篇"}},[s._v("#")]),s._v(" 七、全局 API 篇")]),s._v(" "),e("p",[s._v("与实例方法不同，实例方法是将方法挂载到"),e("code",[s._v("Vue")]),s._v("的原型上，而全局 API 是直接在"),e("code",[s._v("Vue")]),s._v("上挂载方法。在"),e("code",[s._v("Vue")]),s._v("中，全局 API 一共有 12 个，分别是"),e("code",[s._v("Vue.extend")]),s._v("、"),e("code",[s._v("Vue.nextTick")]),s._v("、"),e("code",[s._v("Vue.set")]),s._v("、"),e("code",[s._v("Vue.delete")]),s._v("、"),e("code",[s._v("Vue.directive")]),s._v("、"),e("code",[s._v("Vue.filter")]),s._v("、"),e("code",[s._v("Vue.component")]),s._v("、"),e("code",[s._v("Vue.use")]),s._v("、"),e("code",[s._v("Vue.mixin")]),s._v("、"),e("code",[s._v("Vue.observable")]),s._v("、"),e("code",[s._v("Vue.version")]),s._v("。这 12 个 API 中有的是我们在日常业务开发中经常会用到的，有的是对 Vue 内部或外部插件提供的，我们在日常业务开发中几乎用不到。")]),s._v(" "),e("ol",[e("li",[s._v("Vue.extend")]),s._v(" "),e("li",[s._v("Vue.nextTick")]),s._v(" "),e("li",[s._v("Vue.set")]),s._v(" "),e("li",[s._v("Vue.delete")]),s._v(" "),e("li",[s._v("Vue.directive")]),s._v(" "),e("li",[s._v("Vue.filter")]),s._v(" "),e("li",[s._v("Vue.component")]),s._v(" "),e("li",[s._v("directive、filter、component 小结")]),s._v(" "),e("li",[s._v("Vue.use")]),s._v(" "),e("li",[s._v("Vue.mixin")]),s._v(" "),e("li",[s._v("Vue.compile")]),s._v(" "),e("li",[s._v("Vue.observable")]),s._v(" "),e("li",[s._v("Vue.version")])]),s._v(" "),e("h4",{attrs:{id:"_7-1-vue-extend"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-vue-extend"}},[s._v("#")]),s._v(" 7.1 Vue.extend")]),s._v(" "),e("p",[s._v("既然是"),e("code",[s._v("Vue")]),s._v("类的子类，那么除了它本身独有的一些属性方法，还有一些是从"),e("code",[s._v("Vue")]),s._v("类中继承而来，所以创建子类的过程其实就是一边给子类上添加上独有的属性，一边将父类的公共属性到子类上。接下来，我们就来看看源码是如何实现这个过程的。")]),s._v(" "),e("p",[s._v("该 API 的定义位于源码的"),e("code",[s._v("src/core/global-api/extend.js")]),s._v("中，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nVue.extend = function (extendOptions: Object): Function {\nextendOptions = extendOptions || {}\nconst Super = this\nconst SuperId = Super.cid\nconst cachedCtors = extendOptions.\\_Ctor || (extendOptions.\\_Ctor = {})\nif (cachedCtors[SuperId]) {\nreturn cachedCtors[SuperId]\n}\n\n    const name = extendOptions.name || Super.options.name\n    if (process.env.NODE_ENV !== 'production' && name) {\n        validateComponentName(name)\n    }\n\n    const Sub = function VueComponent (options) {\n        this._init(options)\n    }\n    Sub.prototype = Object.create(Super.prototype)\n    Sub.prototype.constructor = Sub\n    Sub.cid = cid++\n    Sub.options = mergeOptions(\n        Super.options,\n        extendOptions\n    )\n    Sub['super'] = Super\n\n    if (Sub.options.props) {\n        initProps(Sub)\n    }\n    if (Sub.options.computed) {\n        initComputed(Sub)\n    }\n\n    // allow further extension/mixin/plugin usage\n    Sub.extend = Super.extend\n    Sub.mixin = Super.mixin\n    Sub.use = Super.use\n\n    // create asset registers, so extended classes\n    // can have their private assets too.\n    ASSET_TYPES.forEach(function (type) {\n        Sub[type] = Super[type]\n    })\n    // enable recursive self-lookup\n    if (name) {\n        Sub.options.components[name] = Sub\n    }\n\n    Sub.superOptions = Super.options\n    Sub.extendOptions = extendOptions\n    Sub.sealedOptions = extend({}, Sub.options)\n\n    // cache constructor\n    cachedCtors[SuperId] = Sub\n    return Sub\n\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br")])]),e("h4",{attrs:{id:"_7-9-vue-use"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-9-vue-use"}},[s._v("#")]),s._v(" 7.9 Vue.use")]),s._v(" "),e("p",[s._v("该 API 的定义位于源码的"),e("code",[s._v("src/core/global-api/use.js")]),s._v("中，代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\nVue.use = function (plugin) {\nconst installedPlugins = (this.\\_installedPlugins || (this.\\_installedPlugins = []))\nif (installedPlugins.indexOf(plugin) > -1) {\nreturn this\n}\n\n    // additional parameters\n    const args = toArray(arguments, 1)\n    args.unshift(this)\n    if (typeof plugin.install === 'function') {\n        plugin.install.apply(plugin, args)\n    } else if (typeof plugin === 'function') {\n        plugin.apply(null, args)\n    }\n    installedPlugins.push(plugin)\n    return this\n\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("h3",{attrs:{id:"八、过滤器篇"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#八、过滤器篇"}},[s._v("#")]),s._v(" 八、过滤器篇")]),s._v(" "),e("h3",{attrs:{id:"九、指令篇"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#九、指令篇"}},[s._v("#")]),s._v(" 九、指令篇")]),s._v(" "),e("h3",{attrs:{id:"十、总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#十、总结"}},[s._v("#")]),s._v(" 十、总结")]),s._v(" "),e("p",[e("img",{attrs:{src:"vue-code.png",alt:"images"}})]),s._v(" "),e("h3",{attrs:{id:"参考资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://github.com/muwoo/blogs",target:"_blank",rel:"noopener noreferrer"}},[s._v("vue 源码分析"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"http://hcysun.me/vue-design/art/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Vue 技术内幕"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://ustbhuangyi.github.io/vue-analysis/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Vue.js 技术揭秘"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/answershuto/learnVue",target:"_blank",rel:"noopener noreferrer"}},[s._v("Vue.js 源码解析"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/dirkhe1051931999/hjBlog/tree/master/blog-vue-sourcecode-study",target:"_blank",rel:"noopener noreferrer"}},[s._v("你想要的 vue 源码分析"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://juejin.im/post/5ce5565d6fb9a07ed2244513",target:"_blank",rel:"noopener noreferrer"}},[s._v("学习 Vue 源码的必要知识储备"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://nlrx-wjc.github.io/Learn-Vue-Source-Code/start/",target:"_blank",rel:"noopener noreferrer"}},[s._v("逐行剖析 Vue.js 源码"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"http://hcysun.me/vue-design/zh/",target:"_blank",rel:"noopener noreferrer"}},[s._v("渲染器"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/tugenhua0707/category/1577630.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("深入 Vue 技术栈及源码系列"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"http://www.zhufengpeixun.cn/train/vue-info/source.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Vue 原理剖析"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/lihongxun945/myblog/issues/22",target:"_blank",rel:"noopener noreferrer"}},[s._v("Vue2.x 源码解析系列一：我的源码阅读心得"),e("OutboundLink")],1)]),s._v(" "),e("li",[s._v("《深入浅出 Vue.js》")])]),s._v(" "),e("h2",{attrs:{id:"联系作者"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#联系作者"}},[s._v("#")]),s._v(" 联系作者")]),s._v(" "),e("div",{attrs:{align:"center"}},[e("p",[s._v("\n        平凡世界，贵在坚持。\n    ")]),s._v(" "),e("img",{attrs:{src:s.$withBase("/about/contact.png")}})]),s._v("\n```\n")])}),[],!1,null,null,null);n.default=t.exports}}]);