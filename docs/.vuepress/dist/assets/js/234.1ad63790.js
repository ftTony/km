(window.webpackJsonp=window.webpackJsonp||[]).push([[234],{459:function(t,r,a){"use strict";a.r(r);var _=a(13),v=Object(_.a)({},(function(){var t=this,r=t.$createElement,a=t._self._c||r;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"流量劫持"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流量劫持"}},[t._v("#")]),t._v(" 流量劫持")]),t._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("本人平时学习及收集内容，欢迎参入一起讨论。")]),t._v(" "),a("h2",{attrs:{id:"内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#内容"}},[t._v("#")]),t._v(" 内容")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E4%B8%80%E3%80%81dns%E5%8A%AB%E6%8C%81"}},[t._v("DNS劫持")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E4%BA%8C%E3%80%81dns-%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"}},[t._v("DNS 是如何工作的")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E4%B8%89%E3%80%81%E5%A6%82%E4%BD%95%E6%B1%A1%E6%9F%93-dns"}},[t._v("如何污染 DNS")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E5%9B%9B%E3%80%81%E5%A6%82%E4%BD%95%E6%8A%B5%E5%BE%A1dns%E5%8A%AB%E6%8C%81"}},[t._v("如何抵御DNS劫持")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E4%BA%94%E3%80%81dns-%E5%8A%AB%E6%8C%81%E6%80%BB%E7%BB%93"}},[t._v("DNS 劫持总结")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E5%85%AD%E3%80%81%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81"}},[t._v("数据劫持")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E4%B8%83%E3%80%81%E5%A6%82%E4%BD%95%E6%8A%B5%E5%BE%A1%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81"}},[t._v("如何抵御数据劫持")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E5%85%AB%E3%80%81%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81%E6%80%BB%E7%BB%93"}},[t._v("数据劫持总结")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E4%B9%9D%E3%80%81%E7%8E%B0%E6%9C%89%E6%96%B9%E6%A1%88"}},[t._v("现有方案")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#%E5%8D%81%E3%80%81%E5%85%B6%E4%BB%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"}},[t._v("其他解决方案")])])]),t._v(" "),a("h3",{attrs:{id:"一、dns劫持"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、dns劫持"}},[t._v("#")]),t._v(" 一、DNS劫持")]),t._v(" "),a("p",[t._v("域名劫持是互联网攻击的一种方式，通过攻击DNS服务器，或伪造DNS服务器的方法，"),a("strong",[t._v("把目标网站域名解析到错误的地址")]),t._v("让用户无法访问到真正的地址。")]),t._v(" "),a("h3",{attrs:{id:"二、dns-是如何工作的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、dns-是如何工作的"}},[t._v("#")]),t._v(" 二、DNS 是如何工作的")]),t._v(" "),a("p",[t._v("客户端访问服务端，首先要根据域名获取到对应的IP地址，这一步需要从DNS服务器上获取。请求DNS服务器时，会通过UDP协议在当地网络运营商提供的公共域名服务器中查找IP，如果没有找到，就会继续请求上一级的域名服务器来查找，直到返回IP地址为止。域名劫持，即是在请求DNS解析域名时出现问题，目标目标域名被恶意地解析到其他IP地址，造成用户无法正常使用服务。")]),t._v(" "),a("p",[t._v("为了减少DNS查询时间，HTTP协议栈中会缓存域名解析：")]),t._v(" "),a("ul",[a("li",[t._v("浏览器可能会缓存域名解析。")]),t._v(" "),a("li",[t._v("用户系统中的域名映射表(Hosts)会缓存域名解析。")]),t._v(" "),a("li",[t._v("公共域名服务器通常由ISP（互联网服务提供商）提供。\n"),a("ul",[a("li",[t._v("公共应用服务器会缓存上一级域名服务器的结果。")]),t._v(" "),a("li",[t._v("公共域名服务器TTL到期后，会向顶级域名服务器获取信息。")])])])]),t._v(" "),a("h3",{attrs:{id:"三、如何污染-dns"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、如何污染-dns"}},[t._v("#")]),t._v(" 三、如何污染 DNS")]),t._v(" "),a("p",[t._v("常见的污染DNS方式有：")]),t._v(" "),a("ul",[a("li",[t._v("篡改Hosts文件。")]),t._v(" "),a("li",[t._v("污染中间链路设备(路由器等)。\n"),a("ul",[a("li",[t._v("修改UDP内容，影响DNS查询结果。")])])]),t._v(" "),a("li",[t._v("入侵DNS服务器（攻击成本高）。")])]),t._v(" "),a("h3",{attrs:{id:"四、如何抵御dns劫持"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、如何抵御dns劫持"}},[t._v("#")]),t._v(" 四、如何抵御DNS劫持")]),t._v(" "),a("p",[t._v("解决域名劫持的一个办法就是绕开安全性较差的UDP协议，通过一个可信的源头来解析域名，解析方式不需要拘泥于UDP协议，也可以通过HTTP的方式。")]),t._v(" "),a("ul",[a("li",[t._v("DNS over HTTPS\n"),a("ul",[a("li",[t._v("在TLS协议之上传输DNS内容。")])])]),t._v(" "),a("li",[t._v("DNS over HTTP\n"),a("ul",[a("li",[t._v("用HTTP协议来传输DNS。")])])]),t._v(" "),a("li",[t._v("DNS over HTTPS\n"),a("ul",[a("li",[t._v("用HTTPS协议来传输DNS。")])])]),t._v(" "),a("li",[t._v("使用自己维护的DNS服务器（成本太大）。")])]),t._v(" "),a("h3",{attrs:{id:"五、dns-劫持总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、dns-劫持总结"}},[t._v("#")]),t._v(" 五、DNS 劫持总结")]),t._v(" "),a("p",[t._v("一般使用http-dns绕过运营商解析域名，达到防止DNS劫持的目的，一些大厂还可以自己维护权威域名服务器，防止支持。")]),t._v(" "),a("blockquote",[a("p",[t._v("DNS劫持是属于违法行为，已经被严厉打击，很少见了。")])]),t._v(" "),a("h3",{attrs:{id:"六、数据劫持"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#六、数据劫持"}},[t._v("#")]),t._v(" 六、数据劫持")]),t._v(" "),a("p",[t._v("数据劫持基本针对明文传输的内容发生。用户发起HTTP请求，服务器返回页面内容时，经过中间的运营商网络，页面内容被篡改或加塞内容，强行弹窗或者广告。")]),t._v(" "),a("h3",{attrs:{id:"七、如何抵御数据劫持"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#七、如何抵御数据劫持"}},[t._v("#")]),t._v(" 七、如何抵御数据劫持")]),t._v(" "),a("p",[t._v("行业内解决的办法即是对内容进行HTTPS加密，实现密文传输，彻底避免劫持问题。MD5校验同样能起到防止数据劫持的作用，MD5校验是指内容返回前，应用层对返回的数据进行校验，生成校验值；同时，内容接收方接收到内容后，对内容进行校验，同样生成校验值，将这两个校验值进行比对，倘若一致，则可以判断数据无劫持。")]),t._v(" "),a("blockquote",[a("p",[t._v("HTTPS也能被运营商劫持\n1、伪造证书，通过病毒或者其他方式将伪造证书的根证书安装在用户系统中（较少）。\n2、代码也有客户的证书与私钥，或者客户商与代理认证的时候不校验合法性，即可通过代理来与我们服务端进行数据交互（较多）。")])]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#_71-content-security-policy-csp"}},[t._v("Content-Security-Policy (CSP)")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#_72-subresource-integrity-sri"}},[t._v("Subresource Integrity (SRI)")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#_73-http-strict-transport-security"}},[t._v("HTTP Strict-Transport-Security")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#_74-x-frame-options"}},[t._v("X-FRAME-OPTIONS")])])]),t._v(" "),a("h4",{attrs:{id:"_7-1-content-security-policy-csp"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-content-security-policy-csp"}},[t._v("#")]),t._v(" 7.1 Content-Security-Policy (CSP)")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy__by_cnvoid",target:"_blank",rel:"noopener noreferrer"}},[t._v("Content-Security-Policy"),a("OutboundLink")],1),t._v("的实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，等同于提供白名单。它的实现和执行全部由浏览器完成，开发者只需提供配置。")]),t._v(" "),a("ul",[a("li",[t._v("指定每种资源类型可以加载执行的条件。")]),t._v(" "),a("li",[t._v("还可以防御XSS攻击。")]),t._v(" "),a("li",[t._v("也可以于强近资源使用HTTPS加载，降低劫持可能性。")])]),t._v(" "),a("p",[t._v("两种方式开启CSP：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('// 通过http头信息Content-Security-Policy: default-src https:\n\n// 通过meta标签<meta http-equiv="Content-Security-Policy" content="default-src https:"/>\n\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("缺点：")]),t._v(" "),a("ul",[a("li",[t._v("由于CSP标识本身存在于HTML标签或者HTTP请求头中，可以被攻击者可以直接移除掉。")]),t._v(" "),a("li",[t._v("规则比较复杂。")]),t._v(" "),a("li",[t._v("影响动态创建的使用。")])]),t._v(" "),a("h4",{attrs:{id:"_7-2-subresource-integrity-sri"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-subresource-integrity-sri"}},[t._v("#")]),t._v(" 7.2 Subresource Integrity (SRI)")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/Security/%E5%AD%90%E8%B5%84%E6%BA%90%E5%AE%8C%E6%95%B4%E6%80%A7",target:"_blank",rel:"noopener noreferrer"}},[t._v("Subresource Integrity"),a("OutboundLink")],1),t._v("允许浏览器检查其获得的资源（例如从CDN获得的）是否被篡改的一项安全特性。")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('<script crossorigin="anonymous" integrity=“sha256-+Ec97...E=“ src=“https://a.com"><\/script>\n\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("缺点：")]),t._v(" "),a("ul",[a("li",[t._v("由于SRI标识本身存在于HTML标签中，可以被攻击者可以直接移除掉。")]),t._v(" "),a("li",[t._v("影响动态创建脚本的使用。")]),t._v(" "),a("li",[t._v("校验失败时影响可用性。")]),t._v(" "),a("li",[t._v("兼容性有限，IOS Safari不支持。")])]),t._v(" "),a("h4",{attrs:{id:"_7-3-http-strict-transport-security"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-http-strict-transport-security"}},[t._v("#")]),t._v(" 7.3 HTTP Strict-Transport-Security")]),t._v(" "),a("p",[t._v("在HTTPS响应报文的头部中，增加一个名为"),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Security/HTTP_Strict_Transport_Security",target:"_blank",rel:"noopener noreferrer"}},[t._v("Strict-Transport-Security"),a("OutboundLink")],1),t._v("(HSTS)的头，内容是这个头的有效期。当浏览器在HTTPS响应中看到它时，"),a("strong",[t._v("下一次浏览器会直接使用HTTPS来进行请求")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Strict-Transport-Security: max-age=<expire-time>\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("缺点：")]),t._v(" "),a("ul",[a("li",[t._v("只有HTTPS的响应才会去识别HSTS。")]),t._v(" "),a("li",[t._v("用户的第一次访问不受控。")])]),t._v(" "),a("h4",{attrs:{id:"_7-4-x-frame-options"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-4-x-frame-options"}},[t._v("#")]),t._v(" 7.4 X-FRAME-OPTIONS")]),t._v(" "),a("p",[t._v("X-FRAME-OPTIONS 是一个HTTP响应头，在现代浏览器有一个很好的支持。网站可以使用此功能，来确保自己网站的内容没有被嵌到别人的网站中去，也从而避免了点击劫持的攻击。")]),t._v(" "),a("p",[t._v("该响应头有三个值可选，分别是：")]),t._v(" "),a("ul",[a("li",[t._v("DENY，表示页面不允许通过Iframe的方式展示。")]),t._v(" "),a("li",[t._v("SAMEORIGIN，表示页面可以在相同域名下通过Iframe的方式展示。")]),t._v(" "),a("li",[t._v("ALLOW-FROM，表示页面可以在指定来源的Iframe中展示。")])]),t._v(" "),a("h3",{attrs:{id:"八、数据劫持总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#八、数据劫持总结"}},[t._v("#")]),t._v(" 八、数据劫持总结")]),t._v(" "),a("ul",[a("li",[t._v("使用CSP限制外部JS文件加载。")]),t._v(" "),a("li",[t._v("使用HTTPS加密传输数据，确保内容保密。")]),t._v(" "),a("li",[t._v("使用SRI校验文件一致性。")]),t._v(" "),a("li",[t._v("使用HSTS强制用户使用HTTPS访问。")]),t._v(" "),a("li",[t._v("使用X-Frame-Options确保页面不被嵌入iframe。")])]),t._v(" "),a("blockquote",[a("p",[t._v("以上方法都只能起到监控数据劫持作用，并不能对劫持后的页面进行修复。")])]),t._v(" "),a("h3",{attrs:{id:"九、现有方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#九、现有方案"}},[t._v("#")]),t._v(" 九、现有方案")]),t._v(" "),a("p",[t._v("此方案参考了着墨点评2018前端分享上的防治方案。")]),t._v(" "),a("ul",[a("li",[t._v("方案A：在某些省份、地区创建监测站，定期抓取固定资源（资源太固定，监测站数量也远远不够）。")]),t._v(" "),a("li",[t._v("方案B：业务A在自己的HTML中监听资源的Error事件（方法确认问题在于劫持，也可能只是普通的JS出错）。")]),t._v(" "),a("li",[t._v("方案C：使用第三方企业服务进监控（服务越多成本越大）。")]),t._v(" "),a("li",[t._v("方案D：CSP、SRI（兼容性和灵活性差，方法进行定义逻辑）。")])]),t._v(" "),a("p",[t._v("以述方案可以看出，无论哪种方案，都有它的不足，于是搭建了下图方案：")]),t._v(" "),a("p",[a("img",{attrs:{src:"osi-hijack-meituan.png",alt:"img"}})]),t._v(" "),a("p",[t._v("优势如下：")]),t._v(" "),a("ul",[a("li",[t._v("监控的级别是业务级甚至页面级，而不是某个固定的资源。")]),t._v(" "),a("li",[t._v("在业务方的Node.js中内置逻辑，给予了业务方自己进行降级和响应的能力。")]),t._v(" "),a("li",[t._v("监控层如果出现故障，不影响业务方的代码执行。")])]),t._v(" "),a("h3",{attrs:{id:"十、其他解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#十、其他解决方案"}},[t._v("#")]),t._v(" 十、其他解决方案")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#_10-1-app%E7%AB%AF%E9%87%87%E7%94%A8hyhrid%E6%96%B9%E6%A1%88%E5%8A%A0%E8%BD%BDwebview"}},[t._v("APP端采用Hyhrid方案加载Webview")])]),t._v(" "),a("li",[a("a",{attrs:{href:"#_10-2-%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83"}},[t._v("业务代码规范")])])]),t._v(" "),a("h4",{attrs:{id:"_10-1-app端采用hyhrid方案加载webview"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-1-app端采用hyhrid方案加载webview"}},[t._v("#")]),t._v(" 10.1 APP端采用Hyhrid方案加载Webview")]),t._v(" "),a("p",[t._v("App里的Webview不直接请求一个链接，而先下载一个Download.zip文件，解压后App内部直接渲染，越过了HTTP层面，从而避免数据被劫持。")]),t._v(" "),a("h4",{attrs:{id:"_10-2-业务代码规范"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-业务代码规范"}},[t._v("#")]),t._v(" 10.2 业务代码规范")]),t._v(" "),a("ol",[a("li",[t._v("在页面DOM中定义一个根元素Root，所有的业务代码都在这里，页面渲染完毕后，直接清理掉非Root元素目录下的其他元素。")]),t._v(" "),a("li",[t._v("Script标签打上自定义属性，页面渲染时，把没有打自定义属性的删掉。")]),t._v(" "),a("li",[t._v("MutationObserver监听DOM插入，如果是非法JS或HTML，则阻止。")]),t._v(" "),a("li",[t._v("将搜集到的错误进行上报。")])]),t._v(" "),a("ul",[a("li",[t._v("上报是否被套在Iframe。")]),t._v(" "),a("li",[t._v("上报是否有其他代码被插入。")]),t._v(" "),a("li",[t._v("上报被CSP屏蔽的外部链接。")]),t._v(" "),a("li",[t._v("附带上传客户UID等。")])]),t._v(" "),a("h3",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[t._v("#")]),t._v(" 参考资料")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://lmjben.github.io/blog/osi-hijack.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("流量劫持"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"联系作者"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#联系作者"}},[t._v("#")]),t._v(" 联系作者")]),t._v(" "),a("div",{attrs:{align:"center"}},[a("p",[t._v("\n        平凡世界，贵在坚持。\n    ")]),t._v(" "),a("img",{attrs:{src:t.$withBase("/about/contact.png")}})])])}),[],!1,null,null,null);r.default=v.exports}}]);