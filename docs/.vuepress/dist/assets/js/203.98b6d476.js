(window.webpackJsonp=window.webpackJsonp||[]).push([[203],{422:function(n,s,e){"use strict";e.r(s);var a=e(13),t=Object(a.a)({},(function(){var n=this,s=n.$createElement,e=n._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[e("h1",{attrs:{id:"虚拟-dom-解析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#虚拟-dom-解析"}},[n._v("#")]),n._v(" 虚拟 DOM 解析")]),n._v(" "),e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[n._v("#")]),n._v(" 前言")]),n._v(" "),e("p",[n._v("本人平时学习及收集内容，欢迎参入一起讨论。")]),n._v(" "),e("h2",{attrs:{id:"内容"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#内容"}},[n._v("#")]),n._v(" 内容")]),n._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"#%E4%B8%80%E3%80%81%E8%99%9A%E6%8B%9F-DOM-%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"}},[n._v("虚拟 DOM 的优缺点")])]),n._v(" "),e("li",[e("a",{attrs:{href:"#%E4%BA%8C%E3%80%81%E8%99%9A%E6%8B%9F-DOM-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"}},[n._v("虚拟 DOM 的实现原理")])]),n._v(" "),e("li",[e("a",{attrs:{href:"#%E4%B8%89%E3%80%81%60JS%60%E5%AF%B9%E8%B1%A1%E6%A8%A1%E6%8B%9F%60DOM%60%E6%A0%91"}},[e("code",[n._v("JS")]),n._v("对象模拟"),e("code",[n._v("DOM")]),n._v("树")])]),n._v(" "),e("li",[e("a",{attrs:{href:"#%E5%9B%9B%E3%80%81diff-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0"}},[n._v("diff 算法实现")])]),n._v(" "),e("li",[e("a",{attrs:{href:"#%E4%BA%94%E3%80%81pach-%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0"}},[n._v("pach 方法实现")])]),n._v(" "),e("li",[e("a",{attrs:{href:"#%E5%85%AD%E3%80%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"}},[n._v("源码分析")])])]),n._v(" "),e("h3",{attrs:{id:"一、虚拟-dom-的优缺点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、虚拟-dom-的优缺点"}},[n._v("#")]),n._v(" 一、虚拟 DOM 的优缺点")]),n._v(" "),e("ul",[e("li",[n._v("优点")]),n._v(" "),e("li",[n._v("缺点")])]),n._v(" "),e("h4",{attrs:{id:"优点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优点"}},[n._v("#")]),n._v(" 优点")]),n._v(" "),e("ul",[e("li",[e("strong",[n._v("保证性能下限")]),n._v("：框架的虚拟 DOM 需要甜酸任何上层 API 可能产生的操作，它的一些 DOM 操作的实现必须是普适的，所以它的性能并不是最优的；但是比起粗暴的 DOM 操作性能要好很多，因此框架的虚拟 DOM 至少可以保证在你不需要手动优化的情况下，依然可以提供还不错的性能，即保证性能的下限；")]),n._v(" "),e("li",[e("strong",[n._v("无需手动操作 DOM")]),n._v("：我们不再需要手动去操作 DOM，只需要写好 View-Model 的代码逻辑，框架会根据虚拟 DOM 和数据双向绑定，帮我们以可预期的方式更新视图，极大提高我们的开发效率；")]),n._v(" "),e("li",[e("strong",[n._v("跨平台")]),n._v("：虚拟 DOM 本质上是 JavaScript 对象，而 DOM 与平台强相关，相比之下虚拟 DOM 可以进行更方便地跨平台操作，例如服务器渲染、weex 开发等等。")])]),n._v(" "),e("h4",{attrs:{id:"缺点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#缺点"}},[n._v("#")]),n._v(" 缺点")]),n._v(" "),e("ul",[e("li",[e("strong",[n._v("无法进行极致优化")]),n._v("：虽然虽然虚拟 DOM+合理的优化，足以应对绝大部分应用的性能需求，但在一些性能要求极高的应用中虚拟 DOM 无法进行针对性的极致优化。")])]),n._v(" "),e("h3",{attrs:{id:"二、虚拟-dom-的实现原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、虚拟-dom-的实现原理"}},[n._v("#")]),n._v(" 二、虚拟 DOM 的实现原理")]),n._v(" "),e("p",[n._v("虚拟 DOM 的实现原理主要包括以下 3 部分：")]),n._v(" "),e("ul",[e("li",[n._v("用 JavaScript 对象模拟真实 DOM 树，对真实 DOM 进行抽象；")]),n._v(" "),e("li",[n._v("diff 算法 — 比较两棵虚拟 DOM 树的差异；")]),n._v(" "),e("li",[n._v("pach 算法 — 将两个虚拟 DOM 对象的差异应用到真正的 DOM 树。")])]),n._v(" "),e("h3",{attrs:{id:"三、js对象模拟dom树"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、js对象模拟dom树"}},[n._v("#")]),n._v(" 三、"),e("code",[n._v("JS")]),n._v("对象模拟"),e("code",[n._v("DOM")]),n._v("树")]),n._v(" "),e("p",[n._v("用 JavaScript 来表示一个 DOM 节点是很简单的事情，你只需要记录它的节点类型、属性，还有子节点：")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("function Element(tagName,props,children){\n    if(!(this instanceof Element)){\n        if(!_.isArray(children) && children !=null){\n            children = _.slice(arguments,2).filter(_.truthy)\n        }\n        return new Element(tagName,props,children)\n    }\n\n    if(_.isArray(props)){\n        children = props\n        props = {}\n    }\n\n    this.tagName = tagName\n    this.props = props || {}\n    this.chilren = children || []\n    this.key = props ? props.key: 666\n\n    var count = 0\n\n    _.each(this.children,function(child,i){\n        if(child instanceof Element){\n            count += child.count\n        }else{\n            children[i] = '' +child\n        }\n        count++\n    })\n\n    this.count = count\n}\n\nElement.prototype.render = function(){\n    var el = document.createElement(this.tagName)\n    var props = this.props\n\n    for(var propName in props){\n        var propValue = props[propName]\n        _.setAttr(el,propName,propValue)\n    }\n\n    _.each(this.children,function(child){\n        var childEl = (child instanceof Element)?child.render():document.createTextNode(child)\n        el.appendChild(childEl)\n    })\n\n    return el\n}\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br"),e("span",{staticClass:"line-number"},[n._v("35")]),e("br"),e("span",{staticClass:"line-number"},[n._v("36")]),e("br"),e("span",{staticClass:"line-number"},[n._v("37")]),e("br"),e("span",{staticClass:"line-number"},[n._v("38")]),e("br"),e("span",{staticClass:"line-number"},[n._v("39")]),e("br"),e("span",{staticClass:"line-number"},[n._v("40")]),e("br"),e("span",{staticClass:"line-number"},[n._v("41")]),e("br"),e("span",{staticClass:"line-number"},[n._v("42")]),e("br"),e("span",{staticClass:"line-number"},[n._v("43")]),e("br"),e("span",{staticClass:"line-number"},[n._v("44")]),e("br"),e("span",{staticClass:"line-number"},[n._v("45")]),e("br"),e("span",{staticClass:"line-number"},[n._v("46")]),e("br"),e("span",{staticClass:"line-number"},[n._v("47")]),e("br"),e("span",{staticClass:"line-number"},[n._v("48")]),e("br")])]),e("h3",{attrs:{id:"四、diff-算法实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、diff-算法实现"}},[n._v("#")]),n._v(" 四、diff 算法实现")]),n._v(" "),e("ul",[e("li",[n._v("深度优先遍历，记录差异")]),n._v(" "),e("li",[n._v("差异类型")]),n._v(" "),e("li",[n._v("列表对比算法")])]),n._v(" "),e("p",[e("code",[n._v("diff")]),n._v("算法用来比较两棵"),e("code",[n._v("Virtual DOM")]),n._v("树的差异，如果需要两棵树的完全比较，那么"),e("code",[n._v("diff")]),n._v("算法的时间复杂为"),e("code",[n._v("O(n^3)")]),n._v("。但是前端当中，你很少会跨越层级地移动"),e("code",[n._v("DOM")]),n._v("元素，所以"),e("code",[n._v("Virtual DOM")]),n._v("只会对同一个层级的元素进行对比，如下图所示，")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("function diff(oldTree,newTree){\n    var index= 0\n    var patches = {}\n    dfsWalk(oldTree,newTree,index,patches)\n    return patches\n}\n\nfunction dfsWalk(){\n    var currentPatch = []\n    if(typeof (oldNode) === 'string' && typeof (newNode) === 'string'){\n        // 文本内容改变\n        if(newNode !== oldNode){\n            currentPath.push({type:patch.TEXT,content:newNode})\n        }\n    }else if(newNode!==null && oldNode.tagName === newNode.tagName && oldNode.key === newNode.key){\n        // 节点相同，比较属性\n        var propsPatches = diffProps(oldNode,newNode)\n        if(propsPatches){\n            currentPatch.push({type:patch.PROPS,props:propsPatches})\n        }\n\n        // 比较子节点，如果子节点有'ignore'属性，则不需要比较\n        if(!isIgnoreChild(newNode)){\n            diffChildren(oldNode.children,newNode.children,index,patches,currentPatch)\n        }\n    }else if(newNode!==null){\n        // 新节点和旧节点不同，用replace替换\n        currentPatch.push({type:patch.REPLACE,node:newNode})\n    }\n\n    if(currentPatch.length){\n        patches[index] = currentPatch\n    }\n}\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br")])]),e("h3",{attrs:{id:"_4-2-差异类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-差异类型"}},[n._v("#")]),n._v(" 4.2 差异类型")]),n._v(" "),e("p",[e("code",[n._v("DOM")]),n._v(" 操作导致的差异类型包括以下几种：")]),n._v(" "),e("ul",[e("li",[n._v("节点替换：节点改变了，例如将上面的"),e("code",[n._v("div")]),n._v("换成"),e("code",[n._v("h1")]),n._v("；")]),n._v(" "),e("li",[n._v("顺序互换：移动、删除、新增子节点，例如上面"),e("code",[n._v("div")]),n._v("的子节点，把"),e("code",[n._v("p")]),n._v("和"),e("code",[n._v("ul")]),n._v("顺序互换；")]),n._v(" "),e("li",[n._v("属性更改：修改了节点的属性，例如把上面"),e("code",[n._v("li")]),n._v("的"),e("code",[n._v("class")]),n._v("样式类删除；")]),n._v(" "),e("li",[n._v("文本改变：改变文本节点的文本内容，例如将上面"),e("code",[n._v("p")]),n._v("节点的文本内容理性为"),e("code",[n._v("Real DOM")]),n._v("；")])]),n._v(" "),e("p",[n._v("以上描述的几种差异类型在代码中定义如下所示：")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("var REPLACE = 0 // 替换原先的节点\nvar REORDER = 1 // 重新排序\nvar PROPS = 2 // 修改了节点的属性\nvar TEXT = 3 // 文本内容改变\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br")])]),e("h4",{attrs:{id:"_4-3-差异类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-差异类型"}},[n._v("#")]),n._v(" 4.3 差异类型")]),n._v(" "),e("h3",{attrs:{id:"五、pach-方法实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五、pach-方法实现"}},[n._v("#")]),n._v(" 五、pach 方法实现")]),n._v(" "),e("ul",[e("li",[n._v("深度优先遍历"),e("code",[n._v("DOM")]),n._v("树")]),n._v(" "),e("li",[n._v("对原有"),e("code",[n._v("DOM")]),n._v("树进行"),e("code",[n._v("DOM")]),n._v("操作")]),n._v(" "),e("li",[n._v("DOM 结构改变")])]),n._v(" "),e("h4",{attrs:{id:"_5-1-深度优先遍历-dom-树"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-深度优先遍历-dom-树"}},[n._v("#")]),n._v(" 5.1 深度优先遍历 DOM 树")]),n._v(" "),e("p",[n._v("所构建的"),e("code",[n._v("JavaScript")]),n._v("对象树和"),e("code",[n._v("render")]),n._v("出来真正的"),e("code",[n._v("DOM")]),n._v("树的信息、结构是一样的。所以我们可以对那棵"),e("code",[n._v("DOM")]),n._v("树也进行深度优先的遍历，遍历的时候从上一个步骤生成的"),e("code",[n._v("patches")]),n._v("对象中找出当前遍历的节点差异")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("function patch(node,patches){\n    var walker = {index: 0}\n    dfsWalk(node,walker,patches)\n}\n\nfunction dfsWalk(node,walker,patches){\n    // 从patches拿出当前节点的差异\n    var currentPatches = patches[walker.index]\n\n    var len = node.childNodes ? node.childNodes.length:0\n\n    // 深度遍历子节点\n    for(var i = 0; i< len;i++){\n        var child = node.childNodes[i]\n        walker.index++\n        dfsWalk(child,walker,patches)\n    }\n    // 对当前节点进行DOM操作\n    if(currentPatches){\n        applyPatches(node,currentPatches)\n    }\n}\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br")])]),e("h4",{attrs:{id:"_5-2-对原有-dom-树进行-dom-操作"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-对原有-dom-树进行-dom-操作"}},[n._v("#")]),n._v(" 5.2 对原有 DOM 树进行 DOM 操作")]),n._v(" "),e("p",[n._v("applyPathes,根据不同类型的差异对当前节点进行 DOM 操作：")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("function applyPatches (node, currentPatches) {\n  currentPatches.forEach(function (currentPatch) {\n    switch (currentPatch.type) {\n      case REPLACE:\n        node.parentNode.replaceChild(currentPatch.node.render(), node)\n        break\n      case REORDER:\n        reorderChildren(node, currentPatch.moves)\n        break\n      case PROPS:\n        setProps(node, currentPatch.props)\n        break\n      case TEXT:\n        node.textContent = currentPatch.content\n        break\n      default:\n        throw new Error('Unknown patch type ' + currentPatch.type)\n    }\n  })\n}\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br")])]),e("h4",{attrs:{id:"_5-3-dom-结构改变"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-dom-结构改变"}},[n._v("#")]),n._v(" 5.3 DOM 结构改变")]),n._v(" "),e("p",[n._v("通过将上一步骤得到的两个"),e("code",[n._v("DOM")]),n._v("对象之间的差异，应用到第一个（原先）"),e("code",[n._v("DOM")]),n._v("结构中，我们看到"),e("code",[n._v("DOM")]),n._v("结构进行了预期的变化，如下图所示：")]),n._v(" "),e("h3",{attrs:{id:"六、源码分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六、源码分析"}},[n._v("#")]),n._v(" 六、源码分析")]),n._v(" "),e("h4",{attrs:{id:"_6-1-vmode模拟dom树"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-vmode模拟dom树"}},[n._v("#")]),n._v(" 6.1 "),e("code",[n._v("VMode")]),n._v("模拟"),e("code",[n._v("DOM")]),n._v("树")]),n._v(" "),e("p",[n._v("在"),e("code",[n._v("Vue.js")]),n._v("中，"),e("code",[n._v("Virtual DOM")]),n._v("是用"),e("code",[n._v("VNode")]),n._v("这个"),e("code",[n._v("Class")]),n._v("去描述，它定义在"),e("code",[n._v("src/core/vdom/vnode.js")]),n._v("中，从以下代码块中可以看到"),e("code",[n._v("Vue.js")]),n._v("中的"),e("code",[n._v("Virtual DOM")]),n._v("的定义较为复杂一些，因为它这里包含了很多"),e("code",[n._v("Vue.js")]),n._v("的特性。实际上"),e("code",[n._v("Vue.js")]),n._v("中"),e("code",[n._v("Virtual DOM")]),n._v("是借鉴了一个开源库"),e("a",{attrs:{href:"https://github.com/snabbdom/snabbdom",target:"_blank",rel:"noopener noreferrer"}},[n._v("snabbdom"),e("OutboundLink")],1),n._v("的实现，然后加入了一些"),e("code",[n._v("Vue.js")]),n._v("的一些特性。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("export default class VNode {\n  tag: string | void;\n  data: VNodeData | void;\n  children: ?Array<VNode>;\n  text: string | void;\n  elm: Node | void;\n  ns: string | void;\n  context: Component | void; // rendered in this component's scope\n  key: string | number | void;\n  componentOptions: VNodeComponentOptions | void;\n  componentInstance: Component | void; // component instance\n  parent: VNode | void; // component placeholder node\n\n  // strictly internal\n  raw: boolean; // contains raw HTML? (server only)\n  isStatic: boolean; // hoisted static node\n  isRootInsert: boolean; // necessary for enter transition check\n  isComment: boolean; // empty comment placeholder?\n  isCloned: boolean; // is a cloned node?\n  isOnce: boolean; // is a v-once node?\n  asyncFactory: Function | void; // async component factory function\n  asyncMeta: Object | void;\n  isAsyncPlaceholder: boolean;\n  ssrContext: Object | void;\n  fnContext: Component | void; // real context vm for functional nodes\n  fnOptions: ?ComponentOptions; // for SSR caching\n  devtoolsMeta: ?Object; // used to store functional render context for devtools\n  fnScopeId: ?string; // functional scope id support\n\n  constructor (\n    tag?: string,\n    data?: VNodeData,\n    children?: ?Array<VNode>,\n    text?: string,\n    elm?: Node,\n    context?: Component,\n    componentOptions?: VNodeComponentOptions,\n    asyncFactory?: Function\n  ) {\n    this.tag = tag\n    this.data = data\n    this.children = children\n    this.text = text\n    this.elm = elm\n    this.ns = undefined\n    this.context = context\n    this.fnContext = undefined\n    this.fnOptions = undefined\n    this.fnScopeId = undefined\n    this.key = data && data.key\n    this.componentOptions = componentOptions\n    this.componentInstance = undefined\n    this.parent = undefined\n    this.raw = false\n    this.isStatic = false\n    this.isRootInsert = true\n    this.isComment = false\n    this.isCloned = false\n    this.isOnce = false\n    this.asyncFactory = asyncFactory\n    this.asyncMeta = undefined\n    this.isAsyncPlaceholder = false\n  }\n\n  // DEPRECATED: alias for componentInstance for backwards compat.\n  /* istanbul ignore next */\n  get child (): Component | void {\n    return this.componentInstance\n  }\n}\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br"),e("span",{staticClass:"line-number"},[n._v("35")]),e("br"),e("span",{staticClass:"line-number"},[n._v("36")]),e("br"),e("span",{staticClass:"line-number"},[n._v("37")]),e("br"),e("span",{staticClass:"line-number"},[n._v("38")]),e("br"),e("span",{staticClass:"line-number"},[n._v("39")]),e("br"),e("span",{staticClass:"line-number"},[n._v("40")]),e("br"),e("span",{staticClass:"line-number"},[n._v("41")]),e("br"),e("span",{staticClass:"line-number"},[n._v("42")]),e("br"),e("span",{staticClass:"line-number"},[n._v("43")]),e("br"),e("span",{staticClass:"line-number"},[n._v("44")]),e("br"),e("span",{staticClass:"line-number"},[n._v("45")]),e("br"),e("span",{staticClass:"line-number"},[n._v("46")]),e("br"),e("span",{staticClass:"line-number"},[n._v("47")]),e("br"),e("span",{staticClass:"line-number"},[n._v("48")]),e("br"),e("span",{staticClass:"line-number"},[n._v("49")]),e("br"),e("span",{staticClass:"line-number"},[n._v("50")]),e("br"),e("span",{staticClass:"line-number"},[n._v("51")]),e("br"),e("span",{staticClass:"line-number"},[n._v("52")]),e("br"),e("span",{staticClass:"line-number"},[n._v("53")]),e("br"),e("span",{staticClass:"line-number"},[n._v("54")]),e("br"),e("span",{staticClass:"line-number"},[n._v("55")]),e("br"),e("span",{staticClass:"line-number"},[n._v("56")]),e("br"),e("span",{staticClass:"line-number"},[n._v("57")]),e("br"),e("span",{staticClass:"line-number"},[n._v("58")]),e("br"),e("span",{staticClass:"line-number"},[n._v("59")]),e("br"),e("span",{staticClass:"line-number"},[n._v("60")]),e("br"),e("span",{staticClass:"line-number"},[n._v("61")]),e("br"),e("span",{staticClass:"line-number"},[n._v("62")]),e("br"),e("span",{staticClass:"line-number"},[n._v("63")]),e("br"),e("span",{staticClass:"line-number"},[n._v("64")]),e("br"),e("span",{staticClass:"line-number"},[n._v("65")]),e("br"),e("span",{staticClass:"line-number"},[n._v("66")]),e("br"),e("span",{staticClass:"line-number"},[n._v("67")]),e("br"),e("span",{staticClass:"line-number"},[n._v("68")]),e("br"),e("span",{staticClass:"line-number"},[n._v("69")]),e("br"),e("span",{staticClass:"line-number"},[n._v("70")]),e("br")])]),e("p",[n._v("这里有几个核心的属性")]),n._v(" "),e("ul",[e("li",[e("code",[n._v("tag")]),n._v("属性即这个"),e("code",[n._v("vnode")]),n._v("的标签属性")]),n._v(" "),e("li",[e("code",[n._v("data")]),n._v("属性包含了最后渲染成真实"),e("code",[n._v("dom")]),n._v("节点后，节点上的"),e("code",[n._v("class")]),n._v("，"),e("code",[n._v("attribute")]),n._v("，"),e("code",[n._v("style")]),n._v("以及绑定的事件")])]),n._v(" "),e("p",[e("strong",[n._v("源码创建 VNode 过程")])]),n._v(" "),e("p",[n._v("我们在实例化一个"),e("code",[n._v("vue")]),n._v("实例，也即"),e("code",[n._v("new Vue()")]),n._v("时，实际上是执行"),e("code",[n._v("src/core/instance/index.js")]),n._v("中定义的"),e("code",[n._v("Function")]),n._v("函数。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("function Vue(options){\n    if(process.env.NODE_ENV !=='production' && !(this instanceof Vue)){\n         warn('Vue is a constructor and should be called with the `new` keyword')\n    }\n    this._init(options)\n}\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br")])]),e("p",[n._v("通过查看"),e("code",[n._v("Vue")]),n._v("的"),e("code",[n._v("function")]),n._v("，我们知道"),e("code",[n._v("Vue")]),n._v("只能通过"),e("code",[n._v("new")]),n._v("关键字初始化，然后调用"),e("code",[n._v("this._init")]),n._v("方法，该方法在"),e("code",[n._v("src/core/instance/init.js")]),n._v("中定义。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br")])]),e("p",[e("strong",[n._v("Vue 实例挂载")])]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("const mount = Vue.prototype.$mount\nVue.prototype.$mount = function(el,hydrating){\n    el = el && query(el)\n    // 省略一系列初始化以及逻辑判断代码\n    return mount.call(this, el, hydrating)\n}\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br")])]),e("p",[e("strong",[n._v("创建虚拟 Node")])]),n._v(" "),e("p",[e("code",[n._v("Vue")]),n._v("的"),e("code",[n._v("_render")]),n._v("方法是实例的一个私有方法，它用来把实例渲染成一个虚拟"),e("code",[n._v("Node")]),n._v("。它的定义在"),e("code",[n._v("src/core/instance/render.js")]),n._v("文件中：")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("Vue.prototype._render = function(){\n\n}\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br")])]),e("h4",{attrs:{id:"_6-2-diff-过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-diff-过程"}},[n._v("#")]),n._v(" 6.2 diff 过程")]),n._v(" "),e("p",[e("code",[n._v("Vue.js")]),n._v("源码实例化了一个"),e("code",[n._v("watcher")]),n._v("，这个~被添加到了在模板当中所绑定变量的依赖当中，一旦"),e("code",[n._v("model")]),n._v("中的响应式的数据发生了变化，这些响应式的数据所的"),e("code",[n._v("dep")]),n._v("数组便会调用"),e("code",[n._v("dep.notify()")]),n._v("方法完成所有依赖遍历执行的工作，这包括视图的更新，即"),e("code",[n._v("updateComponent")]),n._v("方法的调用。"),e("code",[n._v("watcher")]),n._v("和"),e("code",[n._v("updateComponent")]),n._v("方法定义在"),e("code",[n._v("src/core/instance/lifecycle.js")]),n._v("文件中。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br")])]),e("p",[n._v("完成视图的更新工作事实上就是调用了"),e("code",[n._v("vm._update")]),n._v("方法，这个方法的"),e("code",[n._v("Vnode")]),n._v("，调用的"),e("code",[n._v("vm._update")]),n._v("方法定义在"),e("code",[n._v("src/core/instance/lifecycle.js")]),n._v("中。")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br")])]),e("p",[n._v("从以上代码得知。")]),n._v(" "),e("p",[e("code",[n._v("diff")]),n._v("过程中分了好几种情况，"),e("code",[n._v("oldCh")]),n._v("为"),e("code",[n._v("oldVnode")]),n._v("的子节点，"),e("code",[n._v("ch")]),n._v("为"),e("code",[n._v("Vnode")]),n._v("的子节点：")]),n._v(" "),e("ul",[e("li",[n._v("首先进行文本节点的判断，若"),e("code",[n._v("oldVnode.text !== vnode.text")]),n._v("，那么就会直接进行文本节点的替换；")]),n._v(" "),e("li",[n._v("在"),e("code",[n._v("vnode")]),n._v("没有文本节点的情况下，进入子节点的"),e("code",[n._v("diff")]),n._v("；")]),n._v(" "),e("li",[n._v("当"),e("code",[n._v("oldCh")]),n._v("和"),e("code",[n._v("ch")]),n._v("都在存在且不相同的情况下，调用"),e("code",[n._v("updateChildren")]),n._v("对子节点进行"),e("code",[n._v("diff")]),n._v(";")]),n._v(" "),e("li",[n._v("若"),e("code",[n._v("oldCh")]),n._v("不存在，"),e("code",[n._v("ch")]),n._v("存在，首先清空"),e("code",[n._v("oldVnode")]),n._v("的文本节点，同时调用"),e("code",[n._v("addVnodes")]),n._v("方法将"),e("code",[n._v("ch")]),n._v("添加到"),e("code",[n._v("elm")]),n._v("真实"),e("code",[n._v("dom")]),n._v("节点当中；")])]),n._v(" "),e("p",[e("strong",[n._v("子节点"),e("code",[n._v("diff")]),n._v("流程分析")])]),n._v(" "),e("p",[n._v("分析一下"),e("code",[n._v("updateChildren")]),n._v("方法，它也是整个"),e("code",[n._v("diff")]),n._v("过程中最重要的环节，")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v("\n")])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br")])]),e("h4",{attrs:{id:"_6-3-patch-过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-patch-过程"}},[n._v("#")]),n._v(" 6.3 patch 过程")]),n._v(" "),e("h4",{attrs:{id:"_6-4-总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-总结"}},[n._v("#")]),n._v(" 6.4 总结")]),n._v(" "),e("p",[n._v("通过前三小节解析，我们从主线上把模板和数据如何渲染成最终的"),e("code",[n._v("DOM")]),n._v("的过程分析完毕了，我们可以通过下图更直观看到从初始化"),e("code",[n._v("Vue")]),n._v("到最终渲染的整个过程。")]),n._v(" "),e("p",[e("img",{attrs:{src:"vue-diff.png",alt:"images"}})]),n._v(" "),e("h3",{attrs:{id:"参考资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[n._v("#")]),n._v(" 参考资料")]),n._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://github.com/livoras/blog/issues/13",target:"_blank",rel:"noopener noreferrer"}},[n._v("如何实现一个 Virtual DOM 算法"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/EeN7E8uQS4R_JJloPX8fCQ",target:"_blank",rel:"noopener noreferrer"}},[n._v("揭秘 Vue 中的 Virtual Dom"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/oAlVmZ4Hbt2VhOwFEkNEhw",target:"_blank",rel:"noopener noreferrer"}},[n._v("虚拟 DOM 到底是什么？"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://juejin.im/post/5d36cc575188257aea108a74",target:"_blank",rel:"noopener noreferrer"}},[n._v("深入剖析：Vue 核心之虚拟 DOM"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://www.404forest.com/2019/03/07/modern-web-development-tech-analysis-virtual-dom/",target:"_blank",rel:"noopener noreferrer"}},[n._v("现代前端科技解析 —— Virtual DOM #"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/aooy/blog/issues/2",target:"_blank",rel:"noopener noreferrer"}},[n._v("Diff 算法"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://mp.weixin.qq.com/s/9nB2bfDczNFRpUTiBwup8Q",target:"_blank",rel:"noopener noreferrer"}},[n._v("Virtual Dom 和 Diff 算法"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/81752104",target:"_blank",rel:"noopener noreferrer"}},[n._v("【Vue 原理】Diff - 白话版"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/29450092",target:"_blank",rel:"noopener noreferrer"}},[n._v("VirtualDOM 与 diff(Vue 实现)"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://juejin.im/post/5c8e5e4951882545c109ae9c",target:"_blank",rel:"noopener noreferrer"}},[n._v("让虚拟 DOM 和 DOM-diff 不再成为你的绊脚石"),e("OutboundLink")],1)]),n._v(" "),e("li",[e("a",{attrs:{href:"https://juejin.im/post/5e53c9c051882549150ea5d3",target:"_blank",rel:"noopener noreferrer"}},[n._v("虚拟 Dom+Diff--Vue 源码动手写系列"),e("OutboundLink")],1)])]),n._v(" "),e("h2",{attrs:{id:"联系作者"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#联系作者"}},[n._v("#")]),n._v(" 联系作者")]),n._v(" "),e("div",{attrs:{align:"center"}},[e("p",[n._v("\n        平凡世界，贵在坚持。\n    ")]),n._v(" "),e("img",{attrs:{src:n.$withBase("/about/contact.png")}})])])}),[],!1,null,null,null);s.default=t.exports}}]);