(window.webpackJsonp=window.webpackJsonp||[]).push([[181],{242:function(s,n,a){"use strict";a.r(n);var e=a(4),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 跨域")]),s._v(" "),a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("本人平时学习及收集内容，欢迎参入一起讨论。")]),s._v(" "),a("h2",{attrs:{id:"内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#内容","aria-hidden":"true"}},[s._v("#")]),s._v(" 内容")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AF%E8%B7%A8%E5%9F%9F%EF%BC%9F"}},[s._v("什么是跨域？")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E4%BA%8C%E3%80%81%E5%B8%B8%E8%A7%81%E8%B7%A8%E5%9F%9F%E5%9C%BA%E6%99%AF"}},[s._v("常见跨域场景")])]),s._v(" "),a("li",[a("a",{attrs:{href:"#%E4%B8%89%E3%80%81%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"}},[s._v("跨域解决方案")])])]),s._v(" "),a("h3",{attrs:{id:"一、什么是跨域？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、什么是跨域？","aria-hidden":"true"}},[s._v("#")]),s._v(" 一、什么是跨域？")]),s._v(" "),a("blockquote",[a("p",[s._v("跨域是指一个域下的文档或脚本试图去请求另一个域下的资源，这里跨域是广义的。")])]),s._v(" "),a("ul",[a("li",[s._v("广义的跨域")]),s._v(" "),a("li",[s._v("什么是同源策略？")])]),s._v(" "),a("h4",{attrs:{id:"广义的跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#广义的跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 广义的跨域")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("资源跳转")]),s._v(" ： A 链接、重定向、表单提交")]),s._v(" "),a("li",[a("strong",[s._v("资源嵌入")]),s._v(" ： "),a("code",[s._v("<link>")]),s._v("、"),a("code",[s._v("<script>")]),s._v("、"),a("code",[s._v("<img>")]),s._v("、"),a("code",[s._v("<frame>")]),s._v("等"),a("code",[s._v("dom")]),s._v("标签，还有样式中"),a("code",[s._v("background:url()")]),s._v("、"),a("code",[s._v("@font-face()")]),s._v("等文件外链")]),s._v(" "),a("li",[a("strong",[s._v("脚本请求")]),s._v(" ： "),a("code",[s._v("js")]),s._v(" 发起的"),a("code",[s._v("ajax")]),s._v("请求、"),a("code",[s._v("dom")]),s._v(" 和 "),a("code",[s._v("js")]),s._v(" 对象的跨域操作等")])]),s._v(" "),a("p",[s._v("其实我们通常所说的跨域是狭义的，是由浏览器同源策略限制的类请求场景。")]),s._v(" "),a("h4",{attrs:{id:"什么是同源策略？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是同源策略？","aria-hidden":"true"}},[s._v("#")]),s._v(" 什么是同源策略？")]),s._v(" "),a("p",[s._v('同源策略/SOP（Same origin policy）是一种约定，由 Netscape 公司 1995 年引入浏览器，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，浏览器很容易受到 XSS、CSFR 等攻击。所谓同源是指"协议+域名+端口"三者相同，即便两个不同的域名指向同一个 ip 地址，也非同源。')]),s._v(" "),a("p",[s._v("同源策略限制以下几种行为：")]),s._v(" "),a("blockquote",[a("ol",[a("li",[s._v("Cookie、LocalStorage 和 IndexDB 无法读取")]),s._v(" "),a("li",[s._v("DOM 和 Js 对象无法获得")]),s._v(" "),a("li",[s._v("AJAX 请求不能发送")])])]),s._v(" "),a("h3",{attrs:{id:"二、常见跨域场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、常见跨域场景","aria-hidden":"true"}},[s._v("#")]),s._v(" 二、常见跨域场景")]),s._v(" "),a("p",[s._v("**当协议、子域名、主域名、端口号中任意一个不相同时，都算作不同域。**不同域之间相互请求资源，就算作“跨域”。常见跨域场景如下图所示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"cross.png",alt:"images"}})]),s._v(" "),a("p",[s._v("特别说明两点：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("如果是协议和端口造成的跨域问题“前台”是无能为力的。")])]),s._v(" "),a("li",[a("strong",[s._v("在跨域问题上，仅仅是通过“URL 的首部”来识别而不会根据域名对应的 IP 地址是否相同来判断。“URL 的首部”可以理解为“协议，域名和商品必须匹配”")])])]),s._v(" "),a("h3",{attrs:{id:"三、跨域解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、跨域解决方案","aria-hidden":"true"}},[s._v("#")]),s._v(" 三、跨域解决方案")]),s._v(" "),a("ul",[a("li",[s._v("通过 jsonp 跨域")]),s._v(" "),a("li",[s._v("document.domain + iframe 跨域")]),s._v(" "),a("li",[s._v("location.hash + iframe 跨域")]),s._v(" "),a("li",[s._v("window.name + iframe 跨域")]),s._v(" "),a("li",[s._v("postMessage 跨域")]),s._v(" "),a("li",[s._v("跨域资源共享（CORS）")]),s._v(" "),a("li",[s._v("nginx 反向代理")]),s._v(" "),a("li",[s._v("nodejs 中间件代理跨域")]),s._v(" "),a("li",[s._v("WebSocket 协议跨域")])]),s._v(" "),a("h4",{attrs:{id:"_3-1-通过-jsonp-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-通过-jsonp-跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.1 通过 jsonp 跨域")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("JSONP 原理：")]),s._v(" 利用"),a("code",[s._v("<script>")]),s._v("标签没有跨域限制的漏洞，网页可以可以得到从其他来源动态产生的 JSON 数据。JSONP 请求一定需要对方的服务器做支持才可以。")]),s._v(" "),a("li",[a("strong",[s._v("JSONP 和 AJAX 对比：")]),s._v(" JSONP 和 AJAX 相同，都是客户端向服务器端发送请求，从服务器获取数据的方式。但 AJAX 属于同源策略，JSONP 属于非同源策略(跨域请求)")]),s._v(" "),a("li",[a("strong",[s._v("JSONP 优缺点：")]),s._v(" JSONP 优点是简单兼容性好，可用于解决主流浏览器的跨域数据访问的问题。缺点就是仅支持 get 方法具有局限性，不安全可能会遭受 XSS 攻击。")]),s._v(" "),a("li",[a("strong",[s._v("JSONP 的实现流程")]),s._v(" "),a("ul",[a("li",[s._v("声明一个回调函数，其函数名(如 show)当做参数值，要传递给跨域请求数据的服务器，函数形参为要获取目标数据(服务器返回的 data)。")]),s._v(" "),a("li",[s._v("创建一个"),a("code",[s._v("<script>")]),s._v("标签，把那个跨域 API 数据接口地址，同仁给"),a("code",[s._v("script")]),s._v("的"),a("code",[s._v("src")]),s._v("还要在这个地址中向服务器传递该函数名(可以通过问题传参:"),a("code",[s._v("?callback=show")]),s._v(")。")]),s._v(" "),a("li",[s._v("服务器接收到请求后，需要进行特殊的处理：把传递进来的函数名和它需要给你的数据拼接成一个字符串,例如：传递进去的函数名是"),a("code",[s._v("show")]),s._v("，它准备好的数据是"),a("code",[s._v("show('我不爱好')")]),s._v("。")]),s._v(" "),a("li",[s._v("最后服务器把准备的数据通过 HTTP 协议返回给客户端，客户端再调用执行之前声明的回调函数(show)，对返回的数据进行操作。")])])])]),s._v(" "),a("p",[s._v("在开发中可能会遇到多个"),a("code",[s._v("JSONP")]),s._v("请求的回调函数名是相同的，这时候就需要自己封装一个"),a("code",[s._v("JSONP")]),s._v("函数。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// index.html\nfunction jsonp({ url, params, callback }) {\n  return new Promise((resolve, reject) => {\n    let script = document.createElement('script')\n    window[callback] = function(data) {\n      resolve(data)\n      document.body.removeChild(script)\n    }\n    params = { ...params, callback } // wd=b&callback=show\n    let arrs = []\n    for (let key in params) {\n      arrs.push(`${key}=${params[key]}`)\n    }\n    script.src = `${url}?${arrs.join('&')}`\n    document.body.appendChild(script)\n  })\n}\njsonp({\n  url: 'http://localhost:3000/say',\n  params: { wd: 'Iloveyou' },\n  callback: 'show'\n}).then(data => {\n  console.log(data)\n})\n\n // 回调执行函数\nfunction show(res) {\n    alert(JSON.stringify(res));\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("p",[s._v("上面这段代码相当于向"),a("code",[s._v("http://localhost:3000/say?wd=Iloveyou&callback=show")]),s._v("这个地址请求数据，然后后台返回"),a("code",[s._v("show('我不爱你')")]),s._v("，最后会运行 show()这个函数，打印出'我不爱你'")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// server.js\nlet express = require('express')\nlet app = express()\napp.get('/say', function(req, res) {\n  let { wd, callback } = req.query\n  console.log(wd) // Iloveyou\n  console.log(callback) // show\n  res.end(`${callback}('我不爱你')`)\n})\napp.listen(3000)\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("ul",[a("li",[s._v("jQuery 的 jsonp 形式")])]),s._v(" "),a("p",[a("strong",[s._v("JSONP 都是 GET 和异步请求的，不存在其他的请求方式和同步请求，且 jQuery 默认就会给 JSONP 的请求清除缓存。")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('$.ajax({\n    url:"http://crossdomain.com/jsonServerResponse",\n    dataType:"jsonp",\n    type:"get",//可以省略\n    jsonpCallback:"show",//->自定义传递给服务器的函数名，而不是使用jQuery自动生成的，可省略\n    jsonp:"callback",//->把传递函数名的那个形参callback，可省略\n    success:function (data){\n        console.log(data);\n    }\n});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h4",{attrs:{id:"_3-2-document-domain-iframe-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-document-domain-iframe-跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.2 document.domain+iframe 跨域")]),s._v(" "),a("p",[s._v("此方案仅限主域相同，子域不同的跨域应用场景。")]),s._v(" "),a("p",[s._v("实现原理：两个页面都通过 js 强制设置 document.domain 为基础主域，就实现了同域。")]),s._v(" "),a("p",[s._v("1.）父窗口：(http://www.domain.com/a.html)")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<iframe id=\"iframe\" src=\"http://child.domain.com/b.html\"></iframe>\n<script>\n    document.domain = 'domain.com';\n    var user = 'admin';\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("2.）子窗口：(http://child.domain.com/b.html)")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<script>\n    document.domain = 'domain.com';\n    // 获取父窗口中变量\n    alert('get js data from parent ---\x3e ' + window.parent.user);\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_3-3-location-hash-iframe-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-location-hash-iframe-跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.3 location.hash+iframe 跨域")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("实现原理：")]),s._v(" "),a("code",[s._v("a.html")]),s._v("欲与"),a("code",[s._v("b.html")]),s._v(" 跨域相互通信，通过中间页"),a("code",[s._v("c")]),s._v("来实现。 三个页面，不同域之间利用"),a("code",[s._v("iframe")]),s._v("的"),a("code",[s._v("location.hash")]),s._v("传值，相同域之间直接 js 访问来通信。")]),s._v(" "),a("li",[a("strong",[s._v("具体实现：")]),s._v(" A 域："),a("code",[s._v("a.html")]),s._v(" -> B 域："),a("code",[s._v("b.html")]),s._v(" -> A 域："),a("code",[s._v("c.html")]),s._v("，"),a("code",[s._v("a")]),s._v("与"),a("code",[s._v("b")]),s._v("不同域只能通过 "),a("code",[s._v("hash")]),s._v("值单向通信，"),a("code",[s._v("b")]),s._v("与"),a("code",[s._v("c")]),s._v("也不同域也只能单向通信，但"),a("code",[s._v("c")]),s._v("与"),a("code",[s._v("a")]),s._v("同域，所以"),a("code",[s._v("c")]),s._v("可通过"),a("code",[s._v("parent.parent")]),s._v("访问"),a("code",[s._v("a")]),s._v("页面所有对象。")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// a.html\n<iframe id=\"iframe\" src=\"http://www.domain2.com/b.html\" style=\"display:none;\"></iframe>\n<script>\n    var iframe = document.getElementById('iframe');\n\n    // 向b.html传hash值\n    setTimeout(function() {\n        iframe.src = iframe.src + '#user=admin';\n    }, 1000);\n\n    // 开放给同域c.html的回调方法\n    function onCallback(res) {\n        alert('data from c.html ---\x3e ' + res);\n    }\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('// b.html\n<iframe id="iframe" src="http://www.domain1.com/c.html" style="display:none;"></iframe>\n<script>\n    var iframe = document.getElementById(\'iframe\');\n\n    // 监听a.html传来的hash值，再传给c.html\n    window.onhashchange = function () {\n        iframe.src = iframe.src + location.hash;\n    };\n<\/script>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// c.html\n<script>\n    // 监听b.html传来的hash值\n    window.onhashchange = function () {\n        // 再通过操作同域a.html的js回调，将结果传回\n        window.parent.parent.onCallback('hello: ' + location.hash.replace('#user=', ''));\n    };\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h4",{attrs:{id:"_3-4-window-name-iframe-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-window-name-iframe-跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.4 window.name + iframe 跨域")]),s._v(" "),a("p",[a("code",[s._v("window.name")]),s._v("属性的独特之处："),a("code",[s._v("name")]),s._v("值在不同的页面（甚至不同域名）加载后依旧存在，并且可以支持非常长的"),a("code",[s._v("name")]),s._v("值（2MB）。")]),s._v(" "),a("p",[s._v("其中"),a("code",[s._v("a.html")]),s._v("和"),a("code",[s._v("b.html")]),s._v("是同域的，都是"),a("code",[s._v("http://localhost:3000")]),s._v(";而 c.html 是"),a("code",[s._v("http://localhost:4000")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// a.html\nvar proxy = function(url, callback) {\n    var state = 0;\n    var iframe = document.createElement('iframe');\n\n    // 加载跨域页面\n    iframe.src = url;\n\n    // onload事件会触发2次，第1次加载跨域页，并留存数据于window.name\n    iframe.onload = function() {\n        if (state === 1) {\n            // 第2次onload(同域proxy页)成功后，读取同域window.name中数据\n            callback(iframe.contentWindow.name);\n            destoryFrame();\n\n        } else if (state === 0) {\n            // 第1次onload(跨域页)成功后，切换到同域代理页面\n            iframe.contentWindow.location = 'http://www.domain1.com/proxy.html';\n            state = 1;\n        }\n    };\n\n    document.body.appendChild(iframe);\n\n    // 获取数据以后销毁这个iframe，释放内存；这也保证了安全（不被其他域frame js访问）\n    function destoryFrame() {\n        iframe.contentWindow.document.write('');\n        iframe.contentWindow.close();\n        document.body.removeChild(iframe);\n    }\n};\n\n// 请求跨域b页面数据\nproxy('http://www.domain2.com/b.html', function(data){\n    alert(data);\n});\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[a("p",[s._v("b.html："),a("code",[s._v("(http://www.domain1.com/b.html)")]),s._v("，中间代理页，与"),a("code",[s._v("a.html")]),s._v("同域，内容为空即可。")])]),s._v(" "),a("li",[a("p",[s._v("c.html："),a("code",[s._v("(http://www.domain2.com/b.html)")])])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<script>\n    window.name = 'This is domain2 data!';\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("总结：通过"),a("code",[s._v("iframe")]),s._v("的"),a("code",[s._v("src")]),s._v("属性由外域转向本地域，跨域数据即由"),a("code",[s._v("iframe")]),s._v("的"),a("code",[s._v("window.name")]),s._v("从外域传递到本地域。这个就巧妙地绕过了浏览器的跨域访问限制，但同时它又是安全操作。")]),s._v(" "),a("h4",{attrs:{id:"_3-5-postmessage-跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-postmessage-跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.5 postMessage 跨域")]),s._v(" "),a("p",[s._v("postMessage 是 HTML5 XMLHttpRequest Level 2 中的 API，且是为数不多可以跨域操作的 window 属性之一，它可用于解决以下方面的问题：")]),s._v(" "),a("ul",[a("li",[s._v("页面和其打开的新窗口的数据传递")]),s._v(" "),a("li",[s._v("多窗口之间消息传递")]),s._v(" "),a("li",[s._v("页面与嵌套的 iframe 消息传递")]),s._v(" "),a("li",[s._v("上面三个场景的跨域数据传递")])]),s._v(" "),a("p",[a("strong",[s._v("postMessage()方法允许来自不同源的脚本采用异步方式进行有限的通信，可以实现跨文本档、多窗口、跨域消息传递。")])]),s._v(" "),a("blockquote",[a("p",[s._v("用法：postMessage(data,origin)方法接受两个参数")])]),s._v(" "),a("ul",[a("li",[s._v("data：html5 规范支持任意基本类型或可复制的对象，但部分浏览器只支持字符串，所以传参时最好用 JSON.stringify()序列化。")]),s._v(" "),a("li",[s._v('origin：协议+主机+端口号，也可以设置为"*"，表示可以传递给任意窗口，如果要指定和当前窗口同源的话设置为"/"。')])]),s._v(" "),a("p",[s._v("例子： "),a("code",[s._v("http://localhost:3000/a.html")]),s._v("页面向"),a("code",[s._v("http://localhost:4000/b.html")]),s._v('传递“我爱你”,然后后者传回"我不爱你"。')]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<iframe id=\"iframe\" src=\"http://www.domain2.com/b.html\" style=\"display:none;\"></iframe>\n<script>\n    var iframe = document.getElementById('iframe');\n    iframe.onload = function() {\n        var data = {\n            name: 'aym'\n        };\n        // 向domain2传送跨域数据\n        iframe.contentWindow.postMessage(JSON.stringify(data), 'http://www.domain2.com');\n    };\n\n    // 接受domain2返回数据\n    window.addEventListener('message', function(e) {\n        alert('data from domain2 ---\x3e ' + e.data);\n    }, false);\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<script>\n    // 接收domain1的数据\n    window.addEventListener('message', function(e) {\n        alert('data from domain1 ---\x3e ' + e.data);\n\n        var data = JSON.parse(e.data);\n        if (data) {\n            data.number = 16;\n\n            // 处理后再发回domain1\n            window.parent.postMessage(JSON.stringify(data), 'http://www.domain1.com');\n        }\n    }, false);\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h4",{attrs:{id:"_3-6-跨域资源共享（cors）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-跨域资源共享（cors）","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.6 跨域资源共享（CORS）")]),s._v(" "),a("p",[a("strong",[s._v("CORS 需要浏览器和后端同时支持。IE8 和 9 需要通过 XDomainRequest 来实现。")])]),s._v(" "),a("p",[s._v("浏览器会自动进行"),a("code",[s._v("CORS")]),s._v("通信，实现"),a("code",[s._v("CORS")]),s._v("通信的关键是后端。只要后端实现了"),a("code",[s._v("CORS")]),s._v("，就实现了跨域。")]),s._v(" "),a("p",[s._v("服务端设置"),a("code",[s._v("Access-Control-Allow-Origin")]),s._v("就可以开启"),a("code",[s._v("CORS")]),s._v("。 该属性表示哪些域名可以访问资源，如果设置通配符则表示所有网站都可以访问资源。")]),s._v(" "),a("p",[s._v("虽然设置"),a("code",[s._v("CORS")]),s._v("和前端没什么关系，但是通过这种方式解决跨域问题的话，会在发送请求时出现两种情况，分别为"),a("strong",[s._v("简单请求")]),s._v("和"),a("strong",[s._v("复杂请求")]),s._v("。")]),s._v(" "),a("p",[a("strong",[s._v("简单请求")])]),s._v(" "),a("p",[s._v("只要同时满足以下两大条件，就属于简单请求")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("条件 1：")]),s._v(" 请求方法使用下列方法之一分别为"),a("code",[s._v("GET")]),s._v("、"),a("code",[s._v("HEAD")]),s._v("、"),a("code",[s._v("POST")])]),s._v(" "),a("li",[a("strong",[s._v("条件 2：")]),s._v(" HTTP 的头信息不超出以下几个种字段"),a("code",[s._v("Accept")]),s._v("、"),a("code",[s._v("Accept-Language")]),s._v("、"),a("code",[s._v("Content-Language")]),s._v("、"),a("code",[s._v("Last-Event-ID")]),s._v("、"),a("code",[s._v("Content-Type")]),s._v("只限于三个值"),a("code",[s._v("application/x-www-form-urlencoded")]),s._v("、"),a("code",[s._v("multipart/form-data")]),s._v("、"),a("code",[s._v("text/plain")])])]),s._v(" "),a("p",[a("strong",[s._v("非简单请求")])]),s._v(" "),a("p",[s._v("不同时满足上面两个条件，就是非简单请求了。")]),s._v(" "),a("p",[s._v('复杂请求的 CORS 请求，会在正式通信之前，增加一次 HTTP 查询请求，称为"预检"请求,该请求是 option 方法的，通过该请求来知道服务端是否允许跨域请求。')]),s._v(" "),a("p",[s._v("我们用"),a("code",[s._v("PUT")]),s._v("向后台请求时，属于复杂请求，后台需做如下配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// 允许哪个方法访问我\nres.setHeader('Access-Control-Allow-Methods', 'PUT')\n// 预检的存活时间\nres.setHeader('Access-Control-Max-Age', 6)\n// OPTIONS请求不做任何处理\nif (req.method === 'OPTIONS') {\n  res.end()\n}\n// 定义后台返回的内容\napp.put('/getData', function(req, res) {\n  console.log(req.headers)\n  res.end('我不爱你')\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("接下来我们看下一个完整复杂请求的例子，并且介绍下 CORS 请求相关的字段")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// index.html\nlet xhr = new XMLHttpRequest()\ndocument.cookie = 'name=xiamen' // cookie不能跨域\nxhr.withCredentials = true // 前端设置是否带cookie\nxhr.open('PUT', 'http://localhost:4000/getData', true)\nxhr.setRequestHeader('name', 'xiamen')\nxhr.onreadystatechange = function() {\n  if (xhr.readyState === 4) {\n    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {\n      console.log(xhr.response)\n      //得到响应头，后台需设置Access-Control-Expose-Headers\n      console.log(xhr.getResponseHeader('name'))\n    }\n  }\n}\nxhr.send()\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("//server1.js\nlet express = require('express');\nlet app = express();\napp.use(express.static(__dirname));\napp.listen(3000);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("//server2.js\nlet express = require('express')\nlet app = express()\nlet whitList = ['http://localhost:3000'] //设置白名单\napp.use(function(req, res, next) {\n  let origin = req.headers.origin\n  if (whitList.includes(origin)) {\n    // 设置哪个源可以访问我\n    res.setHeader('Access-Control-Allow-Origin', origin)\n    // 允许携带哪个头访问我\n    res.setHeader('Access-Control-Allow-Headers', 'name')\n    // 允许哪个方法访问我\n    res.setHeader('Access-Control-Allow-Methods', 'PUT')\n    // 允许携带cookie\n    res.setHeader('Access-Control-Allow-Credentials', true)\n    // 预检的存活时间\n    res.setHeader('Access-Control-Max-Age', 6)\n    // 允许返回的头\n    res.setHeader('Access-Control-Expose-Headers', 'name')\n    if (req.method === 'OPTIONS') {\n      res.end() // OPTIONS请求不做任何处理\n    }\n  }\n  next()\n})\napp.put('/getData', function(req, res) {\n  console.log(req.headers)\n  res.setHeader('name', 'jw') //返回一个响应头，后台需设置\n  res.end('我不爱你')\n})\napp.get('/getData', function(req, res) {\n  console.log(req.headers)\n  res.end('我不爱你')\n})\napp.use(express.static(__dirname))\napp.listen(4000)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br")])]),a("p",[s._v("上述代码由"),a("code",[s._v("http://localhost:3000/index.html")]),s._v("向"),a("code",[s._v("http://localhost:4000/")]),s._v("跨域请求，正如我们上面所说的，后端是实现"),a("code",[s._v("CORS")]),s._v("通信的关键。")]),s._v(" "),a("h4",{attrs:{id:"_3-7-nginx-反向代理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-nginx-反向代理","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.7 nginx 反向代理")]),s._v(" "),a("p",[a("strong",[s._v("nginx 配置解决 iconfont 跨域")])]),s._v(" "),a("p",[s._v("浏览器跨域访问"),a("code",[s._v("js")]),s._v("、"),a("code",[s._v("css")]),s._v("、"),a("code",[s._v("img")]),s._v("等常规静态资源被同源策略许可，但"),a("code",[s._v("iconfont")]),s._v("字体文件("),a("code",[s._v("eot|otf|ttf|woff|svg")]),s._v(")例外，此时可在"),a("code",[s._v("nginx")]),s._v("的静态资源服务器中加入以下配置。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("location / {\n  add_header Access-Control-Allow-Origin *;\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[a("strong",[s._v("nginx 反向代理接口跨域")])]),s._v(" "),a("p",[s._v("使用 nginx 反向代理实现跨域，是最简单的跨域方式。只需要修改 nginx 的配置即可解决跨域问题，支持所有浏览器，支持 session，不需要修改任何代码，并且不会影响服务器性能。")]),s._v(" "),a("p",[a("strong",[s._v("跨域原理：")]),s._v(" 同源策略是浏览器的安全策略，不是 HTTP 协议的一部分。服务器端调用 HTTP 接口只是使用 HTTP 协议，不会执行 JS 脚本，不需要同源策略，也就不存在跨越问题。")]),s._v(" "),a("p",[a("strong",[s._v("实现思路：")]),s._v(" 通过 nginx 配置一个代理服务器（域名与 domain1 相同，端口不同）做跳板机，反向代理访问 domain2 接口，并且可以顺便修改 cookie 中 domain 信息，方便当前域 cookie 写入，实现跨域登录。")]),s._v(" "),a("p",[s._v("nginx 具体配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("#proxy服务器\nserver {\n    listen       81;\n    server_name  www.domain1.com;\n\n    location / {\n        proxy_pass   http://www.domain2.com:8080;  #反向代理\n        proxy_cookie_domain www.domain2.com www.domain1.com; #修改cookie里域名\n        index  index.html index.htm;\n\n        # 当用webpack-dev-server等中间件代理接口访问nignx时，此时无浏览器参与，故没有同源限制，下面的跨域配置可不启用\n        add_header Access-Control-Allow-Origin http://www.domain1.com;  #当前端只跨域不带cookie时，可为*\n        add_header Access-Control-Allow-Credentials true;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("最后通过命令行"),a("code",[s._v("nginx -s reload")]),s._v("启动"),a("code",[s._v("nginx")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("var xhr = new XMLHttpRequest();\n\n// 前端开关：浏览器是否读写cookie\nxhr.withCredentials = true;\n\n// 访问nginx中的代理服务器\nxhr.open('get', 'http://www.domain1.com:81/?user=admin', true);\nxhr.send();\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("var http = require('http');\nvar server = http.createServer();\nvar qs = require('querystring');\n\nserver.on('request', function(req, res) {\n    var params = qs.parse(req.url.substring(2));\n\n    // 向前台写cookie\n    res.writeHead(200, {\n        'Set-Cookie': 'l=a123456;Path=/;Domain=www.domain2.com;HttpOnly'   // HttpOnly:脚本无法读取\n    });\n\n    res.write(JSON.stringify(params));\n    res.end();\n});\n\nserver.listen('8080');\nconsole.log('Server is running at port 8080...');\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h4",{attrs:{id:"_3-8-nodejs-中间件代理跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-8-nodejs-中间件代理跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.8 nodejs 中间件代理跨域")]),s._v(" "),a("p",[s._v("实现原理："),a("strong",[s._v("同源策略是浏览器需要遵循的标准，而如果是服务器向服务器请求就无需遵循同源策略")]),s._v("。")]),s._v(" "),a("p",[s._v("代理服务器，需要做以下几个步骤：")]),s._v(" "),a("ul",[a("li",[s._v("接受客户端请求 。")]),s._v(" "),a("li",[s._v("将请求 转发给服务器。")]),s._v(" "),a("li",[s._v("拿到服务器 响应 数据。")]),s._v(" "),a("li",[s._v("将 响应 转发给客户端。")])]),s._v(" "),a("p",[a("img",{attrs:{src:"cross01.png",alt:"images"}})]),s._v(" "),a("p",[s._v("我们先来看个例子：本地文件 index.html 文件，通过代理服务器"),a("code",[s._v("http://localhost:3000")]),s._v("向目标服务器"),a("code",[s._v("http://localhost:4000")]),s._v("请求数据。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// index.html(http://127.0.0.1:5500)\n <script src=\"https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js\"><\/script>\n    <script>\n      $.ajax({\n        url: 'http://localhost:3000',\n        type: 'post',\n        data: { name: 'xiamen', password: '123456' },\n        contentType: 'application/json;charset=utf-8',\n        success: function(result) {\n          console.log(result) // {\"title\":\"fontend\",\"password\":\"123456\"}\n        },\n        error: function(msg) {\n          console.log(msg)\n        }\n      })\n     <\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// server1.js 代理服务器(http://localhost:3000)\nconst http = require('http')\n// 第一步：接受客户端请求\nconst server = http.createServer((request, response) => {\n  // 代理服务器，直接和浏览器直接交互，需要设置CORS 的首部字段\n  response.writeHead(200, {\n    'Access-Control-Allow-Origin': '*',\n    'Access-Control-Allow-Methods': '*',\n    'Access-Control-Allow-Headers': 'Content-Type'\n  })\n  // 第二步：将请求转发给服务器\n  const proxyRequest = http\n    .request(\n      {\n        host: '127.0.0.1',\n        port: 4000,\n        url: '/',\n        method: request.method,\n        headers: request.headers\n      },\n      serverResponse => {\n        // 第三步：收到服务器的响应\n        var body = ''\n        serverResponse.on('data', chunk => {\n          body += chunk\n        })\n        serverResponse.on('end', () => {\n          console.log('The data is ' + body)\n          // 第四步：将响应结果转发给浏览器\n          response.end(body)\n        })\n      }\n    )\n    .end()\n})\nserver.listen(3000, () => {\n  console.log('The proxyServer is running at http://localhost:3000')\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("// server2.js(http://localhost:4000)\nconst http = require('http')\nconst data = { title: 'fontend', password: '123456' }\nconst server = http.createServer((request, response) => {\n  if (request.url === '/') {\n    response.end(JSON.stringify(data))\n  }\n})\nserver.listen(4000, () => {\n  console.log('The server is running at http://localhost:4000')\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("上述代码经过两次跨域，值得注意的是浏览器向代理服务器发送请求，也遵循同源策略，最后在"),a("code",[s._v("index.html")]),s._v("文件打印出"),a("code",[s._v('{"title":"fontend","password":"123456"}')])]),s._v(" "),a("h4",{attrs:{id:"_3-9-websocket-协议跨域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-9-websocket-协议跨域","aria-hidden":"true"}},[s._v("#")]),s._v(" 3.9 WebSocket 协议跨域")]),s._v(" "),a("p",[a("code",[s._v("WebSocket protocol")]),s._v("是"),a("code",[s._v("HTML5")]),s._v("一种新的协议。它实现了浏览器与服务器全双工通信，同时允许跨域通讯，是 server push 技术的一种很好的实现。")]),s._v(" "),a("p",[s._v("原生 "),a("code",[s._v("WebSocket API")]),s._v(" 使用起来不太方便，我们使用"),a("code",[s._v("Socket.io")]),s._v("，它很好地封装了"),a("code",[s._v("webSocket")]),s._v("接口，提供了更简单、灵活的接口，也对不支持 "),a("code",[s._v("webSocket")]),s._v(" 的浏览器提供了向下兼容。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("<div>user input：<input type=\"text\"></div>\n<script src=\"./socket.io.js\"><\/script>\n<script>\nvar socket = io('http://www.domain2.com:8080');\n\n// 连接成功处理\nsocket.on('connect', function() {\n    // 监听服务端消息\n    socket.on('message', function(msg) {\n        console.log('data from server: ---\x3e ' + msg);\n    });\n\n    // 监听服务端关闭\n    socket.on('disconnect', function() {\n        console.log('Server socket has closed.');\n    });\n});\n\ndocument.getElementsByTagName('input')[0].onblur = function() {\n    socket.send(this.value);\n};\n<\/script>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("var http = require('http');\nvar socket = require('socket.io');\n\n// 启http服务\nvar server = http.createServer(function(req, res) {\n    res.writeHead(200, {\n        'Content-type': 'text/html'\n    });\n    res.end();\n});\n\nserver.listen('8080');\nconsole.log('Server is running at port 8080...');\n\n// 监听socket连接\nsocket.listen(server).on('connection', function(client) {\n    // 接收信息\n    client.on('message', function(msg) {\n        client.send('hello：' + msg);\n        console.log('data from client: ---\x3e ' + msg);\n    });\n\n    // 断开处理\n    client.on('disconnect', function() {\n        console.log('Client socket has closed.');\n    });\n});\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("h2",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://segmentfault.com/a/1190000011145364",target:"_blank",rel:"noopener noreferrer"}},[s._v("前端常见跨域解决方案（全）"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/ljianshu/Blog/issues/55",target:"_blank",rel:"noopener noreferrer"}},[s._v("九种跨域方式实现原理（完整版)"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/S9NYjMAXq31zbieYBRG-rg",target:"_blank",rel:"noopener noreferrer"}},[s._v("深度解析 CORS 跨域原理及 @koa/cors 源码"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/lishanlei/p/8823823.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("关于 CORS 跨域问题的理解"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/m4DkQBTw0GrHyD1xFoASPA",target:"_blank",rel:"noopener noreferrer"}},[s._v("【第 546 期】CORS 跨站资源共享之一"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/rODpUh25nEhQawtLGz2DCg",target:"_blank",rel:"noopener noreferrer"}},[s._v("【第 547 期】CORS 跨站资源共享之二"),a("OutboundLink")],1)])]),s._v(" "),a("h2",{attrs:{id:"联系作者"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#联系作者","aria-hidden":"true"}},[s._v("#")]),s._v(" 联系作者")]),s._v(" "),a("div",{attrs:{align:"center"}},[a("p",[s._v("\n        平凡世界，贵在坚持。\n    ")]),s._v(" "),a("img",{attrs:{src:s.$withBase("/about/contact.png")}})])])}),[],!1,null,null,null);n.default=t.exports}}]);