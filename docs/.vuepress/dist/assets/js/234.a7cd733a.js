(window.webpackJsonp=window.webpackJsonp||[]).push([[234],{478:function(e,s,n){"use strict";n.r(s);var a=n(4),r=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"错误监控"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#错误监控","aria-hidden":"true"}},[e._v("#")]),e._v(" 错误监控")]),e._v(" "),n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[e._v("#")]),e._v(" 前言")]),e._v(" "),n("p",[e._v("本人平时学习及收集内容，欢迎参入一起讨论。")]),e._v(" "),n("h2",{attrs:{id:"内容"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内容","aria-hidden":"true"}},[e._v("#")]),e._v(" 内容")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8"}},[e._v("为什么要处理异常?")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#%E4%BA%8C%E3%80%81%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%E5%93%AA%E4%BA%9B%E5%BC%82%E5%B8%B8%EF%BC%9F"}},[e._v("需要处理哪些异常？")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#%E4%B8%89%E3%80%81%E9%94%99%E8%AF%AF%E7%9B%91%E6%8E%A7%E7%9A%84%E6%96%B9%E6%B3%95"}},[e._v("错误监控的方法")])])]),e._v(" "),n("h3",{attrs:{id:"一、为什么要处理异常"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、为什么要处理异常","aria-hidden":"true"}},[e._v("#")]),e._v(" 一、为什么要处理异常?")]),e._v(" "),n("p",[e._v("异常是不可控的，会影响最终的呈现结果，但是我们有充分的理由去做这样的事件。")]),e._v(" "),n("ul",[n("li",[e._v("增强用户体验；")]),e._v(" "),n("li",[e._v("远程定位问题；")]),e._v(" "),n("li",[e._v("未雨绸缪，及早发现问题；")]),e._v(" "),n("li",[e._v("无法复线问题，尤其是移动端，机型，系统都是问题；")]),e._v(" "),n("li",[e._v("完善的前端方案，前端监控系统；")])]),e._v(" "),n("h3",{attrs:{id:"二、需要处理哪些异常？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、需要处理哪些异常？","aria-hidden":"true"}},[e._v("#")]),e._v(" 二、需要处理哪些异常？")]),e._v(" "),n("p",[e._v("对于前端来说，我们可以做的异常捕获还真不少，总结一下，大概如下：")]),e._v(" "),n("ul",[n("li",[n("code",[e._v("JS")]),e._v("语法错误、代码异常")]),e._v(" "),n("li",[n("code",[e._v("Ajax")]),e._v("请求异常")]),e._v(" "),n("li",[e._v("静态资源加载异常")]),e._v(" "),n("li",[n("code",[e._v("Promise")]),e._v("异常")]),e._v(" "),n("li",[n("code",[e._v("Iframe")]),e._v("异常")]),e._v(" "),n("li",[e._v("跨域"),n("code",[e._v("Script error")])]),e._v(" "),n("li",[e._v("崩溃和卡顿")])]),e._v(" "),n("h3",{attrs:{id:"三、错误监控的方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、错误监控的方法","aria-hidden":"true"}},[e._v("#")]),e._v(" 三、错误监控的方法")]),e._v(" "),n("ul",[n("li",[e._v("try-catch")]),e._v(" "),n("li",[e._v("onerror")]),e._v(" "),n("li",[e._v("监听 error 事件")]),e._v(" "),n("li",[e._v("unhandledrejection")])]),e._v(" "),n("h4",{attrs:{id:"_3-1-try-catch"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-try-catch","aria-hidden":"true"}},[e._v("#")]),e._v(" 3.1 try-catch")]),e._v(" "),n("p",[n("code",[e._v("try-catch")]),e._v("只能捕获到同步的运行时错误，对语法和异步错误无能为力，捕获不到。")]),e._v(" "),n("p",[n("strong",[e._v("1. 同步运行时的错误：")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("try {\n  let name = 'jartto';\n  console.log(nam);\n} catch(e) {\n  console.log('捕获到异常：',e);\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("p",[e._v("输出：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("捕获到异常： ReferenceError: nam is not defined\n    at <anonymous>:3:15\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[n("strong",[e._v("2. 不能捕获到语法错误")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("try {\n  let name = 'jartto;\n  console.log(nam);\n} catch(e) {\n\n  console.log('捕获到异常：',e);\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v("输出：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Uncaught SyntaxError: Invalid or unexpected token\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[n("strong",[e._v("3. 异步错误")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("try {\n  setTimeout(() => {\n    undefined.map(v => v);\n  }, 1000)\n} catch(e) {\n  console.log('捕获到异常：',e);\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v("输出")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Uncaught TypeError: Cannot read property 'map' of undefined\n    at setTimeout (<anonymous>:3:11)\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("h4",{attrs:{id:"_3-2-window-onerror"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-window-onerror","aria-hidden":"true"}},[e._v("#")]),e._v(" 3.2 window.onerror")]),e._v(" "),n("p",[n("strong",[e._v("1. 同步")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("window.onerror = function(message, source, lineno, colno, error) {\n// message：错误信息（字符串）。\n// source：发生错误的脚本URL（字符串）\n// lineno：发生错误的行号（数字）\n// colno：发生错误的列号（数字）\n// error：Error对象（对象）\nconsole.log('捕获到异常：',{message, source, lineno, colno, error});\n}\nJartto;\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("p",[e._v("捕获到了异常：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("VM243:9 Uncaught ReferenceError: Jartto is not defined\n    at <anonymous>:9:1\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[n("strong",[e._v("2. 语法错误")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("window.onerror = function(message, source, lineno, colno, error) {\nconsole.log('捕获到异常：',{message, source, lineno, colno, error});\n}\nlet name = 'Jartto\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("输出结果：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Uncaught SyntaxError: Invalid or unexpected token\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[n("strong",[e._v("3. 异步")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("window.onerror = function(message, source, lineno, colno, error) {\n    console.log('捕获到异常：',{message, source, lineno, colno, error});\n}\nsetTimeout(() => {\n    Jartto;\n});\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("p",[e._v("输出结果：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('捕获到异常： {message: "Uncaught ReferenceError: Jartto is not defined", source: "http://127.0.0.1:8001/", lineno: 36, colno: 5, error: ReferenceError: Jartto is not defined\n    at setTimeout (http://127.0.0.1:8001/:36:5)}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[n("strong",[e._v("4. 网络请求异常")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("<script>\nwindow.onerror = function(message, source, lineno, colno, error) {\n    console.log('捕获到异常：',{message, source, lineno, colno, error});\n    return true;\n}\n<\/script>\n<img src=\"./jartto.png\">\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v("不论是静态资源异常，或者接口异常，错误都无法捕获到。")]),e._v(" "),n("p",[n("strong",[e._v("结论")])]),e._v(" "),n("p",[n("code",[e._v("onerror")]),e._v("最好写在所有"),n("code",[e._v("JS")]),e._v("脚本的前面，否则有可能捕获不到错误；")]),e._v(" "),n("p",[n("code",[e._v("window.onerror")]),e._v("函数只有在返回"),n("code",[e._v("true")]),e._v("的时候，异常才不会向上抛出，否则即使是知道异常的发生控制台还是会显示"),n("code",[e._v("Uncaught Error: xxxxx")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("window.onerror = function(message, source, lineno, colno, error) {\n    console.log('捕获到异常：',{message, source, lineno, colno, error});\n    return true;\n}\nsetTimeout(() => {\n    Jartto;\n});\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[n("code",[e._v("onerror")]),e._v("无法捕获语法错误；")]),e._v(" "),n("h4",{attrs:{id:"_3-3-监听-error-事件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-监听-error-事件","aria-hidden":"true"}},[e._v("#")]),e._v(" 3.3 监听 error 事件")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("<img src=\"./xxxxx.png\">\nwindow.addEventListener('error', args => {\n    console.log(\n      'error event:', args\n    );\n    return true;\n  },\n  true // 利用捕获方式\n);\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("p",[e._v("运行结果如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('error event： Event:{\n    bubbles: false\n    cancelBubble: false\n    cancelable: false\n    composed: false\n    currentTarget: null\n    defaultPrevented: false\n    eventPhase: 0\n    isTrusted: true\n    path: (5) [img, body, html, document, Window]\n    returnValue: true\n    srcElement: img\n    target: img\n    timeStamp: 373.70499999815365\n    type: "error"\n    __proto__: Event\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br")])]),n("p",[e._v("由于网络请求异常不会事件冒泡，因此必须在捕获阶段将其捕捉到才行，但是这种方式虽然可以捕捉到网络请求的异常，但是无法判断 HTTP 状态是"),n("code",[e._v("404")]),e._v("还是其他状态，所心还需要配合服务端日志才进行排查分析才可以。")]),e._v(" "),n("p",[e._v("注意：")]),e._v(" "),n("ul",[n("li",[e._v("不同浏览器下返回的"),n("code",[e._v("error")]),e._v("对象可能不同，需要注意兼容处理。")]),e._v(" "),n("li",[e._v("需要注意避免"),n("code",[e._v("addEventListener")]),e._v("重复监听。")])]),e._v(" "),n("p",[e._v("结论：监听"),n("code",[e._v("error")]),e._v("事件，可以捕获同步错误，异步错误，网络错误，不能处理"),n("code",[e._v("Promise")]),e._v("错误")]),e._v(" "),n("h4",{attrs:{id:"_3-4-unhandledrejection"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-unhandledrejection","aria-hidden":"true"}},[e._v("#")]),e._v(" 3.4 unhandledrejection")]),e._v(" "),n("p",[e._v("在"),n("code",[e._v("promise")]),e._v("中使用"),n("code",[e._v("catch")]),e._v("可以非常方便的捕获到异步"),n("code",[e._v("error")]),e._v("，如果没有写"),n("code",[e._v("catch")]),e._v("的"),n("code",[e._v("Promise")]),e._v("中抛出的错误无法被"),n("code",[e._v("onerror")]),e._v("或"),n("code",[e._v("try-catch")]),e._v("捕获到，为了防止有漏掉的"),n("code",[e._v("Promise")]),e._v("异步，建议在全局增加一个对"),n("code",[e._v("unhandledrejection")]),e._v("的监听，用来全局监听"),n("code",[e._v("Uncaught Promise Error")]),e._v("。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("window.addEventListener(\"unhandledrejection\", function(e){\n  e.preventDefault()\n  console.log('捕获到异常：', e);\n  return true;\n});\nPromise.reject('promise error');\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("p",[e._v("输出结果：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('PromiseRejectionEvent={\n    bubbles: false\n    cancelBubble: false\n    cancelable: true\n    composed: false\n    currentTarget: Window {parent: Window, opener: null, top: Window, length: 0, frames: Window, …}\n    defaultPrevented: true\n    eventPhase: 0\n    isTrusted: true\n    path: [Window]\n    promise: Promise {<rejected>: "promise error"}\n    reason: "promise error"\n    returnValue: false\n    srcElement: Window {parent: Window, opener: null, top: Window, length: 0, frames: Window, …}\n    target: Window {parent: Window, opener: null, top: Window, length: 0, frames: Window, …}\n    timeStamp: 23.06500000122469\n    type: "unhandledrejection"\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br")])]),n("h4",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结","aria-hidden":"true"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",[e._v("异常类型")]),e._v(" "),n("th",[e._v("同步方法")]),e._v(" "),n("th",[e._v("异步方法")]),e._v(" "),n("th",[e._v("资源加载")]),e._v(" "),n("th",[e._v("Promise")])])]),e._v(" "),n("tbody",[n("tr",[n("td",[e._v("try/catch")]),e._v(" "),n("td",[e._v("可以")]),e._v(" "),n("td",[e._v("不可以")]),e._v(" "),n("td",[e._v("不可以")]),e._v(" "),n("td",[e._v("不可以")])]),e._v(" "),n("tr",[n("td",[e._v("onerror")]),e._v(" "),n("td",[e._v("可以")]),e._v(" "),n("td",[e._v("可以")]),e._v(" "),n("td",[e._v("不可以")]),e._v(" "),n("td",[e._v("不可以")])]),e._v(" "),n("tr",[n("td",[e._v("error 事件监听")]),e._v(" "),n("td",[e._v("可以")]),e._v(" "),n("td",[e._v("可以")]),e._v(" "),n("td",[e._v("可以")]),e._v(" "),n("td",[e._v("可以")])]),e._v(" "),n("tr",[n("td",[e._v("unhandledrejection")]),e._v(" "),n("td",[e._v("不可以")]),e._v(" "),n("td",[e._v("不可以")]),e._v(" "),n("td",[e._v("不可以")]),e._v(" "),n("td",[e._v("可以")])])])]),e._v(" "),n("h3",{attrs:{id:"四、错误监控常见问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四、错误监控常见问题","aria-hidden":"true"}},[e._v("#")]),e._v(" 四、错误监控常见问题")]),e._v(" "),n("ul",[n("li",[e._v("跨域问题")]),e._v(" "),n("li",[e._v("代码压缩后，如何处理定位到代码问题")]),e._v(" "),n("li",[e._v("VUE errorHandler")]),e._v(" "),n("li",[e._v("React 异常捕获")]),e._v(" "),n("li",[e._v("iframe 异常")]),e._v(" "),n("li",[e._v("崩溃和卡顿")])]),e._v(" "),n("h4",{attrs:{id:"_4-1-跨域问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-跨域问题","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.1 跨域问题")]),e._v(" "),n("p",[e._v("一般情况，如果出现"),n("code",[e._v("Script error")]),e._v("这样的错误，基本上可以确定是出现 了跨域问题。这时候不会有其他太多辅助信息的，但是解决思路无非如下：")]),e._v(" "),n("p",[e._v("跨源资源共享机制("),n("code",[e._v("CORS")]),e._v(")：我们为"),n("code",[e._v("crossOrigin")]),e._v("属性。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<script src="http://jartto.wang/main.js" crossorigin><\/script>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("p",[e._v("或者动态去添加 "),n("code",[e._v("js")]),e._v(" 脚本：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const script = document.createElement('script');\nscript.crossOrigin = 'anonymous';\nscript.src = url;\ndocument.body.appendChild(script);\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("特别注意，服务器端需要设置：Access-Control-Allow-Origin")]),e._v(" "),n("p",[e._v("此外，我们也可以试试这个"),n("a",{attrs:{href:"https://juejin.im/post/5c00a405f265da610e7fd024",target:"_blank",rel:"noopener noreferrer"}},[e._v("解决 Script Error 的另类思路"),n("OutboundLink")],1),e._v("：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const originAddEventListener = EventTarget.prototype.addEventListener;\nEventTarget.prototype.addEventListener = function (type, listener, options) {\n  const wrappedListener = function (...args) {\n    try {\n      return listener.apply(this, args);\n    }\n    catch (err) {\n      throw err;\n    }\n  }\n  return originAddEventListener.call(this, type, wrappedListener, options);\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br")])]),n("p",[e._v("解释一下：")]),e._v(" "),n("h4",{attrs:{id:"_4-2-代码压缩后，如何处理定位到代码问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-代码压缩后，如何处理定位到代码问题","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.2 代码压缩后，如何处理定位到代码问题")]),e._v(" "),n("p",[e._v("如果想将错误和原有的代码关联起来就需要"),n("code",[e._v("sourcemap")]),e._v("文件。")]),e._v(" "),n("p",[n("strong",[e._v("sourceMap 是什么")])]),e._v(" "),n("p",[n("code",[e._v("sourceMap")]),e._v("就是一个文件，里面储存着位置信息。这个文件里保存的，是转换后代码的位置，和对应的转换前的位置。")]),e._v(" "),n("p",[n("strong",[e._v("webpack 插件实现 SourceMap 上传")])]),e._v(" "),n("p",[e._v("在 webpack 的打包时会产生"),n("code",[e._v("sourcemap")]),e._v("文件，这个文件需要上传到异常监控服务器这个功能我们用 webpack 插件完成。")]),e._v(" "),n("p",[e._v("创建 webpack 插件")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const fs = require('fs')\nvar http = require('http');\n\nclass UploadSourceMapWebpackPlugin {\n    constructor(options){\n        this.options = options\n    }\n\n    apply(compiler){\n        // 打包结束后执行\n        compiler.hooks.done.tap('upload-sourcemap-plugin',status=>{\n            // 读取sourcemap文件\n            const list = glob.sync(status.compilation.outputOptions.path,`./**/*.{js.map,}`)\n            for(let  filename of list){\n                await this.upload(this.options.uploadUrl,filename)\n            }\n        })\n    }\n}\n\nupload(url,file){\n    return new Promise(resolve =>{\n        console.log('uploadMaps',file)\n\n        const req = http.request(`${url}?name=${path.basename(file)}`,{\n            method:'post',\n            headers:{\n                'Content-Type':'application/octet-stream',\n                'Connection':'keep-alive',\n                \"Transfer-Encoding\": \"chunked\"\n            }\n        })\n        fs.createReadStream(file).on('data',chunk=>{\n            req.write(chunk);\n        }).on('end',()=>{\n            req.end();\n            resolve()\n        })\n    })\n}\n\nmodule.exports = UploadSourceMapWebpackPlugin\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br"),n("span",{staticClass:"line-number"},[e._v("40")]),n("br"),n("span",{staticClass:"line-number"},[e._v("41")]),n("br"),n("span",{staticClass:"line-number"},[e._v("42")]),n("br")])]),n("p",[e._v("加载 webpack 插件")]),e._v(" "),n("p",[n("code",[e._v("webpack.config.js")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("// 自动上传Map\nvar UploadSourceMapWebpackPlugin = require('./')\n\nplugins:[\n    // 添加自动上传插件\n    new UploadSourceMapWebpackPlugin({\n        uploadUrl:'http://report.xiaowuzi.info/monitor/sourcemap',\n        apiKey:'nidaye'\n    })\n]\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br")])]),n("p",[n("strong",[e._v("反序列 Error 对象")])]),e._v(" "),n("p",[e._v("首先创建一个新的 Error 对象将错误栈设置到 Error 中，然后利用"),n("code",[e._v("error-stack-parser")]),e._v("这个 npm 库来转化为"),n("code",[e._v("stackFrame")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const ErrorStackParser= require('error-stack-parser')\n\nparseStackTrack(stack,message){\n    const error = new Error(message)\n    error.stack = stack\n    const stackFrame = ErrorStackParser.parse(error)\n    return stackFrame\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br")])]),n("p",[n("strong",[e._v("解析 ErrorStack")])]),e._v(" "),n("p",[e._v("我们将错误栈中的代码位置转换为源码位置")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const { SourceMapConsumer } = require(\"source-map\");\nasync getOriginalErrorStack(stackFrame) {\n        const origin = []\n        for (let v of stackFrame) {\n            origin.push(await this.getOriginPosition(v))\n        }\n\n        // 销毁所有consumers\n        Object.keys(this.consumers).forEach(key => {\n            console.log('key:',key)\n            this.consumers[key].destroy()\n        })\n        return origin\n    }\n\n    async getOriginPosition(stackFrame) {\n        let { columnNumber, lineNumber, fileName } = stackFrame\n        fileName = path.basename(fileName)\n        console.log('filebasename',fileName)\n        // 判断是否存在\n        let consumer = this.consumers[fileName]\n\n        if (consumer === undefined) {\n            // 读取sourcemap\n            const sourceMapPath = path.resolve(this.sourceMapDir, fileName + '.map')\n            // 判断目录是否存在\n            if(!fs.existsSync(sourceMapPath)){\n                return stackFrame\n            }\n            const content = fs.readFileSync(sourceMapPath, 'utf8')\n            consumer = await new SourceMapConsumer(content, null);\n            this.consumers[fileName] = consumer\n        }\n        const parseData = consumer.originalPositionFor({ line:lineNumber, column:columnNumber })\n        return parseData\n    }\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br")])]),n("h4",{attrs:{id:"_4-3-vue-errorhandler"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-vue-errorhandler","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.3 VUE errorHandler")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Vue.config.errorHandler = (err, vm, info) => {\n  console.error('通过vue errorHandler捕获的错误');\n  console.error(err);\n  console.error(vm);\n  console.error(info);\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("h4",{attrs:{id:"_4-4-react-异常捕获"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-react-异常捕获","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.4 React 异常捕获")]),e._v(" "),n("p",[n("code",[e._v("React 16")]),e._v("提供了一个内置函数"),n("code",[e._v("componentDidCatch")]),e._v("，使用它可以非常简单的获取到"),n("code",[e._v("react")]),e._v("下的错误信息")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("componentDidCatch(error, info) {\n    console.log(error, info);\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br")])]),n("p",[e._v("除此之外，我们可以了解一下："),n("code",[e._v("[error boundary](https://blog.csdn.net/a986597353/article/details/78469979)")]),e._v("，"),n("code",[e._v("UI")]),e._v("的某部分引起的"),n("code",[e._v("JS")]),e._v("错误不应该破坏整个程序，为了帮"),n("code",[e._v("React")]),e._v("的使用者解决这个问题，"),n("code",[e._v("React 16")]),e._v("介绍了一种关于错误边界的新观念。")]),e._v(" "),n("p",[e._v("需要注意的是：error boundaries 并不会捕捉下面这些错误。")]),e._v(" "),n("ul",[n("li",[e._v("事件处理器")]),e._v(" "),n("li",[e._v("异步代码")]),e._v(" "),n("li",[e._v("服务端的渲染代码")]),e._v(" "),n("li",[e._v("在 error boundaries 区域内的错误")])]),e._v(" "),n("h4",{attrs:{id:"_4-5-frame-异常"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-frame-异常","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.5 frame 异常")]),e._v(" "),n("p",[e._v("对于"),n("code",[e._v("iframe")]),e._v("的异常捕获，我们还得借力"),n("code",[e._v("window.onerror")]),e._v("：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("window.onerror = function(message, source, lineno, colno, error) {\n  console.log('捕获到异常：',{message, source, lineno, colno, error});\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br")])]),n("p",[e._v("一个简单的例子可能如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<iframe src="./iframe.html" frameborder="0"></iframe>\n<script>\n  window.frames[0].onerror = function (message, source, lineno, colno, error) {\n    console.log(\'捕获到 iframe 异常：\',{message, source, lineno, colno, error});\n    return true;\n  };\n<\/script>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v("一个简单的例子可能如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<iframe src="./iframe.html" frameborder="0"></iframe>\n<script>\n  window.frames[0].onerror = function (message, source, lineno, colno, error) {\n    console.log(\'捕获到 iframe 异常：\',{message, source, lineno, colno, error});\n    return true;\n  };\n<\/script>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("h4",{attrs:{id:"_4-6-崩溃和卡顿"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-6-崩溃和卡顿","aria-hidden":"true"}},[e._v("#")]),e._v(" 4.6 崩溃和卡顿")]),e._v(" "),n("p",[e._v("卡顿也是网页暂时响应比较慢，"),n("code",[e._v("JS")]),e._v("可能无法及时执行。但崩溃就不一样了，网页都崩溃了，"),n("code",[e._v("JS")]),e._v("都不行了，还有什么办法可以监控网页的崩溃，并将网页崩溃上报呢？")]),e._v(" "),n("p",[e._v("崩溃和卡顿也是不可忽视的，也话会导致你的用户流失。")]),e._v(" "),n("p",[n("strong",[e._v("1. 利用"),n("code",[e._v("window")]),e._v("对象的"),n("code",[e._v("load")]),e._v("和"),n("code",[e._v("beforeunload")]),e._v("事件实现了网页崩溃的监控。")])]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("window.addEventListener('load', function () {\n    sessionStorage.setItem('good_exit', 'pending');\n    setInterval(function () {\n        sessionStorage.setItem('time_before_crash', new Date().toString());\n    }, 1000);\n  });\n\n  window.addEventListener('beforeunload', function () {\n    sessionStorage.setItem('good_exit', 'true');\n  });\n\n  if(sessionStorage.getItem('good_exit') &&\n    sessionStorage.getItem('good_exit') !== 'true') {\n    /*\n        insert crash logging code here\n    */\n    alert('Hey, welcome back from your crash, looks like you crashed on: ' + sessionStorage.getItem('time_before_crash'));\n  }\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br")])]),n("p",[e._v("参考资料："),n("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/39292837",target:"_blank",rel:"noopener noreferrer"}},[e._v("如何监控网页的卡顿？"),n("OutboundLink")],1)]),e._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[e._v("基于以下原因，我们可以使用"),n("code",[e._v("Service Worker")]),e._v("来实现"),n("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/40273861",target:"_blank",rel:"noopener noreferrer"}},[e._v("如何监控网页崩溃？"),n("OutboundLink")],1)])]),e._v(" "),n("ul",[n("li",[n("code",[e._v("Service Worker")]),e._v("有自己独立的工作线程，与网页区分开，网页崩溃了，"),n("code",[e._v("Servie Worker")]),e._v("一般情况下不会崩溃；")]),e._v(" "),n("li",[n("code",[e._v("Service Woker")]),e._v("生命周期一般要比网页还要长，可以用来监控网页的状态；")]),e._v(" "),n("li",[e._v("网页可以通过"),n("code",[e._v("navigator.serviceWorker.controller.postMessage API")]),e._v("向掌管自己的"),n("code",[e._v("SW")]),e._v("发送消息。")])]),e._v(" "),n("h3",{attrs:{id:"五、错误上传"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五、错误上传","aria-hidden":"true"}},[e._v("#")]),e._v(" 五、错误上传")]),e._v(" "),n("h4",{attrs:{id:"_5-1-动态创建-img-标签"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-动态创建-img-标签","aria-hidden":"true"}},[e._v("#")]),e._v(" 5.1 动态创建 img 标签")]),e._v(" "),n("p",[e._v("其实上报就是要将捕获的异常信息发送到后端。最常用的方式首推动态创建标签方式。因为这种方式无需加载任何通讯库，而且页面是无需刷新的。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("new Image().src = 'http://localhost:7001/monitor/error'+ '?info=xxxxxx'\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br")])]),n("h4",{attrs:{id:"_5-2-ajax-上报"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-ajax-上报","aria-hidden":"true"}},[e._v("#")]),e._v(" 5.2 Ajax 上报")]),e._v(" "),n("p",[e._v("实际上我们也可以用 ajax 的方式上报错误，这和我们再业务程序中并没有什么区别。在这里就不赘述。")]),e._v(" "),n("h3",{attrs:{id:"参考资料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[e._v("#")]),e._v(" 参考资料")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://juejin.im/post/5e5e423ae51d4527041172b6",target:"_blank",rel:"noopener noreferrer"}},[e._v("使用 vue+node 搭建前端异常监控系统"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s/JEDt9BL2eWpVTrtbfEPiAA",target:"_blank",rel:"noopener noreferrer"}},[e._v("接入 sentry-让你的错误别再裸奔"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/51800345",target:"_blank",rel:"noopener noreferrer"}},[e._v("如何优雅处理前端异常？"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/31979395",target:"_blank",rel:"noopener noreferrer"}},[e._v("前端代码异常监控实战"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://cdc.tencent.com/2018/09/13/frontend-exception-monitor-research/",target:"_blank",rel:"noopener noreferrer"}},[e._v("前端异常监控解决方案研究"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"http://unclechen.github.io/2018/06/24/%E6%8F%AD%E5%BC%80JS%E6%97%A0%E5%9F%8B%E7%82%B9%E6%8A%80%E6%9C%AF%E7%9A%84%E7%A5%9E%E7%A7%98%E9%9D%A2%E7%BA%B1/",target:"_blank",rel:"noopener noreferrer"}},[e._v("揭开 JS 无埋点技术的神秘面纱"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s/LGbMXauSuuGWcvqazjXWjQ",target:"_blank",rel:"noopener noreferrer"}},[e._v("【第 790 期】构建可靠的前端异常监控服务-采集篇"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://juejin.im/post/5e3146cce51d453176604809",target:"_blank",rel:"noopener noreferrer"}},[e._v("撸一个前端监控系统（React + Node + Mysql + Webpack plugin + Docker）—— （上）"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://juejin.im/post/5e6b16315188254963277621",target:"_blank",rel:"noopener noreferrer"}},[e._v("转转商业前端错误监控系统(Sentry)策略升级"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s/_AaZXxvMMFjHAynXylsjrw",target:"_blank",rel:"noopener noreferrer"}},[e._v("【第 833 期】如何设计一个前端监控系统"),n("OutboundLink")],1)])]),e._v(" "),n("h2",{attrs:{id:"联系作者"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#联系作者","aria-hidden":"true"}},[e._v("#")]),e._v(" 联系作者")]),e._v(" "),n("div",{attrs:{align:"center"}},[n("p",[e._v("\n        平凡世界，贵在坚持。\n    ")]),e._v(" "),n("img",{attrs:{src:e.$withBase("/about/contact.png")}})]),e._v("\n```\n")])}),[],!1,null,null,null);s.default=r.exports}}]);