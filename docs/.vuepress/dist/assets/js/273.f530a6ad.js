(window.webpackJsonp=window.webpackJsonp||[]).push([[273],{503:function(a,s,e){"use strict";e.r(s);var t=e(4),r=Object(t.a)({},(function(){var a=this,s=a.$createElement,e=a._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"pm2-工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pm2-工具","aria-hidden":"true"}},[a._v("#")]),a._v(" pm2 工具")]),a._v(" "),e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[a._v("#")]),a._v(" 前言")]),a._v(" "),e("p",[a._v("pm2 是 node 进程管理工具，可以利用它来简化很多 node 应用管理的繁琐任务，如性能监控、自动重启、负载均衡等，因为在工作中遇到服务器重启后，需要一个个去重新启动每个服务，这样不仅繁琐、效率低，而且容易遗忘开启一些服务。")]),a._v(" "),e("h2",{attrs:{id:"内容"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#内容","aria-hidden":"true"}},[a._v("#")]),a._v(" 内容")]),a._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"#%E4%B8%80%E3%80%81%E5%AE%89%E8%A3%85-%E7%9B%AE%E5%BD%95"}},[a._v("安装&目录")])]),a._v(" "),e("li",[e("a",{attrs:{href:"#%E4%BA%8C%E3%80%81%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"}},[a._v("常用命令")])]),a._v(" "),e("li",[e("a",{attrs:{href:"#%E4%B8%89%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"}},[a._v("配置文件")])]),a._v(" "),e("li",[e("a",{attrs:{href:"#%E5%9B%9B%E3%80%81%E9%AB%98%E9%98%B6%E5%BA%94%E7%94%A8"}},[a._v("高阶应用")])])]),a._v(" "),e("h3",{attrs:{id:"一、安装-目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、安装-目录","aria-hidden":"true"}},[a._v("#")]),a._v(" 一、安装&目录")]),a._v(" "),e("h4",{attrs:{id:"_1-1-运行以下命令进行全局安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-运行以下命令进行全局安装","aria-hidden":"true"}},[a._v("#")]),a._v(" 1.1 运行以下命令进行全局安装")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npm install -g pm2\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("h4",{attrs:{id:"_1-2-安装完之后，会自动创建以下目录："}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-安装完之后，会自动创建以下目录：","aria-hidden":"true"}},[a._v("#")]),a._v(" 1.2 安装完之后，会自动创建以下目录：")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("$HOME/.pm2/logs // 包括所有应用的日志\n$HOME/.pm2/pids // 包括所有应用的 pids\n$HOME/.pm2/dump.pm2 // 开机自启动配置\n$HOME/.pm2/pm2.log // pm2 日志\n$HOME/.pm2/pm2.pid // pm2 pid\n\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br")])]),e("h3",{attrs:{id:"二、常用命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、常用命令","aria-hidden":"true"}},[a._v("#")]),a._v(" 二、常用命令")]),a._v(" "),e("h4",{attrs:{id:"_2-1-启动命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-启动命令","aria-hidden":"true"}},[a._v("#")]),a._v(" 2.1 启动命令")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 start app.js\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("启动成功后，我们对应可以看到启动的服务的一些信息，如下所示：")]),a._v(" "),e("p",[e("img",{attrs:{src:"pm2-01.png",alt:"images"}})]),a._v(" "),e("h4",{attrs:{id:"_2-2-命令行参数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-命令行参数","aria-hidden":"true"}},[a._v("#")]),a._v(" 2.2 命令行参数")]),a._v(" "),e("p",[a._v("我们可以在最基本的启动命令后面，添加一些参数选项，去满足我们的需求，常用的参数选项如下所示：")]),a._v(" "),e("ul",[e("li",[e("code",[a._v("--watch")]),a._v("：监听应用目录的变化，一旦发生变化，自动重启。")]),a._v(" "),e("li",[e("code",[a._v("-i or --instance")]),a._v("：启用多少个实例，可用于负载均衡，如果-i 0 或或者-i max，则根据当前机器核数确定实例数目。")]),a._v(" "),e("li",[e("code",[a._v("--ingore-watch")]),a._v("：排队监听的目录或文件，可以是特定的文件名，也可以是与此正则。")]),a._v(" "),e("li",[e("code",[a._v("-n or --name")]),a._v("：应用的名称，查看应用信息的时候可以用到。")]),a._v(" "),e("li",[e("code",[a._v("-o or --output path")]),a._v("：标准输出日志文件的路径。")]),a._v(" "),e("li",[e("code",[a._v("-e or --error path")]),a._v("：错误输出日志文件的路径")])]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 start app.js --watch -i max -n first_app\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("启动成功后的截图如下，我们通过截图可以看到启动的应用名称变为 first_app，然后启动四个进程，说明我们在启动命令后面添加的参数已经起作用。")]),a._v(" "),e("p",[e("img",{attrs:{src:"pm2-02.png",alt:"images"}})]),a._v(" "),e("h4",{attrs:{id:"_2-3-重启命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-重启命令","aria-hidden":"true"}},[a._v("#")]),a._v(" 2.3 重启命令")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 restart app.js\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("h4",{attrs:{id:"_2-4-停止命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-停止命令","aria-hidden":"true"}},[a._v("#")]),a._v(" 2.4 停止命令")]),a._v(" "),e("p",[a._v("停止特定的应用，可以通过 pm2 list 先获取应用的名字或者进程的 id，然后再调用以下命令停止相应的应用；")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 stop app_name | app_id\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("如果需要停止全部的应用，则使用以下命令：")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 stop all\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("h4",{attrs:{id:"_2-5-删除命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-删除命令","aria-hidden":"true"}},[a._v("#")]),a._v(" 2.5 删除命令")]),a._v(" "),e("p",[a._v("删除特定的应用，可以通过 pm2 list 先获取应用的名字或者")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 delete app_name | app_id\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("如果需要删除全部的应用，则使用以下命令：")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 delete all\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("h4",{attrs:{id:"_2-6-查看有哪些进程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-查看有哪些进程","aria-hidden":"true"}},[a._v("#")]),a._v(" 2.6 查看有哪些进程")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 list\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("h4",{attrs:{id:"_2-7-查看某个进程的信息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-7-查看某个进程的信息","aria-hidden":"true"}},[a._v("#")]),a._v(" 2.7 查看某个进程的信息")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 descripe app_name | app_id\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("相应的进程信息输出如下所示：")]),a._v(" "),e("p",[e("img",{attrs:{src:"pm2-03.png",alt:"images"}})]),a._v(" "),e("h3",{attrs:{id:"三、配置文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、配置文件","aria-hidden":"true"}},[a._v("#")]),a._v(" 三、配置文件")]),a._v(" "),e("p",[a._v('如果我们使用命令行参数定义一些选项，那么每次启动进程时，都需要敲上一大堆的命令，非常繁琐；所以我们可以使用配置文件来将命令行参数进行配置，配置文件里的配置项跟命令行参数是基本一致的；如下所示，我们在项目 中添加 pm2 的配置文件 pm2.json ，然后在 package.json 文件中配置启动命令 "pm2": "pm2 start pm2.json" ，这样我们只需要运行 npm run pm2 就可以使用 pm2 启动我们的 express 项目，并且相关运行参数直接在 pm2.json 中配置好了。')]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v('{\n    "apps":{\n        "name": "project",  // 项目名\n        "script":"app.js",  // 执行文件\n        "cwd":"./",         // 根目录\n        "args":"",          // 传递给脚本的参数\n        "interpreter":"",      // 指定的脚本解释器\n        "interpreter_args":"",  // 传递给解释器的参数\n        "watch":true,       // 是否监听文件变动然后重启\n        "ignore_watch": [    // 不用监听的文件\n            "node_modules",\n            "public"\n        ],\n       "exec_mode": "cluster_mode"      // 应用启动模式，支持fork和cluster模式\n       "instances": "max"   //\n    }\n}\n')])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br"),e("span",{staticClass:"line-number"},[a._v("4")]),e("br"),e("span",{staticClass:"line-number"},[a._v("5")]),e("br"),e("span",{staticClass:"line-number"},[a._v("6")]),e("br"),e("span",{staticClass:"line-number"},[a._v("7")]),e("br"),e("span",{staticClass:"line-number"},[a._v("8")]),e("br"),e("span",{staticClass:"line-number"},[a._v("9")]),e("br"),e("span",{staticClass:"line-number"},[a._v("10")]),e("br"),e("span",{staticClass:"line-number"},[a._v("11")]),e("br"),e("span",{staticClass:"line-number"},[a._v("12")]),e("br"),e("span",{staticClass:"line-number"},[a._v("13")]),e("br"),e("span",{staticClass:"line-number"},[a._v("14")]),e("br"),e("span",{staticClass:"line-number"},[a._v("15")]),e("br"),e("span",{staticClass:"line-number"},[a._v("16")]),e("br"),e("span",{staticClass:"line-number"},[a._v("17")]),e("br")])]),e("h3",{attrs:{id:"四、高阶应用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、高阶应用","aria-hidden":"true"}},[a._v("#")]),a._v(" 四、高阶应用")]),a._v(" "),e("h4",{attrs:{id:"_4-1-负载均衡"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-负载均衡","aria-hidden":"true"}},[a._v("#")]),a._v(" 4.1 负载均衡")]),a._v(" "),e("p",[a._v("可以使用-i 参数配置集群数，实现负载均衡，相关命令以下，可以查看"),e("a",{attrs:{href:"https://pm2.keymetrics.io/docs/usage/cluster-mode/",target:"_blank",rel:"noopener noreferrer"}},[a._v("官网章节"),e("OutboundLink")],1),a._v("；")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 start app.js -i 3   // 开启三个进程\npm2 start app.js -i max // 根据机器CPU核器，开启对应数目的进程\n\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br"),e("span",{staticClass:"line-number"},[a._v("3")]),e("br")])]),e("h4",{attrs:{id:"_4-2-日志查看"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-日志查看","aria-hidden":"true"}},[a._v("#")]),a._v(" 4.2 日志查看")]),a._v(" "),e("p",[a._v("我们可以通过打开日志文件查看日志外，还可以通过 pm2 logs 来查看裡日志，这点有对于线上问题排查，日志查看命令如下：")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 logs\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("则我们可以在命令窗口实时看到日志输出：")]),a._v(" "),e("p",[e("img",{attrs:{src:"pm2-05.png",alt:"images"}})]),a._v(" "),e("h4",{attrs:{id:"_4-3-监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-监控","aria-hidden":"true"}},[a._v("#")]),a._v(" 4.3 监控")]),a._v(" "),e("p",[a._v("我们可以使用以下命令，查看当前通过 pm2 运行的进程的状态：")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 monit\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("p",[a._v("动态监控界面如下所示：")]),a._v(" "),e("p",[e("img",{attrs:{src:"pm2-04.png",alt:"images"}})]),a._v(" "),e("h4",{attrs:{id:"_4-4-内存超过使用上限自动重启"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-内存超过使用上限自动重启","aria-hidden":"true"}},[a._v("#")]),a._v(" 4.4 内存超过使用上限自动重启")]),a._v(" "),e("p",[a._v("我们可以使用 --max-memory-restart 参数来限制内存使用上限，当超过使用内存上限后自动重启：")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 start app.js --max-memory-restart 100M\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("h4",{attrs:{id:"_4-5-开机自启动"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-5-开机自启动","aria-hidden":"true"}},[a._v("#")]),a._v(" 4.5 开机自启动")]),a._v(" "),e("p",[a._v("在 linux 中，设置开机自动启动，只需要执行以下两个步骤：")]),a._v(" "),e("ul",[e("li",[a._v("运行"),e("code",[a._v("pm2 startup")]),a._v("，即在"),e("code",[a._v("/etc/init.d")]),a._v("目录下生成"),e("code",[a._v("pm2-root")]),a._v("的启动脚本，且自动将"),e("code",[a._v("pm2-root")]),a._v("设为服务；")]),a._v(" "),e("li",[a._v("运行"),e("code",[a._v("pm2 save")]),a._v("，会将当前 pm2 所运行的应用保存在"),e("code",[a._v("/root/.pm2/dump.pm2")]),a._v("下，当开机重启时，运行"),e("code",[a._v("pm2-root")]),a._v("服务脚本，并且到"),e("code",[a._v("/root/.pm2/dump.pm2")]),a._v("下读取应用并启动；")])]),a._v(" "),e("p",[a._v("但在 windows 中运行 pm2 startup 时，会报以下错误，因为其不适合 windows 系统；")]),a._v(" "),e("p",[e("img",{attrs:{src:"pm2-06.png",alt:"images"}})]),a._v(" "),e("p",[a._v("我们需要额外安装其它库，如下所示：")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("npm install pm2-windows-startup -g\npm2-startup install\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br"),e("span",{staticClass:"line-number"},[a._v("2")]),e("br")])]),e("p",[a._v("然后我们只需要运行以下保存命令，就可以将现在正在运行的服务添加到开机自启动命令中；后面即服务器开机重启，也会将我们保存的服务自动重启；")]),a._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("pm2 save\n")])]),a._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[a._v("1")]),e("br")])]),e("h3",{attrs:{id:"参考资料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[a._v("#")]),a._v(" 参考资料")]),a._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://juejin.im/post/5e1fa941e51d451c774dcc18",target:"_blank",rel:"noopener noreferrer"}},[a._v("pm2 实践指南"),e("OutboundLink")],1)]),a._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/chyingp/p/pm2-documentation.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("PM2 实用入门指南"),e("OutboundLink")],1)]),a._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/tugenhua0707/p/10230975.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("学习使用 PM2 管理 nodejs 进程"),e("OutboundLink")],1)])]),a._v(" "),e("h2",{attrs:{id:"联系作者"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#联系作者","aria-hidden":"true"}},[a._v("#")]),a._v(" 联系作者")]),a._v(" "),e("div",{attrs:{align:"center"}},[e("p",[a._v("\n        平凡世界，贵在坚持。\n    ")]),a._v(" "),e("img",{attrs:{src:a.$withBase("/about/contact.png")}})]),a._v("\n```\n")])}),[],!1,null,null,null);s.default=r.exports}}]);