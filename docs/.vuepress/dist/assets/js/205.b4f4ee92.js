(window.webpackJsonp=window.webpackJsonp||[]).push([[205],{429:function(e,s,n){"use strict";n.r(s);var a=n(4),t=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"keep-alive-学习"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#keep-alive-学习","aria-hidden":"true"}},[e._v("#")]),e._v(" keep-alive 学习")]),e._v(" "),n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言","aria-hidden":"true"}},[e._v("#")]),e._v(" 前言")]),e._v(" "),n("p",[e._v("本人平时学习及收集内容，欢迎参入一起讨论。")]),e._v(" "),n("h2",{attrs:{id:"内容"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内容","aria-hidden":"true"}},[e._v("#")]),e._v(" 内容")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"#%E4%B8%80%E3%80%81%E7%94%A8%E6%B3%95"}},[e._v("用法")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#%E4%BA%8C%E3%80%81%E5%8E%9F%E7%90%86"}},[e._v("实现原理")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#%E4%B8%89%E3%80%81%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5"}},[e._v("缓存策略")])])]),e._v(" "),n("h3",{attrs:{id:"一、用法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、用法","aria-hidden":"true"}},[e._v("#")]),e._v(" 一、用法")]),e._v(" "),n("p",[e._v("官方文档中"),n("code",[e._v("keep-alive")]),e._v("的用法。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('<keep-alive>\n  <component :is="view"></component>\n</keep-alive>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br")])]),n("h4",{attrs:{id:"_1-1-props"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-props","aria-hidden":"true"}},[e._v("#")]),e._v(" 1.1 props")]),e._v(" "),n("ul",[n("li",[e._v("includes：只有名称匹配的组件才会被缓存")]),e._v(" "),n("li",[e._v("excludes：任何名称匹配的组件都不会被缓存")]),e._v(" "),n("li",[e._v("max：最多可以缓存多少组件实例")])]),e._v(" "),n("p",[n("code",[e._v("include")]),e._v("和"),n("code",[e._v("exlude")]),e._v("属性允许组件有条件地缓存。二者都可以用逗号分隔字符串，正则表达式或一个数组来表示：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('\x3c!-- 逗号分隔字符串 --\x3e\n<keep-alive include="a,b">\n  <component :is="view"></component>\n</keep-alive>\n\n\x3c!-- 正则表达式 (使用 `v-bind`) --\x3e\n<keep-alive :include="/a|b/">\n  <component :is="view"></component>\n</keep-alive>\n\n\x3c!-- 数组 (使用 `v-bind`) --\x3e\n<keep-alive :include="[\'a\', \'b\']">\n  <component :is="view"></component>\n</keep-alive>\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br")])]),n("h4",{attrs:{id:"_1-2-用法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-用法","aria-hidden":"true"}},[e._v("#")]),e._v(" 1.2 用法")]),e._v(" "),n("ul",[n("li",[n("code",[e._v("keep-alive")]),e._v(" 包裹动态组件时，会缓存不活动的组件实例，而不是销毁他们。")]),e._v(" "),n("li",[e._v("当组件在"),n("code",[e._v("kepp-alive")]),e._v("内被切换，如果"),n("strong",[e._v("再次渲染")]),e._v("的不会执行"),n("code",[e._v("created")]),e._v("、"),n("code",[e._v("mounted")]),e._v("等钩子函数，它的"),n("code",[e._v("activated")]),e._v("和"),n("code",[e._v("deactivated")]),e._v("两个生命周期钩子函数将会被执行。")])]),e._v(" "),n("h3",{attrs:{id:"二、原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、原理","aria-hidden":"true"}},[e._v("#")]),e._v(" 二、原理")]),e._v(" "),n("h4",{attrs:{id:"_2-1-源码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-源码","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.1 源码")]),e._v(" "),n("p",[n("code",[e._v("<keep-alive>")]),e._v("组件的定义位于源码的"),n("code",[e._v("src/core/components/keep-alive.js")]),e._v("文件中，如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const patternTypes: Array<Function> = [String, RegExp, Array]\n\nexport default {\n  name: 'keep-alive',\n  abstract: true,\n\n  props: {\n    include: patternTypes,\n    exclude: patternTypes,\n    max: [String, Number]\n  },\n\n  created () {\n    this.cache = Object.create(null)\n    this.keys = []\n  },\n\n  destroyed () {\n    for (const key in this.cache) {\n      pruneCacheEntry(this.cache, key, this.keys)\n    }\n  },\n\n  mounted () {\n    this.$watch('include', val => {\n      pruneCache(this, name => matches(val, name))\n    })\n    this.$watch('exclude', val => {\n      pruneCache(this, name => !matches(val, name))\n    })\n  },\n\n  render () {\n    const slot = this.$slots.default\n    const vnode = getFirstComponentChild(slot)\n    const componentOptions  = vnode && vnode.componentOptions\n    if (componentOptions) {\n      // check pattern\n      const name = getComponentName(componentOptions)\n      const { include, exclude } = this\n      if ((include && (!name || !matches(include, name))) || (exclude && name && matches(exclude, name))) {\n        return vnode\n      }\n\n      const { cache, keys } = this\n      const key = vnode.key == null\n        ? componentOptions.Ctor.cid + (componentOptions.tag ? `::${componentOptions.tag}` : '')\n        : vnode.key\n      if (cache[key]) {\n        vnode.componentInstance = cache[key].componentInstance\n        remove(keys, key)\n        keys.push(key)\n      } else {\n        cache[key] = vnode\n        keys.push(key)\n        if (this.max && keys.length > parseInt(this.max)) {\n          pruneCacheEntry(cache, keys[0], keys, this._vnode)\n        }\n      }\n\n      vnode.data.keepAlive = true\n    }\n    return vnode || (slot && slot[0])\n  }\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br"),n("span",{staticClass:"line-number"},[e._v("40")]),n("br"),n("span",{staticClass:"line-number"},[e._v("41")]),n("br"),n("span",{staticClass:"line-number"},[e._v("42")]),n("br"),n("span",{staticClass:"line-number"},[e._v("43")]),n("br"),n("span",{staticClass:"line-number"},[e._v("44")]),n("br"),n("span",{staticClass:"line-number"},[e._v("45")]),n("br"),n("span",{staticClass:"line-number"},[e._v("46")]),n("br"),n("span",{staticClass:"line-number"},[e._v("47")]),n("br"),n("span",{staticClass:"line-number"},[e._v("48")]),n("br"),n("span",{staticClass:"line-number"},[e._v("49")]),n("br"),n("span",{staticClass:"line-number"},[e._v("50")]),n("br"),n("span",{staticClass:"line-number"},[e._v("51")]),n("br"),n("span",{staticClass:"line-number"},[e._v("52")]),n("br"),n("span",{staticClass:"line-number"},[e._v("53")]),n("br"),n("span",{staticClass:"line-number"},[e._v("54")]),n("br"),n("span",{staticClass:"line-number"},[e._v("55")]),n("br"),n("span",{staticClass:"line-number"},[e._v("56")]),n("br"),n("span",{staticClass:"line-number"},[e._v("57")]),n("br"),n("span",{staticClass:"line-number"},[e._v("58")]),n("br"),n("span",{staticClass:"line-number"},[e._v("59")]),n("br"),n("span",{staticClass:"line-number"},[e._v("60")]),n("br"),n("span",{staticClass:"line-number"},[e._v("61")]),n("br"),n("span",{staticClass:"line-number"},[e._v("62")]),n("br"),n("span",{staticClass:"line-number"},[e._v("63")]),n("br"),n("span",{staticClass:"line-number"},[e._v("64")]),n("br"),n("span",{staticClass:"line-number"},[e._v("65")]),n("br")])]),n("p",[e._v("组件内没有常规的"),n("code",[e._v("<template></template>")]),e._v("标签，取而代之的"),n("code",[e._v("render")]),e._v("函数，所以它不是一个常规的模板组件，而是一个函数式组件。执行"),n("code",[e._v("<keep-alive>")]),e._v("组件渲染的时候，就会执行这个"),n("code",[e._v("render")]),e._v("函数。")]),e._v(" "),n("h4",{attrs:{id:"_2-2-props"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-props","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.2 props")]),e._v(" "),n("p",[e._v("在"),n("code",[e._v("props")]),e._v("选项内接收传进来的三个属性："),n("code",[e._v("include")]),e._v("、"),n("code",[e._v("exclude")]),e._v("和"),n("code",[e._v("max")]),e._v("。如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("props: {\n    include: [String, RegExp, Array],\n    exclude: [String, RegExp, Array],\n    max: [String, Number]\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("p",[n("code",[e._v("include")]),e._v("表示只有匹配到的组件被缓存，而"),n("code",[e._v("exclude")]),e._v("表示任何匹配到的组件都不会被缓存，"),n("code",[e._v("max")]),e._v("表示缓存组件的数量，因为我们是缓存的"),n("code",[e._v("vnode")]),e._v("对象，它也会持有 DOM，当我们缓存的组件很多的时候，会比较占用内存，所以该配置允许我们指定缓存组件的数量。")]),e._v(" "),n("h4",{attrs:{id:"_2-3-created"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-created","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.3 created")]),e._v(" "),n("p",[e._v("在"),n("code",[e._v("created")]),e._v("钩子函数里定义并初始化了两个属性："),n("code",[e._v("this.cache")]),e._v("和"),n("code",[e._v("this.keys")]),e._v("。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("created () {\n    this.cache = Object.create(null)\n    this.keys = []\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[n("code",[e._v("this.cache")]),e._v("是一个对象，用来存储需要缓存的组件，它将以如下形式存储：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("this.cache = {\n    'key1':'组件1',\n    'key2':'组件2',\n    // ...\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("p",[n("code",[e._v("this.keys")]),e._v("是一个数组，用来存储每个需要缓存的组件的"),n("code",[e._v("key")]),e._v("，即对应"),n("code",[e._v("this.cache")]),e._v("对象中的键值。")]),e._v(" "),n("h4",{attrs:{id:"_2-4-destroyed"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-destroyed","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.4 destroyed")]),e._v(" "),n("p",[e._v("当"),n("code",[e._v("<keep-alive>")]),e._v("组件被销毁时，此时会调用"),n("code",[e._v("destroyed")]),e._v("钩子函数，在该钩子函数里会遍历"),n("code",[e._v("this.cache")]),e._v("对象，然后将那些被缓存的并且当前没有处于被渲染状态的组件都销毁掉并将其从"),n("code",[e._v("this.cache")]),e._v("对象中剔除。如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("destroyed () {\n    for (const key in this.cache) {\n        pruneCacheEntry(this.cache, key, this.keys)\n    }\n}\n\n// pruneCacheEntry函数\nfunction pruneCacheEntry (cache,key,keys,current) {\n  const cached = cache[key]\n  /* 判断当前没有处于被渲染状态的组件，将其销毁*/\n  if (cached && (!current || cached.tag !== current.tag)) {\n    cached.componentInstance.$destroy()\n  }\n  cache[key] = null\n  remove(keys, key)\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br")])]),n("h4",{attrs:{id:"_2-5-mounted"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-mounted","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.5 mounted")]),e._v(" "),n("p",[e._v("在"),n("code",[e._v("mounted")]),e._v("钩子函数中观测"),n("code",[e._v("include")]),e._v("和"),n("code",[e._v("exclude")]),e._v("的变化，如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("this.$watch('include', val => {\n    pruneCache(this, name => matches(val, name))\n})\nthis.$watch('exclude', val => {\n    pruneCache(this, name => !matches(val, name))\n})\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("p",[e._v("如果"),n("code",[e._v("include")]),e._v("或"),n("code",[e._v("exclude")]),e._v("发生了变化，即表示定义需要缓存的组件的规则或者不需要缓存的组件的规则发生了变化，那么就执行"),n("code",[e._v("pruneCache")]),e._v("函数，函数如下：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("function pruneCache (keepAliveInstance, filter) {\n  const { cache, keys, _vnode } = keepAliveInstance\n  for (const key in cache) {\n    const cachedNode = cache[key]\n    if (cachedNode) {\n      const name = getComponentName(cachedNode.componentOptions)\n      if (name && !filter(name)) {\n        pruneCacheEntry(cache, key, keys, _vnode)\n      }\n    }\n  }\n}\n\nfunction pruneCacheEntry (cache,key,keys,current) {\n  const cached = cache[key]\n  if (cached && (!current || cached.tag !== current.tag)) {\n    cached.componentInstance.$destroy()\n  }\n  cache[key] = null\n  remove(keys, key)\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br")])]),n("p",[e._v("在该函数内对"),n("code",[e._v("this.cache")]),e._v("对象进行遍历，取出每一项的"),n("code",[e._v("name")]),e._v("值，用其与新的缓存规则进行匹配，如果匹配不上，则表示在新的缓存规则下该组件已经不需要被缓存，则调用"),n("code",[e._v("pruneCacheEntry")]),e._v("函数将这个已经不需要缓存的组件实例先销毁掉，然后再将其从"),n("code",[e._v("this.cache")]),e._v("对象中剔除。")]),e._v(" "),n("h4",{attrs:{id:"_2-6-render"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-6-render","aria-hidden":"true"}},[e._v("#")]),e._v(" 2.6 render")]),e._v(" "),n("p",[e._v("在"),n("code",[e._v("render")]),e._v("函数中首先获取第一个子组件节点的"),n("code",[e._v("vnode")]),e._v("：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const slot = this.$slots.default\nconst vnode: VNode = getFirstComponentChild(slot)\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br")])]),n("p",[e._v("由于我们也是在"),n("code",[e._v("<keep-alive>")]),e._v("标签内部写")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("/* 获取该组件节点的名称 */\nconst name = getComponentName(componentOptions)\n\n/* 优先获取组件的name字段，如果name不存在则获取组件的tag */\nfunction getComponentName (opts: ?VNodeComponentOptions): ?string {\n  return opts && (opts.Ctor.options.name || opts.tag)\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v("然后用组件名称跟"),n("code",[e._v("include")]),e._v("、"),n("code",[e._v("exclude")]),e._v(" 中的匹配规则去匹配：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const { include, exclude } = this\n/* 如果name与include规则不匹配或者与exclude规则匹配则表示不缓存，直接返回vnode */\nif (\n    (include && (!name || !matches(include, name))) ||\n    // excluded\n    (exclude && name && matches(exclude, name))\n) {\n    return vnode\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("p",[e._v("如果组件名称与"),n("code",[e._v("include")]),e._v("规则不匹配或者与"),n("code",[e._v("exclude")]),e._v("规则匹配，则表示不缓存该组件，直接返回这个组件的"),n("code",[e._v("vnode")]),e._v("，否则的话走下一步缓存：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const { cache, keys } = this\n/* 获取组件的key */\nconst key = vnode.key == null\n? componentOptions.Ctor.cid + (componentOptions.tag ? `::${componentOptions.tag}` : '')\n: vnode.key\n\n/* 如果命中缓存，则直接从缓存中拿 vnode 的组件实例 */\nif (cache[key]) {\n    vnode.componentInstance = cache[key].componentInstance\n    /* 调整该组件key的顺序，将其从原来的地方删掉并重新放在最后一个 */\n    remove(keys, key)\n    keys.push(key)\n}\n/* 如果没有命中缓存，则将其设置进缓存 */\nelse {\n    cache[key] = vnode\n    keys.push(key)\n    /* 如果配置了max并且缓存的长度超过了this.max，则从缓存中删除第一个 */\n    if (this.max && keys.length > parseInt(this.max)) {\n        pruneCacheEntry(cache, keys[0], keys, this._vnode)\n    }\n}\n/* 最后设置keepAlive标记位 */\nvnode.data.keepAlive = true\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br")])]),n("p",[e._v("首先获取组件的"),n("code",[e._v("key")]),e._v("值：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("const key = vnode.key == null?\ncomponentOptions.Ctor.cid + (componentOptions.tag ? `::${componentOptions.tag}` : '')\n: vnode.key\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br")])]),n("p",[e._v("拿到"),n("code",[e._v("key")]),e._v("值后去"),n("code",[e._v("this.cache")]),e._v("对象中去寻找是否有该值，如果有则表示该组件有缓存，即命中缓存：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("/* 如果命中缓存，则直接从缓存中拿 vnode 的组件实例 */\nif (cache[key]) {\n    vnode.componentInstance = cache[key].componentInstance\n    /* 调整该组件key的顺序，将其从原来的地方删掉并重新放在最后一个 */\n    remove(keys, key)\n    keys.push(key)\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("p",[e._v("直接从缓存中拿"),n("code",[e._v("vnode")]),e._v("的组件实例，此时重新调整该组件 key 的顺序，将其从原来的地方删掉并重新放在"),n("code",[e._v("this.keys")]),e._v("中最后一个。")]),e._v(" "),n("p",[e._v("如果"),n("code",[e._v("this.cache")]),e._v("对象中没有该"),n("code",[e._v("key")]),e._v("值：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("/* 如果没有命中缓存，则将其设置进缓存 */\nelse {\n    cache[key] = vnode\n    keys.push(key)\n    /* 如果配置了max并且缓存的长度超过了this.max，则从缓存中删除第一个 */\n    if (this.max && keys.length > parseInt(this.max)) {\n        pruneCacheEntry(cache, keys[0], keys, this._vnode)\n    }\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br")])]),n("p",[e._v("表明该组件还没有被缓存过，则以该组件的"),n("code",[e._v("key")]),e._v("为键，组件"),n("code",[e._v("vnode")]),e._v("为值，将其存入"),n("code",[e._v("this.cache")]),e._v("中，并且把"),n("code",[e._v("key")]),e._v("存入"),n("code",[e._v("this.keys")]),e._v("中，此时再判断"),n("code",[e._v("this.keys")]),e._v("中缓存组件的数量是否超过了设置的最大缓存数量"),n("code",[e._v("this.max")]),e._v("，如果超过了，则把第一个缓存组件删掉。")]),e._v(" "),n("h3",{attrs:{id:"三、缓存策略"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、缓存策略","aria-hidden":"true"}},[e._v("#")]),e._v(" 三、缓存策略")]),e._v(" "),n("p",[e._v("缓存在计算机网络上随处可见，例如：当我们首次访问一个网页时，打开很慢，但当我们再次打开这个网页时，打开就很快。")]),e._v(" "),n("p",[e._v("这就涉及缓存在浏览器上的应用：浏览器缓存。当我们打开一个网页时，例如 "),n("code",[e._v("https://www.baidu.com")]),e._v(" ，它会在发起真正的网络请求前，查询浏览器缓存，看是否有要请求的文件，如果有，浏览器将会拦截请求，返回缓存文件，并直接结束请求，不会再去服务器上下载。如果不存在，才会去服务器请求。")]),e._v(" "),n("p",[e._v("其实，浏览器中的缓存是一种在本地保存资源副本，它的大小是有限的，当我们请求数过多时，缓存空间会被用满，此时，继续进行网络请求就需要确定缓存中哪些数据被保留，哪些数据被移除，这就是浏览器缓存淘汰策略，最常见的淘汰策略有 FIFO（先进先出）、LFU（最少使用）、LRU（最近最少使用）。")]),e._v(" "),n("p",[e._v("LRU （ Least Recently Used ：最近最少使用 ）缓存淘汰策略，故名思义，就是根据数据的历史访问记录来进行淘汰数据，其核心思想是 如果数据最近被访问过，那么将来被访问的几率也更高 ，优先淘汰最近没有被访问到的数据。")]),e._v(" "),n("p",[e._v("画个图帮助我们理解：")]),e._v(" "),n("p",[n("img",{attrs:{src:"vue20.jpg",alt:"images"}})]),e._v(" "),n("h3",{attrs:{id:"参考资料"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考资料","aria-hidden":"true"}},[e._v("#")]),e._v(" 参考资料")]),e._v(" "),n("ul",[n("li",[n("a",{attrs:{href:"https://juejin.im/post/5e8b3085f265da47c15cb8bb",target:"_blank",rel:"noopener noreferrer"}},[e._v("前端进阶算法 3：从浏览器缓存淘汰策略和 Vue 的 keep-alive 学习 LRU 算法"),n("OutboundLink")],1)]),e._v(" "),n("li",[n("a",{attrs:{href:"https://juejin.im/post/5e859fe1e51d4546f27fe2bf",target:"_blank",rel:"noopener noreferrer"}},[e._v("keep-alive 的实现原理及 LRU 缓存策略"),n("OutboundLink")],1)])]),e._v(" "),n("h2",{attrs:{id:"联系作者"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#联系作者","aria-hidden":"true"}},[e._v("#")]),e._v(" 联系作者")]),e._v(" "),n("div",{attrs:{align:"center"}},[n("p",[e._v("\n        平凡世界，贵在坚持。\n    ")]),e._v(" "),n("img",{attrs:{src:e.$withBase("/about/contact.png")}})])])}),[],!1,null,null,null);s.default=t.exports}}]);