# 解析、抽象语法树（AST）+ 提升编译速度5个技巧

## 前言

本人平时学习及收集内容，欢迎参入一起讨论。

## 内容

- [概述](#一、概述)
- [编程语言原理](#二、编程语言原理)
- [AST 程序](#三、ast-程序)
- [JavaScript 解析](#四、javascript-解析)
- [预编译](#五、预编译)
- [提升编译速度一些建议](#六、提升编译速度一些建议)

### 一、概述

我们都知道运行一大段javascript代码性能会变得很糟糕。这段代码不仅需要通过网络传输，而且还需要解析、编译成字节码，最后执行。在之前的文章中我们讨论了JS引擎、运行时和调用堆栈等，以及主要由谷歌Chrome和NodeJS使用的V8引擎。它们在整个JavaScript执行过程中都发挥着至关重要的作用。这篇说的抽象语法树同样重要在这我们将了解大多数JavaScript引擎如何将文本解析为对机器有意义的内容，转换之后发生的事情以及做为Web开发者如何利用这一知识。

### 二、编程语言原理

那么，首先让我们回顾一下编程语言原理。不管你使用什么编程语言，你需要一些软件来处理源代码以便让计算机能够理解。该软件可以是解释器，也可以是编译器。无论你使用的是解释型语言（JavaScript、Python、Ruby）还是编译型语言（c#、Java、Rust），都有一个共同的部分将源代码作为纯文本解析为**抽象语法树**(abstract syntax tree，AST)的数据结构。

AST 不仅以结构化的方式显示源代码，而且在语义分析中扮演着重要角色。在语义分析中，编译器验证程序和语言元素的语法使用是否正确。之后，使用 AST 来生成实际的字节码或者机器码。

> 抽象语法树（abstract syntax tree 或者缩写为AST），或者语法(syntax tree)，是源代码的抽象语法结构的树状表现形式，这里特指编程语言的源代码。和抽象语法树相对的是具体语法树(concrete synctaxtree)，通常称作分析树(parse tree)。一般的，在源代码的翻译和编译过程中，语法分析器创建出分析树。一旦AST被创建出来，在后续的处理过程中，比如语义分析阶段，会添加一些信息。

### 三、AST 程序

AST不仅仅是用于语言解释器和编译器，在计算机世界中，它们还有多种应用。使用它们最常见的方法之一是进行静态代码分析。静态分析器不执行输入的代码，但是他们仍然需要理解代码的结构。

例如，你可能想要实现一个工具，该工具可以找到公共代码结构，以便你可以重构它们以减少重复。你可能会通过使用字符串比较来实现这一点，但这个会相当简单且有局限性。

当然，如果你对实现这样的工具感兴趣，你不需要编写自己的解析器。有许多与Ecmascript规范完全兼容的开源项目。Esprima 和 Acorn 即是黄金搭档，还有许多工具可以帮助解析器生成输出，即ASTs，ASTs被广泛用于代码转换。

例如，你可能希望实现一个将Python代码转换为JavaScript的转换器，基本思想是使用Python转换器生成AST，然后使用AST生成JavaScript代码。

你可能会觉得难以置信，事实是ASTs只是部分语言的不同表示法，在解析前，它被表示为遵循一些规则的文本，这些规则构成了一种语言。在解析之后，它被表示为一个树结构，其中包含与输入文本完全相同的信息。因此也可以进行反射解析然后回到文本。

### 四、JavaScript 解析

让我们看看 AST 是如何构建的。我们用一个简单的 JavaScript 函数作为例子:

```
function foo(x){
    if(x>10){
        var a = 2;
        return a*x;
    }
    return x+10;
}
```

解析器会产生如下的AST：

![](./img/ast01.png)

### 五、预编译

但为什么不能在服务器端完成所有这些工作呢？毕竟，最好这样做一次并将结果提供给客户端，而不强制各个客户端重复做该项事情。那么，目前正在讨论引擎是否应该提供一种执行预编译脚本的方法，这样就可以节省浏览器运行时间。

在本质上讲，该思路是拥有可以生成字节码的服务器端工具，这样只需要传输字节码并在客户端运行，之后会看到启动时间的一些主要差异。这可能听起来很诱人，但事情并非那么简单，还可能会产生相反的效果，因为它会更大，并且很可能需要签署代码并出于安全原因对其进行处理。例如，V8 团队正在努力解决重复解析问题，这样预编译有可能实际并没有多大的用处。

### 六、提升编译速度一些建议

- 检查依赖，减少不必要的依赖
- 分割代码为更小的块而不是一整陀的
- 尽可能推迟加载JavaScript，按需要加载或者动态加载。
- 使用开发者工具和DeviceTiming来检测性能瓶颈
- 用像Optimize.js的工具来帮助解析器选择立即散板或者懒解析以加快解析速度

## 参考资料

- [JavaScript 是如何工作的：解析、抽象语法树（AST）+ 提升编译速度5个技巧](https://github.com/qq449245884/xiaozhi/issues/14)

## 联系作者

<div align="center">
    <p>
        平凡世界，贵在坚持。
    </p>
    <img :src="$withBase('/about/contact.png')" />
</div>