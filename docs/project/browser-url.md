# 从 URL 输入到页面展现到底发生什么？

## 前言

打开浏览器从输入网址到网页呈现在大家面前，背后到底发生了什么？经历怎么样的一个过程？先给大家来张总体流程图，具体步骤请看下文分解！

![images](browser11.png)

总体来说分为以下几个过程:

- DNS 解析:将域名解析成 IP 地址
- TCP 连接：TCP 三次握手
- 发送 HTTP 请求
- 服务器处理请求并返回 HTTP 报文
- 浏览器解析渲染页面
- 断开连接：TCP 四次挥手

## 内容

- URL 到底是啥
- 域名解析（DNS）
- TCP 三次握手
- 发送 HTTP 请求
- 服务器处理请求并返回 HTTP 报文
- 浏览器解析渲染页面
- 断开连接

### 一、URL 到底是啥

URL（Uniform Resource Locator），统一资源定位符，用于定位互联网上资源，俗称网址。

比如 [http://www.w3school.com.cn/html/index.asp](http://www.w3school.com.cn/html/index.asp)，遵守以下的语法规则：

**scheme://host.domain:port/path/filename**

各部分解释如下：

- `scheme` - 定义因特网服务的类型。常见的协议有 http、https、ftp、file，其中最常见的类型是 http，而 https 则是进行加密的网络传输。
- `host` - 定义域主机（http 的默认主机是 www）
- `domain` - 定义因特网域名，比如 w3school.com.cn
- `port` - 定义主机上的端口号（http 的默认端口号是 80）
- `path` - 定义服务器上的路径（如果省略，则文档必须位于网站的根目录中）。
- `filename` - 定义文档/资源的名称

### 二、域名解析（DNS）

在浏览器输入网址后，首先要经过域名解析，因为浏览器并不能直接通过域名找到对应的服务器，而是要通过 IP 地址。

#### 2.1 IP 地址

IP 地址是指互联网协议地址，是 IP Address 的缩写，IP 地址是 IP 协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。IP 地址是一个 32 位的二进制数，比如`127.0.0.1`为本机 IP。

**域名就相当于 IP 地址乔装打扮的伪装者，带着一副面具。它的作用就是便于记忆沟通的一组服务器的地址。**用户通常使用主机名或域名来访问对方的计算机，而不是直接通过 IP 地址访问。**因为与 IP 地址的一组纯数字相比**

#### 2.2 什么是域名解析

DNS 协议提供通过域名查找 IP 地址，域逆向从 IP 地址反查域名的服务。**DNS 是一个网络服务器，我们的域名解析简单来说就是在 DNS 上记录一条信息记录。**

```
例如 baidu.com  220.114.23.56（服务器外网IP地址）80（服务器端口号）
```

#### 2.3 浏览器如何通过域名去查询 URL 对应的 IP 呢

- 浏览器缓存：浏览器会按照一定的频率缓存 DNS 记录。
- 操作系统缓存：如果浏览器缓存中找不到需要的 DNS 记录，那就去操作系统中找。
- 路由缓存：路由器也有 DNS 缓存。
- ISP 的 DNS 服务器：
- 根服务器：

![images](browser14.png)

#### 2.4 小结

**浏览器通过向 DNS 服务器发送域名，DNS 服务器查询到与域名相对应的 IP 地址**

![images](browser15.png)

### 三、TCP 三次握手

参考[TCP 与 UDP](https://km.xiaowuzi.info/cs/tcp.html)

### 四、发送 HTTP 请求

**TCP 三次结束后，开始发送 HTTP 请求报文。**

请求报文由请求行（request line）、请求头（header）、请求休息三个部分组成，如下图所示：

![images](browser13.png)

参考[http 详情](https://km.xiaowuzi.info/cs/http.html)

### 五、服务器处理请求并返回 HTTP 报文

#### 5.1 服务器

#### 5.2 MVC 后台处理阶段

### 六、浏览器解析渲染页面

浏览器拿到响应文本 HTML 后，接下来介绍下浏览器渲染机制

![images](browser12.png)

浏览器解析渲染页面分为以下五个步骤：

- 根据 HTML 解析出 DOM 树
- 根据 CSS 解析生成 CSS 规则树
- 结合 DOM 树和 CSS 规则树、生成渲染树
- 根据渲染树计算每一个节点的信息
- 根据计算好的信息绘制页面

#### 6.1 根据 HTML 解析 DOM 树

- 根据 HTML 的内容，将标签按照结构解析成为 DOM 树，DOM 树解析的过程是一个深度优先遍历。即赞构建当前节点的所有子节点，再构建下一个兄弟节点。
- 在读取 HTML 文档，构建 DOM 树的过程中，若遇到 script 标签，则 DOM 树的构建会暂停，直至脚本执行完毕。

#### 6.2 根据 CSS 解析生成 CSS 规则树

- 解析 CSS 规则树时 js 执行将暂停，直至 CSS 规则树就绪。
- 浏览器在 CSS 规则树生成之前不会进行渲染。

#### 6.3 结合 DOM 树和 CSS 规则树、生成渲染树

- DOM 树和 CSS 规则树全部准备好了以后，浏览器才会开始构建渲染树。
- 精简 CSS 并可以加快 CSS 规则树的构建，从而加快页面相应速度。

#### 6.4 根据渲染树计算每一个节点的信息（布局）

- 布局：通过渲染树中渲染的信息，计算出每一个渲染对象的做位置和尺寸。
- 回流：在布局完成后，发现了某个部分发生了变化影响了布局，那就需要倒回去重新渲染。

#### 6.5 根据计算好的信息绘制页面

- 绘制阶段，系统会遍历呈现树，并调用呈现器的“paint”方法，奖呈现器
- 重绘：某个元素的背影颜色，文字颜色等，不影响元素周围或内部布局的属性，将只会引起浏览器的重绘。
- 回流：某个元素的尺寸发生了变化，则需重计算渲染树，重新渲染。

### 七、断开连接

参考[TCP 与 UDP](https://km.xiaowuzi.info/cs/tcp.html)

### 参考资料

- [从 URL 输入到页面展现到底发生什么？](https://github.com/ljianshu/Blog/issues/24)
- [说一说从输入 URL 到页面呈现发生了什么？](https://juejin.im/post/5df5bcea6fb9a016091def69#heading-24)
- [04 | 导航流程：从输入 URL 到页面展示，这中间发生了什么？](https://time.geekbang.org/column/article/117637)
- 《网络是怎么连接的》

## 联系作者

<div align="center">
    <p>
        平凡世界，贵在坚持。
    </p>
    <img :src="$withBase('/about/contact.png')" />
</div>
