# 性能优化手段

## 前言

本人平时学习及收集内容，欢迎参入一起讨论。

## 内容

- 网页内容
- 服务器
- Cookie
- CSS
- JavaScript
- 图片
- 测试网页性能工具

### 一、网页内容

- 减少http请求次数
- 减少DNS查询次数
- 避免页面跳转
- 缓存Ajax
- 延迟加载
- 提前加载
- 减少DOM元素数量
- 根据域名划分内容
- 减少iframe数量
- 避免404

#### 1.1 减少http请求次数

80%的响应时间花在下载网页内容(images, stylesheets, javascripts, scripts, flash等)。减少请求次数是缩短响应时间的关键！可以通过简化页面设计来减少请求次数，但页面内容较多可以采用以下技巧。

- **捆绑文件：** 现在有很多现成的工具(webpack、gulp、rollup)帮我们将多个脚本文件捆绑成一个文件，将多个样式样式表文件捆绑成一个文件，以此来减少文件的下载次数。
- **CSS Sprites：** 就是把多个图片拼成一副图片，然后通过CSS来控制在什么地方具体显示这整张图片的什么位置。
- **Image Maps：** 也是将多幅图拼在一起，然后通过坐标来控制显示导航.
- **Inline images:** 通过编码的字符串将图片内嵌到网页文本中。这个有点不好，增加了css文件体质的大小

#### 1.2 减少DNS查询次数

`DNS`查询也消耗响应时间，如果我们的网页内容来自各个不同的domain(比如嵌入了开放广告，引用了外部图片或脚本)，那么客户端首次解析这些domain也需要消耗一定的时间。DNS查询结果缓存在本地系统和浏览器中一段时间，所以DNS查询一般是对首次访问响应速度有所影响。

#### 1.3 避免页面跳转

当客户端收到服务器的跳转回复时，客户端再次根据服务器回复中的location指定的地址再次发送请求，例如以下跳转回复。

```
HTTP/1.1 301 Moved Permanently
Location: http://example.com/newuri
Content-Type: text/html
```

当客户端遇到这种回复的时候，用户只能等待客户端再次发送请求，有的网站甚至会一直跳n次，跳到他想带你去的地方…当然在这个时候用户看不到任何页面内容，只有浏览器的进度条一直在刷新。

#### 1.4 缓存Ajax

Ajax可以帮助我们异步的下载网页内容，但是有些网页内容即使是异步的，用户还是在等待它的返回结果，例如ajax的返回是用户联系人的下拉列表。所以我们还是要注意尽量应用以下规则提高ajax的响应速度。

- 添加`Expires`或`Cache-Control`报文头使回复可以被客户端缓存
- 压缩回复内容
- 减少dns查询
- 精简javascript
- 避免跳转
- 配置Etags

#### 1.5 延迟加载

这里讨论延迟加载需要我们知道我们的网页最初加载需要的最小内容集是什么。剩下的内容就可以推到延迟加载的集合中。

Javascript是典型的可以延迟加载内容。一个比较激进的做法是开发网页时先确保网页在没有Javascript的时候也可以基本工作，然后通过延迟加载脚本来完成一些高级的功能。

#### 1.6 提前加载

与延迟加载目的相反，提前加载的是为了提前加载接下来网页中访问的资源，下面是提前加载的类型

- 无条件提前加载：当前网页加载完成后，马上去下载一些其他的内容
- 有条件加载：根据用户的输入推断需要加载的内容
- 有预期的的加载：这种情况一般发生在网页重新设计时，由于用户经常访问旧网页，本地对旧的网页内容缓存充分从而显得旧网页速度很快，而新的网页内容却没有缓存，设计者可以在旧网页的内容中预先加载一些新网页中可能用到的内容，这样新的网页就会生下来一些需要下载的资源。

#### 1.7 减少DOM元素数量

网页中元素过多对网页的加载和脚本的执行都是沉重的负担，500个元素和5000个元素在加载速度上会有很大差别。

#### 1.8 根据域名划分内容

浏览器一般对同一个域的下载连接数有所限制，按照域名划分下载内容可以浏览器增大并行下载连接，但是注意控制域名使用在2-4个之间，不然dns查询也是个问题。

一般网站规划会将静态资源放在类似于`static.example.com`，动态内容放在`www.example.com`上。这样做还有一个好处是可以在静态的域名上避免使用`cookie`。后面我们会在`cookie`的规则中提到。

#### 1.9 减少iframe数量

使用iframe要注意理解iframe的优缺点

**优点**

- 可以用来加载速度较慢的内容，例如广告。
- 安全沙箱保护。浏览器会对iframe中的内容进行安全控制。
- 脚本可以并行下载

**缺点**

- 即使iframe内容为空也消耗加载时间
- 会阻止页面加载
- 没有语义

#### 1.10 避免404

404我们都不陌生，代表服务器没有找到资源，我们要特别要注意404的情况不要在我们提供的网页资源上，客户端发送一个请求但是服务器却返回一个无用的结果，时间浪费掉了。

更糟糕的是我们网页中需要加载一个外部脚本，结果返回一个404，不仅阻塞了其他脚本下载，下载回来的内容(404)客户端还会将其当成Javascript去解析。

### 二、服务器

- 使用CDN
- 添加Expires 或Cache-Control报文头
- Gzip压缩传输文件
- 配置ETags
- 使用GET Ajax请求
- 避免空的图片src

#### 2.1 使用CDN

再次强调第一条黄金定律，减少网页内容的下载时间。提高下载速度还可以通过CDN(内容分发网络)来提升。CDN通过部署在不同地区的服务器来提高客户的下载速度。

#### 2.2 添加Expires 或Cache-Control报文头

- 对于静态内容添加`Expires`，将静态内容设为永不过期，或者很长时间以后。
- 对于动态内容应用合适的`Cache-Control`，让浏览器根据条件来发送请求。

#### 2.3 Gzip压缩传输文件

Gzip通常可以减少70%网页内容的大小，包括脚本、样式表、图片等文件。Gzip比deflate更高效，主流服务器都有相应的压缩支持模块。

#### 2.4 配置ETags

虽然标题叫配制ETags，但是这里你要根据具体情况进行一些判断。首先Etag简单来说是通过一个文件版本标识使得服务器可以轻松判断该请求的内容是否有所更新，如果没有就回复304 (not modified)，从而避免下载整个文件。

但是Etags的版本信息即使主流服务器未能很好地支持跨服务器的判断，比如你从一个服务器集群中一台得到Etags，然后发送到了另一台那么校验很有可能会失败。

#### 2.5 使用GET Ajax请求

浏览器在实现XMLHttpRequest POST的时候分成两步，先发header，然后发送数据。而GET却可以用一个TCP报文完成请求。另外GET从语义上来讲是去服务器取数据，而POST则是向服务器发送数据，所以我们使用Ajax请求数据的时候尽量通过GET来完成。

#### 2.6 避免空的图片src

空的图片src仍然会使浏览器发送请求到服务器，这样完全是浪费时间，而且浪费服务器的资源。尤其是你的网站每天被很多人访问的时候，这种空请求造成的伤害不容忽略。

### 三、Cookie

- 减少Cookie大小
- 页面内容使用无cookie域名

#### 3.1 减少Cookie大小

- 去除没有必要的cookie，如果网页不需要cookie就完全禁掉
- 将cookie的大小减到最小
- 注意cookie设置的domain级别，没有必要情况下不要影响到sub-domain
- 设置合适的过期时间，比较长的过期时间可以提高响应速度。

#### 3.2 页面内容使用无cookie域名

大多数网站的静态资源都没必要cookie，我们可以采用不同的domain来单独存放这些静态文件，这样做不仅可以减少cookie大小从而提高响应速度，还有一个好处是有些proxy拒绝缓存带有cookie的内容，如果能将这些静态资源cookie去除，那就可以得到这些proxy的缓存支持。

常见的划分domain的方式是将静态文件放在`static.example.com`，动态内容放在`www.example.com`。

也有一些网站需要在二级域名上应用cookie，所有的子域都会继承，这种情况下一般会再购买一个专门的域名来存放`cookie-free`的静态资源

### 四、CSS

- 将样式表置顶
- 避免CSS表达式
- 用代替@import
- 避免使用Filters

#### 4.1 将样式表置顶

#### 4.2 避免CSS表达式

#### 4.3 用代替@import

#### 4.4 避免使用Filters

### 五、JavaScript

- 将脚本置底
- 使用外部Javascirpt和CSS文件
- 精简Javascript和CSS
- 去除重复脚本
- 减少DOM访问
- 使用智能事件处理

### 六、图片

- 优化图像
- 优化CSS Sprite
- 不要在HTML中缩放图片
- 使用小且可缓存的favicon.ico

### 七、测试网页性能工具


### 参考资料

- [雅虎35条军规](https://developer.yahoo.com/performance/rules.html)
- [毫秒必争，前端网页性能最佳实践](http://www.cnblogs.com/developersupport/p/webpage-performance-best-practices.html)
- [7 天打造前端性能监控系统](http://fex.baidu.com/blog/2014/05/build-performance-monitor-in-7-days/)
- [Web前端优化最佳实践及工具集锦](https://www.csdn.net/article/2013-09-23/2817020-web-performance-optimization)

## 联系作者

<div align="center">
    <p>
        平凡世界，贵在坚持。
    </p>
    <img :src="$withBase('/about/contact.png')" />
</div>