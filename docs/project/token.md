# 彻底理解 cookie、session、token

## 前言

本人平时学习及收集内容，欢迎参入一起讨论。

## 内容

- 什么是认证
- 什么是授权
- 什么是凭证
- 什么是Cookie
- 什么是Session
- Cookie和Session的区别
- 什么是Token（令牌）
- Token和Session的区别
- 什么是JWT
- Token和JWT的区别
- 常见的前后端端鉴权方式
- 常见的加密算法
- 常见问题

### 一、什么是认证

- 通俗地讲就是**验证当前用户的身份**，证明“你是你自己”（比如：你每天上下班打卡，都需要通过指纹打卡，当你的指纹和系统里录入的指纹相匹配时，就打卡成功）
- 互联网中的认证：
    - 用户名密码登录
    - 邮箱发送登录链接
    - 手机号接收难码
    - 手机号接收验证码
    - 只要你能收到邮箱/验证码，就默认你是账号的主人

### 二、什么是授权

- 用户授予第三方应用访问该用户某些资源的权限
    - 你在安装手机应用的时候，
    - 你在访问微信小程序时，当登录时，小程序会询问是否允许授予权限（获取昵称、头像、地区、性别等个人信息）
- 实现授权的方式有：cookie、session、token、OAuth

### 三、什么是凭证

- **实现认证和授权的前提是需要一种媒介（证书）** 来标记访问者的身份

- 在战国时期，商鞅变法，发明了照身帖。照身帖由官府发放，是一块打磨光滑细密的竹板，上面刻有持有人的头像和籍贯信息。国人必须持有，如若没有就被认为是黑户，或者间谍之类的。
- 在现实生活中，每个人都会有一张专属的居民身份证，是用于证明持有人身份的一种法定证件。通过身份证，我们可以办理手机卡/银行卡/个人贷款/交通出行等等，这就是认证的凭证。
- 在互联网应用中，一般网站（如掘金）会有两种模式，游客模式和登录模式。游客模式下，可以正常浏览网站上面的文章，一旦想要点赞/收藏/分享文章，就需要登录或者注册账号。当用户登录成功后，服务器会给该用户使用的浏览器颁发一个令牌（token），这个令牌用来表明你的身份，每次浏览器发送请求时会带上这个令牌，就可以使用游客模式下无法使用的功能。

### 四、什么是Cookie

- **HTTP 是无状态的协议（对于事务处理没有记忆能力，每次客户端和服务端会话完成时，服务端不会保存任何会话信息）** ：每个请求都是完全独立的，服务端无法确认当前访问者的身份信息，无法分辨上一次的请求发送者和这一次的发送者是不是同一个人。所以服务器与浏览器为了进行会话跟踪（知道是谁在访问我），就必须主动的去维护一个状态，这个状态用于告知服务端前后两个请求是否来自同一浏览器。而这个状态需要通过 cookie 或者 session 去实现。
- **cookie 存储在客户端** ： cookie 是服务器发送到用户浏览器并保存在本地的一小块数据，它会在浏览器下次向同一服务器再发起请求时被携带并发送到服务器上。
- **cookie 是不可跨域的** ： 每个 cookie 都会绑定单一的域名，无法在别的域名下获取使用，**一级域名和二级域名之间是允许共享使用的（靠的是 domain）**。

#### 4.1 cookie 重要的属性

属性 | 说明
---|---
**name=value** | 键值对，设置 Cookie 的名称及相对应的值，都必须是字符串类型
                    - 如果值为 Unicode 字符，需要为字符编码。- 如果值为二进制数据，则需要使用 BASE64 编码。
**domain** | 指定 cookie 所属域名，默认是当前域名
**path** | **指定cookie在哪个路径（路由）下生效，默认是'/'**。如果设置为`/abc`，则只有`/abc`下的路由可以访问到该cookie，如：`/abc/read`。

**maxAge** | cookie失效的时间，单位秒。如果为整数，则该cookie在maxAge秒后失效。如果为负数，该cookie为临时cookie，关闭浏览器即失效，浏览吕也不会以任何形式保存该cookie。如果为0，表示删除该cookie。默认为-1。**比expires好用**。
**expires** | 过期时间，在设置的某个时间点后该cookie就会失效。一般浏览器的cookie都是默认储存的，当关闭浏览器结束这个会话的时候，这个cookie也就会被删除
**secure** | 该cookie是否仅被使用协议传输。安全协议有HTTPS，SSL等，在网络上输数据之前先将数据加密。默认为false。当secure值为true时，cookie在HTTP中是无效，在HTTPS中才有效。
**httpOnly** | **如果给某个cookie设置了httpOnly属性，则无法通过JS脚本读取到cookie的信息，但还是能通过Application中手动修改cookie，所以只是在一定程度上可以防止XSS攻击，不是绝对的安全**

### 五、什么是Session

- **session 是另一种记录服务器和客户端会话状态的机制**
- **session 是基于 cookie 实现的，session 存储在服务器端，sessionId 会被存储到客户端的cookie 中**
![images](token01.png)
- **session认证流程：**
    - 用户第一次请求服务器的时候，服务器根据用户提交的相关信息，创建对应的Session
    - 请求返回时将此Session的唯一标识信息SessionID返回给浏览器
    - 浏览器接收到服务器返回的SessionID信息后，会将些信息存入到Cookie中，同时Cookie记录此SessionID属于哪个域名

### 六、Cookie和Session的区别

- **安全性：** Session比Cookie安全，Session是存储在服务器端的，Cookie是存储在客户端的。
- **存取值的类型不同：** Cookie只支持存在字符串数据，
- **有效期不同：**
- **存储大小不同：**

### 七、什么是Token（令牌）

#### 7.1 Acess Token

- **访问资源接口（API）蝗所需要的资源凭证**
- **简单token的组成：** uid(用户唯一的身份标识)、time(当前时间的时间戳)、sign(签名，token的前几位以哈希算法压缩的一定长度的十六进制字符串)
- **特点：**
   - **服务端无状态化、可扩展性好**
   - **支持移动端设备**
   - 安全
   - 支持跨程序调用
- **token 的身份验证流程：**

![images](token02.png)

#### 7.2 Refresh Token

- 另外一种token——refresh token
- refresh token是专用于刷新

![images](token03.png)

### 八、Token和Session的区别

- Session是一种记录服务器和客户会话状态的机制

### 九、什么是JWT

#### 9.1 生成JW工具

#### 9.2 JWT的原理

![images](token04.png)

#### 9.3 JWT认证流程

#### 9.4 JWT的使用方式

### 十、Token和JWT的区别

**相同：**

- 都是访问资源的令牌
- 都可以记录用户的信息
- 都是使服务端无状态化
- 都是只有验证成功后，客户端才能访问服务端上受保护的资源

**不相同：**

- Token：服务端验证客户端发送过来的 Token 时，还需要查询数据库获取用户信息，然后验证 Token 是否有效。
- JWT： 将 Token 和 Payload 加密后存储于客户端，服务端只需要使用密钥解密进行校验（校验也是 JWT 自己实现的）即可，不需要查询或者减少查询数据库，因为 JWT 自包含了用户信息和加密的数据。

### 十一、常见的前后端端鉴权方式

### 十二、常见的加密算法

### 十三、常见问题

### 参考资料

- [彻底理解 cookie、session、token](https://mp.weixin.qq.com/s/1Kh18uyEJzM21mc2l5MMCg)
- [傻傻分不清之 Cookie、Session、Token、JWT](https://juejin.im/post/5e055d9ef265da33997a42cc)
- [jwt 实践应用以及特殊案例思考](https://mp.weixin.qq.com/s/uxeOKy6flWXJIn4D0iqGzw)

## 联系作者

<div align="center">
    <p>
        平凡世界，贵在坚持。
    </p>
    <img :src="$withBase('/about/contact.png')" />
</div>