# TCP 与 UDP

## 前言

本人平时学习及收集内容，欢迎参入一起讨论。

## 内容

- TCP
- UDP
- TCP 与 UDP 区别

### 一、TCP

#### 1.1 TCP 首部格式

![images](tcp-head.png)

- **序号 seq**：
- **确认号 ack**：
- **数据偏移**：
- **确认 ACK**：
- **同步 SYN**：
- **终止 FIN**：
- **窗口**：

#### 1.2 三次握手

![images](tcp-3.png)

**假设 A 为客户端，B 为服务器端。**

- 首先 B 处于 LISTEN（监听）状态，等待客户的连接请求。
- A 向 B 发送连接请求报文段，SYN=1，ACK=0，选择一个初始的序号 seq=x。
- B 收到连接请求报文段，如果同意建立连接，则向 A 发送连接确认报文段，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 seq=y。

#### 1.3 为什么 TCP 连接需要三次握手，两次不可以吗，为什么

**为了防止已失效的连接请求报文段突然又传送到了服务端，占用服务器资源。（假设主机 A 为客户端，主机 B 为服务器端）**

#### 1.4 四次挥手

![images](tcp-4.png)

#### 1.5 四次挥手的原因

客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

#### 1.6 如何保证可靠传输

- 应用数据被分割成 TCP 认为最适合发送的数据块。
- **超时重传**：当 TCP 发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。
- TCP 给发送的每个包进行编号，接收方对数据包进行排序，把有序数据传送给应用层。
- **检验和**：TCP 将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP 将丢弃这个报文段和不确认收到此报文段。
- TCP 的接收端会丢弃重复的数据。
- **流量控制**：
- **拥塞控制**：

#### 1.7 TCP 连接状态

- `CLOSED`：初始状态。
- `LISTEN`：服务器处于监听状态。
- `SYN_SEND`：
- `SYN_RECV`：
- `ESTABLISH`：
- `FIN_WAIT_1`：
- `CLOSE_WAIT`：
- `FIN_WAIT_2`：
- `LAST_ACK`：
- `TIME_WAIT`：

#### 1.8 TCP 滑动窗口

#### 1.9 TCP 流量控制

#### 1.10 TCP 拥塞处理

#### 1.11 如何区分流量控制和拥塞控制

### 二、UDP

用户数据报协议 UDP，是面向无连接的通讯协议，是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部），支持一对一、一对多、多对一和多对多的交互通信。UDP 通讯时不需要接收方确认，属于不可靠的传输，可能会出现丢包现象，实际应用中要求程序员编程验证。例如：视频传输、实时通信。

#### 2.1 UDP 首部格式

![images](net-udp.png)

首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和临时添加的。

### 三、TCP 与 UDP 区别

- UDP 是无连接的，即发送数据之前不需要建立连接。
- UDP 使用尽最大努力将会，即不保证可靠将会，同时也不使用拥塞控制。
- UDP 是面向报文的。UDP 没有拥塞控制，很适合多媒体通信的要求。
- UDP 支持一对一、一对多、多对一和多对多的交互通信。
- UDP 的首部开销小，只有 8 个字节。
- TCP 是面向连接的传输层协议。
- 每一条 TCP 连接只能有两个端点，每一条 TCP 连接只能是点对点的（一对一）。
- TCP 提供可靠交付的服务。
- TCP 提供全双工通信。
- TCP 是面向字节流。
- 首部最低 20 个字节。

### 参考资料

- [TCP/IP 详解学习笔记](https://www.cnblogs.com/zhehan54/p/6204767.html)
- [面试官，不要再问我三次握手和四次挥手](https://mp.weixin.qq.com/s/WI9045Sd7gRsE-WZ5x8tcA)
- [TCP 三次握手和四次挥手](https://mp.weixin.qq.com/s/rWkD5ktlJDxcNFJ-5NH1eQ)
- [面试官问:TCP 为啥要 3 次握手和 4 次挥手？握两次手不行吗？](https://mp.weixin.qq.com/s/KCEgz5FqQ44Vt3iUREJmaA)
- [面试官问我：一个 TCP 连接可以发多少个 HTTP 请求？竟答不上来](https://zhuanlan.zhihu.com/p/93586950)
- [动画：用动画给面试官解释 TCP 三次握手过程](https://mp.weixin.qq.com/s/HNrY1sMk14_ogqCZ8s_2sw)

## 联系作者

<div align="center">
    <p>
        平凡世界，贵在坚持。
    </p>
    <img :src="$withBase('/about/contact.png')" />
</div>
